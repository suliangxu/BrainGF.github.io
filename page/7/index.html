<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/7/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/7/">





  <title>Hexo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/15/随笔/最大间距(LeetCode164)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/15/随笔/最大间距(LeetCode164)/" itemprop="url">最大间距(LeeCode164)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-15T20:08:03+08:00">
                2019-12-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/随笔/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、题目描述"><a href="#一、题目描述" class="headerlink" title="一、题目描述"></a>一、题目描述</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">给定一个无序的数组，找出数组在排序之后，相邻元素之间最大的差值。</span><br><span class="line"></span><br><span class="line">如果数组元素个数小于 2，则返回 0。</span><br></pre></td></tr></table></figure>

<p><strong>示例1:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输入: [3,6,9,1]</span><br><span class="line">输出: 3</span><br><span class="line">解释: 排序后的数组是 [1,3,6,9], 其中相邻元素 (3,6) 和 (6,9) 之间都存在最大差值 3。</span><br></pre></td></tr></table></figure>

<p><strong>示例2:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输入: [10]</span><br><span class="line">输出: 0</span><br><span class="line">解释: 数组元素个数小于 2，因此返回 0。</span><br></pre></td></tr></table></figure>

<p><strong>说明：</strong></p>
<ul>
<li>你可以假设数组中所有元素都是非负整数，且数值在 32 位有符号整数范围内。</li>
<li>请尝试在线性时间复杂度和空间复杂度的条件下解决此问题。</li>
</ul>
<h3 id="二、思路分析"><a href="#二、思路分析" class="headerlink" title="二、思路分析"></a>二、思路分析</h3><ol>
<li><p>先求出无序数组中的最大值和最小值。</p>
</li>
<li><p>当每个数，都等距离分布时，此时将取得max gap的下限值。</p>
<p>$ span = ceiling[(B - A) / (N - 1)] $    </p>
<p>其中，B为最小值，A为最大值，N为元素个数， ceiling 为向上取整。</p>
</li>
<li><p>如果以此span作为一个桶的取值范围。 并将数分配进这些桶内。那么在同一个桶内的数，之间的有序gap，将不会超过span。</p>
</li>
<li><p>则桶内的数的，彼此之间就不用再求gap。只需要计算桶与桶之间的gap，并保留最大值。</p>
</li>
<li><p>而桶与桶之间的gap，则是后一桶的最小值，与 前一桶的最大值之间的差值。</p>
</li>
<li><p>故在分配时，只需要记住该桶内的最小值，和最大值。</p>
</li>
</ol>
<p><strong><em>注：</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">向上取整的原因：</span><br><span class="line">1、当所有数都等距分布时，</span><br><span class="line">    如[1, 4, 7, 10]；</span><br><span class="line">    span = (10-1)/(4-1) = 3			</span><br><span class="line">    这就是当前每个数的距离</span><br><span class="line">2、当数值不是等距分布时，且原始span除不尽时，</span><br><span class="line">    如：[1, 2, 4, 9]</span><br><span class="line">		span = (9-1)/(4-1) = 8/3</span><br><span class="line">		此时，若不做调整，C语言除法运算默认最终结果为 2 ，</span><br><span class="line">		这将导致  计算得到的间距小于 &lt;  实际间距</span><br><span class="line">		使得部分情况下多用了一个桶。</span><br><span class="line">		一般我们计算使用 n - 1 个桶，若不想上取整将会使用 n 个桶。</span><br></pre></td></tr></table></figure>

<h3 id="三、代码（-C-）"><a href="#三、代码（-C-）" class="headerlink" title="三、代码（  C  ）"></a>三、代码（  C  ）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN_VALUE 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_VALUE (pow(2, 31)-1)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">maximumGap</span><span class="params">(<span class="keyword">int</span>* num, <span class="keyword">int</span> numsSize)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (numsSize == <span class="number">0</span> || numsSize&lt;<span class="number">2</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> maxval = MIN_VALUE;</span><br><span class="line">	<span class="keyword">int</span> minval = MAX_VALUE;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; numsSize ; i++)&#123;</span><br><span class="line">		maxval = num[i]&gt;maxval?num[i]:maxval;</span><br><span class="line">		minval = num[i]&gt;minval?minval:num[i];</span><br><span class="line">	&#125; </span><br><span class="line">  </span><br><span class="line">	<span class="keyword">if</span> (minval == maxval) </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (numsSize == <span class="number">2</span>) </span><br><span class="line">    <span class="keyword">return</span> maxval - minval;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">int</span> box_len = (<span class="keyword">int</span>)<span class="built_in">ceil</span>((<span class="keyword">double</span>)(maxval-minval)/(numsSize<span class="number">-1</span>));</span><br><span class="line">	<span class="keyword">int</span> n = (maxval - minval)/box_len;</span><br><span class="line">	<span class="keyword">int</span> maxBuk[n+<span class="number">1</span>],minBuk[n+<span class="number">1</span>];</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n+<span class="number">1</span>;i++)&#123;</span><br><span class="line">		maxBuk[i] = MIN_VALUE;</span><br><span class="line">		minBuk[i] = MAX_VALUE;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; numsSize ; j ++)&#123;</span><br><span class="line">		<span class="keyword">int</span> temp = (num[j]-minval)/box_len;</span><br><span class="line">		maxBuk[temp] = num[j]&gt;maxBuk[temp]?num[j]:maxBuk[temp];</span><br><span class="line">		minBuk[temp] = num[j]&gt;minBuk[temp]?minBuk[temp]:num[j]; </span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">int</span> gap = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> pre = maxBuk[<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n ; i++)&#123;</span><br><span class="line">		<span class="keyword">if</span> (maxBuk[i]==MIN_VALUE &amp;&amp; minBuk[i]==MAX_VALUE)&#123;</span><br><span class="line">        	<span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		gap = gap&gt;minBuk[i]-pre?gap:minBuk[i]-pre;</span><br><span class="line">    pre = maxBuk[i];</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">return</span> gap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/06/随笔/动态规划的四步解题法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/06/随笔/动态规划的四步解题法/" itemprop="url">动态规划的四步阶梯法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-06T16:00:23+08:00">
                2019-11-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/随笔/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、什么是动态规划"><a href="#一、什么是动态规划" class="headerlink" title="一、什么是动态规划"></a>一、什么是动态规划</h3><p>如果你还没有听说过动态规划，或者仅仅只有耳闻，或许你可以看看 Quora 上面的这个 <em>回答</em>。</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/%E9%9A%8F%E7%AC%94/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92%E7%9A%84%E5%9B%9B%E6%AD%A5%E8%A7%A3%E9%A2%98%E6%B3%95/1.png" alt="How to explain dynamic"></p>
<p>用一句话解释动态规划就是 ==“<strong>记住你之前做过的事</strong>”==，如果更准确些，其实是 ==“<strong>记住你之前得到的答案</strong>”==。</p>
<p>我举个大家工作中经常遇到的例子。</p>
<p>在软件开发中，大家经常会遇到一些系统配置的问题，配置不对，系统就会报错，这个时候一般都会去 Google 或者是查阅相关的文档，花了一定的时间将配置修改好。</p>
<p>过了一段时间，去到另一个系统，遇到类似的问题，这个时候已经记不清之前修改过的配置文件长什么样，这个时候有两种方案，一种方案还是去 Google 或者查阅文档，另一种方案是借鉴之前修改过的配置，第一种做法其实是万金油，因为你遇到的任何问题其实都可以去 Google，去查阅相关文件找答案，但是这会花费一定的时间，相比之下，第二种方案肯定会更加地节约时间，但是这个方案是有条件的，条件如下：</p>
<ul>
<li>之前的问题和当前的问题有着关联性，换句话说，之前问题得到的答案可以帮助解决当前问题</li>
<li>需要记录之前问题的答案</li>
</ul>
<p>当然在这个例子中，可以看到的是，上面这两个条件均满足，大可去到之前配置过的文件中，将配置拷贝过来，然后做些细微的调整即可解决当前问题，节约了大量的时间。</p>
<p>不知道你是否从这些描述中发现，对于一个动态规划问题，我们只需要从两个方面考虑，那就是 ==<strong>找出问题之间的联系</strong>==，以及 ==<strong>记录答案</strong>==，这里的难点其实是找出问题之间的联系，记录答案只是顺带的事情，利用一些简单的数据结构就可以做到。</p>
<h3 id="二、思考动态规划问题的四个步骤"><a href="#二、思考动态规划问题的四个步骤" class="headerlink" title="二、思考动态规划问题的四个步骤"></a>二、思考动态规划问题的四个步骤</h3><p>一般解决动态规划问题，分为四个步骤，分别是</p>
<ul>
<li>问题拆解，找到问题之间的具体联系</li>
<li>状态定义</li>
<li>递推方程推导</li>
<li>实现</li>
</ul>
<p>这里面的重点其实是前两个，如果前两个步骤顺利完成，后面的递推方程推导和代码实现会变得非常简单。</p>
<p>这里还是拿 Quora 上面的例子来讲解，“$1+1+1+1+1+1+1+1$” 得出答案是 8，那么如何快速计算 “$1+ 1+1+1+1+1+1+1+1$”，我们首先可以对这个大的问题进行拆解，这里我说的大问题是 9 个 1 相加，这个问题可以拆解成 1 + “8 个 1 相加的答案”，8 个 1 相加继续拆，可以拆解成 1 + “7 个 1 相加的答案”，… 1 + “0 个 1 相加的答案”，到这里，==<strong>第一个步骤</strong>== 已经完成。</p>
<p><strong>==状态定义</strong>== 其实是需要思考在解决一个问题的时候我们做了什么事情，然后得出了什么样的答案，对于这个问题，当前问题的答案就是当前的状态，基于上面的问题拆解，你可以发现两个相邻的问题的联系其实是 ==$后一个问题的答案 = 前一个问题的答案 + 1$==，这里，状态的每次变化就是 +1。</p>
<p>定义好了状态，递推方程就变得非常简单，就是 ==$dp[i] = dp[i - 1] + 1$==，这里的 ==dp[i]== 记录的是当前问题的答案，也就是当前的状态，==dp[i - 1]== 记录的是之前相邻的问题的答案，也就是之前的状态，它们之间通过 +1 来实现状态的变更。</p>
<p>最后一步就是实现了，有了状态表示和递推方程，实现这一步上需要重点考虑的其实是初始化，就是用什么样的数据结构，根据问题的要求需要做那些初始值的设定。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dpExample</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dp[n + <span class="number">1</span>];  <span class="comment">// 多开一位用来存放 0 个 1 相加的结果</span></span><br><span class="line"></span><br><span class="line">    dp[<span class="number">0</span>] = <span class="number">0</span>;      <span class="comment">// 0 个 1 相加等于 0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        dp[i] = dp[i - <span class="number">1</span>] + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dp[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可以看到，动态规划这四个步骤其实是相互递进的，状态的定义离不开问题的拆解，递推方程的推导离不开状态的定义，最后的实现代码的核心其实就是递推方程，这中间如果有一个步骤卡壳了则会导致问题无法解决，当问题的复杂程度增加的时候，这里面的思维复杂程度会上升。</p>
<p>接下来我们再来看看 LeetCode 上面的几道题目，通过题目再来走一下这些个分析步骤。</p>
<h3 id="三、题目实战"><a href="#三、题目实战" class="headerlink" title="三、题目实战"></a>三、题目实战</h3><h4 id="1、爬楼梯"><a href="#1、爬楼梯" class="headerlink" title="1、爬楼梯"></a>1、爬楼梯</h4><p>但凡涉及到动态规划的题目都离不开一道例题：爬楼梯（LeetCode 第 70 号问题）。</p>
<h5 id="（1）题目描述"><a href="#（1）题目描述" class="headerlink" title="（1）题目描述"></a>（1）题目描述</h5><p>假设你正在爬楼梯。需要 <strong><em>n</em></strong> 阶你才能到达楼顶。</p>
<p>每次你可以爬 1 或 2 个台阶。你有多少种不同的方法可以爬到楼顶呢？</p>
<p>注意：给定 <strong><em>n</em></strong> 是一个正整数。</p>
<p><strong>示例 1：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">输入：2</span><br><span class="line">输出：2</span><br><span class="line">解释： 有两种方法可以爬到楼顶。</span><br><span class="line"></span><br><span class="line">1. 1 阶 + 1 阶</span><br><span class="line">2. 2 阶</span><br></pre></td></tr></table></figure>

<p><strong>示例 2：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">输入：3</span><br><span class="line">输出：3</span><br><span class="line">解释： 有三种方法可以爬到楼顶。</span><br><span class="line"></span><br><span class="line">1. 1 阶 + 1 阶 + 1 阶</span><br><span class="line">2. 1 阶 + 2 阶</span><br><span class="line">3. 2 阶 + 1 阶</span><br></pre></td></tr></table></figure>

<h5 id="（2）题目解析"><a href="#（2）题目解析" class="headerlink" title="（2）题目解析"></a>（2）题目解析</h5><p>爬楼梯，可以爬一步也可以爬两步，问有多少种不同的方式到达终点，我们按照上面提到的四个步骤进行分析：</p>
<ul>
<li><p><strong>问题拆解</strong>：</p>
<p>我们到达第 $n$ 个楼梯可以从第 $n - 1$ 个楼梯和第 $n - 2$ 个楼梯到达，因此第 $n$ 个问题可以拆解成第 $n - 1$ 个问题和第 $n - 2$ 个问题，第 $n - 1$ 个问题和第 $n - 2$ 个问题又可以继续往下拆，直到第 $0$ 个问题，也就是第 $0$ 个楼梯 (起点)</p>
</li>
<li><p><strong>状态定义</strong></p>
<p>“问题拆解” 中已经提到了，第 $n$ 个楼梯会和第 $n - 1$ 和第 $n - 2$ 个楼梯有关联，那么具体的联系是什么呢？你可以这样思考，第 $n - 1$ 个问题里面的答案其实是从起点到达第 $n - 1$ 个楼梯的路径总数，$n - 2$ 同理，从第 $n - 1$ 个楼梯可以到达第 $n$ 个楼梯，从第 $n - 2$ 也可以，并且路径没有重复，因此我们可以把第 i 个状态定义为 ==“<strong>从起点到达第 i 个楼梯的路径总数</strong>”==，状态之间的联系其实是相加的关系。</p>
</li>
<li><p><strong>递推方程</strong></p>
<p>“状态定义” 中我们已经定义好了状态，也知道第 i 个状态可以由第 $i - 1$ 个状态和第 $i - 2$ 个状态通过相加得到，因此递推方程就出来了 ==$dp[i] = dp[i - 1] + dp[i - 2]$==</p>
</li>
<li><p><strong>实现</strong></p>
<p>你其实可以从递推方程看到，我们需要有一个初始值来方便我们计算，起始位置不需要移动 ==$dp[0] = 0$==，第 1 层楼梯只能从起始位置到达，因此 ==$dp[1] = 1$==，第 2 层楼梯可以从起始位置和第 1 层楼梯到达，因此 ==$dp[2] = 2$==，有了这些初始值，后面就可以通过这几个初始值进行递推得到。</p>
</li>
</ul>
<h5 id="（3）参考代码"><a href="#（3）参考代码" class="headerlink" title="（3）参考代码"></a>（3）参考代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">climbStairs</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n + <span class="number">1</span>];  <span class="comment">// 多开一位，考虑起始位置</span></span><br><span class="line"></span><br><span class="line">    dp[<span class="number">0</span>] = <span class="number">0</span>; dp[<span class="number">1</span>] = <span class="number">1</span>; dp[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt;= n; ++i) &#123;</span><br><span class="line">        dp[i] = dp[i - <span class="number">1</span>] + dp[i - <span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dp[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、三角形最小路径和"><a href="#2、三角形最小路径和" class="headerlink" title="2、三角形最小路径和"></a>2、三角形最小路径和</h4><p>LeetCode 第 120 号问题：三角形最小路径和。</p>
<h5 id="（1）题目描述-1"><a href="#（1）题目描述-1" class="headerlink" title="（1）题目描述"></a>（1）题目描述</h5><p>给定一个三角形，找出自顶向下的最小路径和。每一步只能移动到下一行中相邻的结点上。</p>
<p>例如，给定三角形：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">     [2],</span><br><span class="line">    [3,4],</span><br><span class="line">   [6,5,7],</span><br><span class="line">  [4,1,8,3]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>自顶向下的最小路径和为 11（即，2 + 3 + 5 + 1 = 11）。</p>
<p><strong>说明：</strong></p>
<p>如果你可以只使用 O(n) 的额外空间（n 为三角形的总行数）来解决这个问题，那么你的算法会很加分。</p>
<h5 id="（2）题目解析-1"><a href="#（2）题目解析-1" class="headerlink" title="（2）题目解析"></a>（2）题目解析</h5><p>给定一个三角形数组，需要求出从上到下的最小路径和，也和之前一样，按照四个步骤来分析：</p>
<ul>
<li><p>问题拆解：</p>
<p>这里的总问题是求出最小的路径和，路径是这里的分析重点，路径是由一个个元素组成的，和之前爬楼梯那道题目类似，==$[i][j]$== 位置的元素，经过这个元素的路径肯定也会经过 ==$[ i - 1 ][ j ]$== 或者 ==$[i - 1][j - 1]$==，因此经过一个元素的路径和可以通过这个元素上面的一个或者两个元素的路径和得到。</p>
</li>
<li><p>状态定义</p>
<p>状态的定义一般会和问题需要求解的答案联系在一起，这里其实有两种方式，一种是考虑路径从上到下，另外一种是考虑路径从下到上，因为元素的值是不变的，所以路径的方向不同也不会影响最后求得的路径和，如果是从上到下，你会发现，在考虑下面元素的时候，起始元素的路径只会从==$[i - 1][j]$== 获得，每行当中的最后一个元素的路径只会从 ==$[i - 1][j - 1]$== 获得，中间二者都可，这样不太好实现，因此这里考虑从下到上的方式，状态的定义就变成了 ==“<strong>最后一行元素到当前元素的最小路径和</strong>”==，对于 ==$[0][0]$== 这个元素来说，最后状态表示的就是我们的最终答案。</p>
</li>
<li><p>递推方程</p>
<p>“状态定义” 中我们已经定义好了状态，递推方程就出来了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp[i][j] = Math.min(dp[i + 1][j], dp[i + 1][j + 1]) + triangle[i][j]</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现</p>
<p>这里初始化时，我们需要将最后一行的元素填入状态数组中，然后就是按照前面分析的策略，从下到上计算即可</p>
</li>
</ul>
<h5 id="（3）参考代码-1"><a href="#（3）参考代码-1" class="headerlink" title="（3）参考代码"></a>（3）参考代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minimumTotal</span><span class="params">(List&lt;List&lt;Integer&gt;&gt; triangle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = triangle.size();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n][n];</span><br><span class="line"></span><br><span class="line">    List&lt;Integer&gt; lastRow = triangle.get(n - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        dp[n - <span class="number">1</span>][i] = lastRow.get(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = n - <span class="number">2</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">        List&lt;Integer&gt; row = triangle.get(i);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i + <span class="number">1</span>; ++j) &#123;</span><br><span class="line">            dp[i][j] = Math.min(dp[i + <span class="number">1</span>][j], dp[i + <span class="number">1</span>][j + <span class="number">1</span>]) + row.get(j);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dp[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3、最大子序和"><a href="#3、最大子序和" class="headerlink" title="3、最大子序和"></a>3、最大子序和</h4><p>LeetCode 第 53 号问题：最大子序和。</p>
<h5 id="（1）题目描述-2"><a href="#（1）题目描述-2" class="headerlink" title="（1）题目描述"></a>（1）题目描述</h5><p>给定一个整数数组 <strong><em>nums</em></strong> ，找到一个具有最大和的连续子数组（子数组最少包含一个元素），返回其最大和。</p>
<p><strong>示例:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输入: [-2,1,-3,4,-1,2,1,-5,4],</span><br><span class="line">输出: 6</span><br><span class="line">解释: 连续子数组 [4,-1,2,1] 的和最大，为 6。</span><br></pre></td></tr></table></figure>

<p><strong>进阶:</strong></p>
<p>如果你已经实现复杂度为 O(n) 的解法，尝试使用更为精妙的分治法求解。</p>
<h5 id="（2）题目解析-2"><a href="#（2）题目解析-2" class="headerlink" title="（2）题目解析"></a>（2）题目解析</h5><p>求最大子数组和，非常经典的一道题目，这道题目有很多种不同的做法，而且很多算法思想都可以在这道题目上面体现出来，比如动态规划、贪心、分治，还有一些技巧性的东西，比如前缀和数组，这里还是使用动态规划的思想来解题，套路还是之前的四步骤：</p>
<ul>
<li><p>问题拆解：</p>
<p>问题的核心是子数组，子数组可以看作是一段区间，因此可以由起始点和终止点确定一个子数组，两个点中，我们先确定一个点，然后去找另一个点，比如说，如果我们确定一个子数组的截止元素在 i 这个位置，这个时候我们需要思考的问题是 “==<strong>以 i 结尾的所有子数组中，和最大的是多少？</strong>==”，然后我们去试着拆解，这里其实只有两种情况：</p>
<p>  i 这个位置的元素自成一个子数组;</p>
<p>  i 位置的元素的值 + <strong>==以 i - 1 结尾的所有子数组中的子数组和最大的值==</strong></p>
<p>你可以看到，我们把第 i 个问题拆成了第 i - 1 个问题，之间的联系也变得清晰</p>
</li>
<li><p>状态定义</p>
<p>通过上面的分析，其实状态已经有了，==$dp[i]$== 就是 “<strong>==以 i 结尾的所有子数组的最大值==</strong>”</p>
</li>
<li><p>递推方程</p>
<p>拆解问题的时候也提到了，有两种情况，即当前元素自成一个子数组，另外可以考虑前一个状态的答案，于是就有了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp[i] = Math.max(dp[i - 1] + array[i], array[i])</span><br></pre></td></tr></table></figure>

<p>化简一下就成了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp[i] = Math.max(dp[i - 1], 0) + array[i]</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现</p>
<p>题目要求子数组不能为空，因此一开始需要初始化，也就是 ==$dp[0] = array[0]$==，保证最后答案的可靠性，另外我们需要用一个变量记录最后的答案，因为子数组有可能以数组中任意一个元素结尾</p>
</li>
</ul>
<h5 id="（3）参考代码-2"><a href="#（3）参考代码-2" class="headerlink" title="（3）参考代码"></a>（3）参考代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(<span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nums == <span class="keyword">null</span> || nums.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> n = nums.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] dp = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line"></span><br><span class="line">    dp[<span class="number">0</span>] = nums[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> result = dp[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        dp[i] = Math.max(dp[i - <span class="number">1</span>], <span class="number">0</span>) + nums[i];</span><br><span class="line">        result = Math.max(result, dp[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h3><p>通过这几个简单的例子，相信你不难发现，解动态规划题目其实就是拆解问题，定义状态的过程，严格说来，动态规划并不是一个具体的算法，而是凌驾于算法之上的一种 ==<strong>思想</strong>==。</p>
<p>这种思想强调的是从局部最优解通过一定的策略推得全局最优解，从子问题的答案一步步推出整个问题的答案，并且利用空间换取时间。从很多算法之中你都可以看到动态规划的影子，所以，还是那句话 <strong>==技术都是相通的，找到背后的本质思想是关键==</strong>。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/06/人工智能/决策树/辨析ML中的熵有关的概念/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/06/人工智能/决策树/辨析ML中的熵有关的概念/" itemprop="url">辨析ML中的熵有关的概念</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-06T16:00:23+08:00">
                2019-11-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Machine-Learning-Decision-Tree/" itemprop="url" rel="index">
                    <span itemprop="name">Machine Learning - Decision Tree</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、信息熵（information-entropy）"><a href="#一、信息熵（information-entropy）" class="headerlink" title="一、信息熵（information entropy）"></a>一、信息熵（information entropy）</h2><p><strong>熵</strong>（entropy）这一词最初来源于热力学。1948年，<strong>香农</strong>将热力学中的熵引入信息论，所以也称<strong>香农熵</strong>（Shannon entropy），<strong>信息熵</strong>（information entropy）。</p>
<p>信息是一个很抽象的概念，百度百科将它定义为：指音讯、消息、通讯系统传输和处理的对象，泛指人类社会传播的一切内容。那么信息可以被量化么？可以的，香农提出的“信息熵”概念解决了这一问题。</p>
<p>一条信息的信息量大小和它的<strong>不确定性</strong>有直接的关系。我们需要搞清楚一件非常非常不确定的事，或者是我们一无所知的事，就需要了解大量的信息。相反，如果我们对某件事已经有了较多的了解，我们就不需要太多的信息就能把它搞清楚。所以，从这个角度，我们可以认为，<strong>信息的度量就等于不确定性的多少</strong>。比如，有人说广东下雪了。对于这句话，我们是十分不确定的。因为广东几十年来下雪的次数寥寥无几。为了搞清楚，我们就要去看天气预报，新闻，询问在广东的朋友，而这就需要大量的信息，信息熵很高。再比如，中国男足进军2022年卡塔尔世界杯决赛圈。对于这句话，因为确定性很高，几乎不需要引入信息，信息熵很低。</p>
<p>考虑一个<strong>离散的随机变量x</strong>，由上面的例子可知，信息的量度应该依赖于概率分布p(x)，因此我们想要找一个函数 l(x)，它是概率p(x)的单调函数，表达了信息的内容。怎么寻找呢？如果我们有两个不相关的事件x和y，那么观察两个事件同时发生时获得的信息量应该等于观察到事件各自发生时获得的信息之和，即 $l(x, y) = l(x) + l(y)$。</p>
<p>因为两个事件是独立不相关的，因此 $p(x, y) = p(x)p(y)$ 。根据这两个关系，很容易看出 l(x) 一定与 p(x) 的对数有关（因为对数的运算法则是 $log_{a}(mn) = log_{a}m + log_{a}n$ ）因此，我们有 $l(x) = -logp(x)$。<strong>其中负号是用来保证信息量为正数或零</strong>（因为p(x)总是在0到1之间）。<strong>而 log函数的基的选择是任意的</strong>（信息论中常选择为2，因此信息的单位为比特bits，而机器学习中常选自然对数，因此单位被称为奈特nats）。<strong>l(x) 也被称为随机变量 x 的自信息（self-information），描述的是随机变量的某个事件发生所带来的信息量。</strong>图像如图：</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/1.png" alt="img"></p>
<p>最后，我们正式引出<strong>信息熵</strong>。现在假设一个发送者想传送一个随机变量的值给接收者。那么在这个过程中，他们传输的<strong>平均信息量</strong>可以通过求 $l(x) = -logp(x)$ 关于概率分布 p(x) 的期望得到，即：</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/2.png" alt="img"></p>
<p>H(X) 就被称为随机变量 x的<strong>熵</strong>,<strong>它是表示随机变量不确定的度量，是对所有可能发生的事件产生的信息量的期望</strong>。从公式可得，<strong>随机变量的取值个数越多，状态数也就越多，信息熵就越大，混乱程度就越大。当随机分布为均匀分布时，熵最大</strong>，且 0≤H(X)≤logn。稍后证明。将一维随机变量分布推广到多维随机变量分布，则其<strong>联合熵</strong> (<strong>Joint entropy</strong>) 为：</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/3.png" alt="img"></p>
<p><em>（注意：熵只依赖于随机变量的分布,与随机变量取值无关，所以也可以将X的熵记作H(p)；令0log0=0(因为某个取值概率可能为0)）</em></p>
<p>那么这些定义有着什么样的性质呢？考虑一个随机变量 x。这个随机变量有4种可能的状态，每个状态都是等可能的。为了把 x 的值传给接收者，我们需要传输2比特的消息。H(X)=−4×(1/4)log2(1/4)=2 bits。现在考虑一个具有4种可能的状态 {a,b,c,d} 的随机变量，每个状态各自的概率为 (1/2,1/4,1/8,1/8)。这种情形下的熵为：</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/4.png" alt="img"></p>
<p>我们可以看到，<strong>非均匀分布比均匀分布的熵要小</strong>。现在让我们考虑如何把变量状态的类别传递给接收者。与之前一样，我们可以使用一个2比特的数字来完成这件事情。然而，我们可以利用非均匀分布这个特点，<strong>使用更短的编码来描述更可能的事件，使用更长的编码来描述不太可能的事件</strong>。我们希望这样做能够得到一个更短的平均编码长度。我们可以使用下面的编码串（哈夫曼编码）：0、10、110、111来表示状态 {a,b,c,d}。传输的编码的平均长度就是：</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/5.png" alt="img"></p>
<p>这个值与上方的随机变量的熵相等。熵和最短编码长度的这种关系是一种普遍的情形。Shannon 编码定理表明<strong>熵是传输一个随机变量状态值所需的比特位下界（最短平均编码长度）</strong>。因此，信息熵可以应用在数据压缩方面。可参考这篇文章讲的很详细了，我就不赘述了。<em>（<a href="http://www.ruanyifeng.com/blog/2014/09/information-entropy.html）" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2014/09/information-entropy.html）</a></em></p>
<h2 id="二、条件熵（Conditional-entropy）"><a href="#二、条件熵（Conditional-entropy）" class="headerlink" title="二、条件熵（Conditional entropy）"></a>二、条件熵（Conditional entropy）</h2><p>条件熵 H(Y|X)表示在已知随机变量 X 的条件下随机变量 Y 的不确定性。条件熵 H(Y|X)定义为 X 给定条件下 Y 的条件概率分布的熵对 X 的数学期望：</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/6.png" alt="img"></p>
<p>条件熵 H(Y|X)相当于联合熵 H(X,Y)减去单独的熵 H(X)，即H(Y|X)=H(X,Y)−H(X)，证明如下：</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/7.jpg" alt="img"></p>
<p>举个例子，比如环境温度是低还是高，和我穿短袖还是外套这两个事件可以组成联合概率分布 H(X,Y)，因为两个事件加起来的信息量肯定是大于单一事件的信息量的。假设 H(X)对应着今天环境温度的信息量，由于今天环境温度和今天我穿什么衣服这两个事件并不是独立分布的，所以在已知今天环境温度的情况下，我穿什么衣服的信息量或者说不确定性是被减少了。当已知 H(X) 这个信息量的时候，H(X,Y) 剩下的信息量就是条件熵：H(Y|X)=H(X,Y)−H(X)</p>
<p>因此，可以这样理解，描述 X 和 Y 所需的信息是描述 X 自己所需的信息,加上给定 X的条件下具体化 Y 所需的额外信息。关于条件熵的例子可以看这篇文章，讲得很详细。<em>（<a href="https://zhuanlan.zhihu.com/p/26551798）" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/26551798）</a></em></p>
<h2 id="三、相对熵（Relative-entropy）"><a href="#三、相对熵（Relative-entropy）" class="headerlink" title="三、相对熵（Relative entropy）"></a>三、相对熵（Relative entropy）</h2><p>相对熵，也称<strong>KL散度（Kullback-Leibler divergence）</strong></p>
<p>设 p(x)、q(x) 是 离散随机变量 X 中取值的两个概率分布，则 p 对 q 的相对熵是：</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/8.png" alt="img"></p>
<p>性质：</p>
<ul>
<li>如果 p(x) 和 q(x) 两个分布相同，那么相对熵等于0</li>
<li>DKL(p||q)≠DKL(q||p)，相对熵具有不对称性。大家可以举个简单例子算一下。</li>
<li>DKL(p||q)≥0证明如下：<em>(用Jensen不等式<a href="https://en.wikipedia.org/wiki/Jensen%27s_inequality" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Jensen%27s_inequality</a>)</em></li>
</ul>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/9.png" alt="img"></p>
<p>因为：</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/10.png" alt="img"></p>
<p>所以：</p>
<p>​                                                DKL(p||q)≥0</p>
<p><strong>总结</strong>：相对熵可以用来衡量两个概率分布之间的差异，上面公式的意义就是求 p 与 q 之间的对数差在 p 上的期望值。</p>
<h2 id="四、交叉熵（Cross-entropy）"><a href="#四、交叉熵（Cross-entropy）" class="headerlink" title="四、交叉熵（Cross entropy）"></a>四、交叉熵（Cross entropy）</h2><p>现在有关于样本集的两个概率分布 p(x) 和 q(x)，其中 p(x) 为真实分布， q(x)非真实分布。如果用真实分布 p(x) 来衡量识别一个样本所需要编码长度的期望（平均编码长度）为:</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/11.png" alt="img"></p>
<p>如果使用非真实分布 q(x) 来表示来自真实分布 p(x) 的平均编码长度，则是：</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/12.png" alt="img"></p>
<p>（因为用 q(x) 来编码的样本来自于分布 q(x) ，所以 H(p,q) 中的概率是 p(x)）。此时就将 H(p,q) 称之为交叉熵。举个例子。考虑一个随机变量 x，真实分布p(x)=(1/2,1/4,1/8,1/8)，非真实分布 q(x)=(1/4,1/4,1/4,1/4)， 则H(p)=1.75 bits（最短平均码长），交叉熵:</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/16.png" alt="img"></p>
<p>由此可以看出根据非真实分布 q(x) 得到的平均码长大于根据真实分布 p(x) 得到的平均码长。</p>
<p>我们再化简一下相对熵的公式。</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/13.png" alt="img"></p>
<p>有没有发现什么？</p>
<p>熵的公式：</p>
<p> <img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/14.png" alt="img">)</p>
<p>交叉熵的公式：</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/ML/%E5%86%B3%E7%AD%96%E6%A0%91/%E8%BE%A8%E6%9E%90ML%E4%B8%AD%E7%9A%84%E7%86%B5%E6%9C%89%E5%85%B3%E7%9A%84%E6%A6%82%E5%BF%B5/15.png" alt="img"></p>
<p>所以有：DKL(p||q)=H(p,q)−H(p)（当用非真实分布 q(x) 得到的平均码长比真实分布 p(x) 得到的平均码长多出的比特数就是相对熵）</p>
<p>又因为 DKL(p||q)≥0所以 H(p,q)≥H(p)（当 p(x)=q(x) 时取等号，此时交叉熵等于信息熵）并且当 H(p) 为<strong>常量</strong>时（<strong>注：在机器学习中，训练数据分布是固定的</strong>）<strong>最小化相对熵</strong> DKL(p||q) 等价于<strong>最小化交叉熵</strong> H(p,q) 也等价于<strong>最大化似然估计</strong>（具体参考<strong>Deep Learning 5.5</strong>）。在机器学习中，我们希望<strong>训练数据上模型学到的分布</strong> P(model) 和<strong>真实数据的分布</strong> <strong>P(real)</strong> <strong>越接近越好</strong>，<strong>所以我们可以使其相对熵最小</strong>。但是我们没有真实数据的分布，所以只能希望模型学到的分布 P(model) 和训练数据的分布 P(train) 尽量相同。假设训练数据是从总体中独立同分布采样的，那么我们可以通过最小化训练数据的经验误差来降低模型的泛化误差。即：</p>
<ul>
<li>希望学到的模型的分布和真实分布一致，P(model)≃P(real)</li>
<li>但是真实分布不可知，假设训练数据是从真实数据中独立同分布采样的P(train)≃P(real)</li>
<li>因此，我们希望学到的模型分布至少和训练数据的分布一致，P(train)≃P(model)</li>
</ul>
<p>根据之前的描述，最小化训练数据上的分布 P(train)与最小化模型分布 P(model) 的差异等价于最小化相对熵，即 DKL(P(train)||P(model))。此时， P(train)就是DKL(p||q) 中的 p，即真实分布，P(model)就是 q。又因训练数据的分布 p 是给定的，所以求 DKL(p||q) 等价求 H(p,q)。<strong>得证，交叉熵可以用来计算学习模型分布与训练分布之间的差异</strong>。交叉熵广泛用于逻辑回归的Sigmoid和Softmax函数中作为损失函数使用。这篇文章先不说了。</p>
<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><ul>
<li>信息熵是衡量随机变量分布的混乱程度，是随机分布各事件发生的信息量的期望值，随机变量的取值个数越多，状态数也就越多，信息熵就越大，混乱程度就越大。当随机分布为均匀分布时，熵最大；信息熵推广到多维领域，则可得到联合信息熵；条件熵表示的是在 X 给定条件下，Y 的条件概率分布的熵对 X的期望。</li>
<li>相对熵可以用来衡量两个概率分布之间的差异。</li>
<li>交叉熵可以来衡量在给定的真实分布下，使用非真实分布所指定的策略消除系统的不确定性所需要付出的努力的大小。</li>
</ul>
<p>或者：</p>
<ul>
<li>信息熵是传输一个随机变量状态值所需的比特位下界（最短平均编码长度）。</li>
<li>相对熵是指用 q 来表示分布 p  额外需要的编码长度。</li>
<li>交叉熵是指用分布 q 来表示本来表示分布 p 的平均编码长度。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/11/随笔/Mac处理matplotlib的中文显示问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/11/随笔/Mac处理matplotlib的中文显示问题/" itemprop="url">Mac处理matplotlib的中文显示问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-11T15:31:00+08:00">
                2019-08-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/随笔/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在mac中，想要处理matplotlib的中文显示问题，非常简单：</p>
<p>由于Mac系统自带有中文字库，Arial Unicode MS即为其中一种。不需要安装字库，不需要修改配置文件。</p>
<p>可直接将以下代码放置在文件中即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.rcParams[<span class="string">"font.family"</span>] = <span class="string">'Arial Unicode MS'</span></span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/10/Python Data Analysis/第三章：统计学与线性代数/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/10/Python Data Analysis/第三章：统计学与线性代数/" itemprop="url">第三章：统计学与线性代数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-10T22:01:58+08:00">
                2019-08-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python-Data-Analysis/" itemprop="url" rel="index">
                    <span itemprop="name">Python Data Analysis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="3-1-Numpy-和-Scipy-模块"><a href="#3-1-Numpy-和-Scipy-模块" class="headerlink" title="3.1    Numpy 和 Scipy 模块"></a>3.1    Numpy 和 Scipy 模块</h3><p>首先研究 Numpy 和 Scipy 的官方文档。</p>
<p>Numpy  英文文档：<a href="https://www.numpy.org/devdocs/user/index.html" target="_blank" rel="noopener">https://www.numpy.org/devdocs/user/index.html</a></p>
<p>Numpy  中文文档：<a href="https://www.numpy.org.cn/article/basics/index.html" target="_blank" rel="noopener">https://www.numpy.org.cn/article/basics/index.html</a></p>
<p>Scipy  英文文档：<a href="https://docs.scipy.org/doc/scipy/reference/" target="_blank" rel="noopener">https://docs.scipy.org/doc/scipy/reference/</a></p>
<h3 id="3-2-用NumPy进行简单的描述性统计计算"><a href="#3-2-用NumPy进行简单的描述性统计计算" class="headerlink" title="3.2    用NumPy进行简单的描述性统计计算"></a>3.2    用NumPy进行简单的描述性统计计算</h3><p>在本章中，我们将学习如何将 <strong>逗号分隔值（Comma-Separated Value, CSV ）</strong>文件载入NumPy数组，以进行数据分析。</p>
<p>若要加载数据，可以借助NumPy库的 <strong>loadtxt()</strong> 函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> scipy.stats <span class="keyword">import</span> scoreatpercentile</span><br><span class="line"></span><br><span class="line">data = np.loadtxt(<span class="string">'mdrtb_2012.csv'</span>, delimiter=<span class="string">','</span>, usecols=(<span class="number">1</span>, ),</span><br><span class="line">                   skiprows=<span class="number">1</span>, unpack=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># print(data)</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"Max method"</span>, data.max())</span><br><span class="line">print(<span class="string">"Max function"</span>, np.max(data))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Min method"</span>, data.min())</span><br><span class="line">print(<span class="string">"Min function"</span>, np.min(data))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Mean method"</span>, data.mean())</span><br><span class="line">print(<span class="string">"Mean function"</span>, np.mean(data))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Std method"</span>, data.std())</span><br><span class="line">print(<span class="string">"Std function"</span>, np.std(data))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Median"</span>, np.median(data))</span><br><span class="line">print(<span class="string">"Score at percentile 50"</span>, scoreatpercentile(data, <span class="number">50</span>))</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/suliangxu/MyHexoPicture/blob/master/python%20Data%20Analysis/第三章%20统计学与线性代数/mdrtb_2012.csv" target="_blank" rel="noopener">获取文件</a></p>
<p>这个文件中存放的是与结核病有关的数据，共有两列：国家栏和新病例百分比栏。</p>
<p>下面来计算NumPy数组的平均值、中位数、最大值、最小值以及标准差。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">numpy.loadtxt(fname, dtype=, comments=<span class="string">'#'</span>, delimiter=<span class="literal">None</span>, converters=<span class="literal">None</span>, skiprows=<span class="number">0</span>, usecols=<span class="literal">None</span>, unpack=<span class="literal">False</span>, ndmin=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fname：文件名</span><br><span class="line">dtype：默认为float</span><br><span class="line">comments=<span class="string">'#'</span>：如果行的开头为<span class="string">'#'</span>就会跳过该行</span><br><span class="line">delimiter：分隔，默认为空格</span><br><span class="line">converters=&#123;<span class="number">0</span>:add_one&#125;：这个是对数据进行预处理的参数, 我们可以先定义一个函数， 这里的converters是一个字典, 表示第零列使用函数add_one来进行预处理</span><br><span class="line">skiprows：指跳过前几行</span><br><span class="line">usecols=(<span class="number">0</span>,<span class="number">2</span>)：是指只使用<span class="number">0</span>,<span class="number">2</span>两列（元组类型）</span><br><span class="line">unpack=<span class="literal">True</span>：指会把每一列当成一个向量输出, 而不是合并在一起</span><br><span class="line">ndmin：数组的维度</span><br></pre></td></tr></table></figure>

<ol>
<li><p>首先调用下面的函数来加载数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data = np.loadtxt(<span class="string">'mdrtb_2012.csv'</span>, delimiter=<span class="string">','</span>, usecols=(<span class="number">1</span>, ),skiprows=<span class="number">1</span>, unpack=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>在上面的函数调用中，我们规定：用逗号作为分隔符，从第二列加载数据，并且忽略标题（header）。此外，我们还指定了文件名，并假设该文件位于当前目录下，否则就必须给出相应的路径。</p>
</li>
</ol>
<ol start="2">
<li><p>数组的最大值可通过 ndarray 的方法或者其他的NumPy函数来获得。另外最小值，平均值和标准差同样如此。面代码将会显示各种统计指标：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">"Max method"</span>, data.max())</span><br><span class="line">print(<span class="string">"Max function"</span>, np.max(data))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Min method"</span>, data.min())</span><br><span class="line">print(<span class="string">"Min function"</span>, np.min(data))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Mean method"</span>, data.mean())</span><br><span class="line">print(<span class="string">"Mean function"</span>, np.mean(data))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Std method"</span>, data.std())</span><br><span class="line">print(<span class="string">"Std function"</span>, np.std(data))</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>   输出结果如下所示：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Max method 50.0</span><br><span class="line">Max function 50.0</span><br><span class="line">Min method 0.0</span><br><span class="line">Min function 0.0</span><br><span class="line">Mean method 3.278703703703704</span><br><span class="line">Mean function 3.278703703703704</span><br><span class="line">Std method 5.763320736537964</span><br><span class="line">Std function 5.763320736537964</span><br></pre></td></tr></table></figure>



<ol start="3">
<li><p>中位数（median）可以用NumPy或者SciPy的函数得到。下列代码将计算数据第50百分位数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">"Median"</span>, np.median(data))</span><br><span class="line">print(<span class="string">"Score at percentile 50"</span>, scoreatpercentile(data, <span class="number">50</span>))</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>   以下是输出内容：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Median 1.8</span><br><span class="line">Score at percentile 50 1.8</span><br></pre></td></tr></table></figure>

<h3 id="3-3-用NumPy进行线性代数运算"><a href="#3-3-用NumPy进行线性代数运算" class="headerlink" title="3.3    用NumPy进行线性代数运算"></a>3.3    用NumPy进行线性代数运算</h3><p>线性代数是数学的一个重要分支，比如，我们可以使用线性代数来解决线性回归问题。</p>
<p>子程序包 <strong>numpy.linalg</strong> 提供了许多线性代数例程，我们可以用它来计算矩阵的逆、计算特征值、求解线性方程或计算行列式等。对于NumPy来说，矩阵可以用ndarray的一个子类来表示。</p>
<h4 id="3-3-1-用NumPy求矩阵的逆"><a href="#3-3-1-用NumPy求矩阵的逆" class="headerlink" title="3.3.1    用NumPy求矩阵的逆"></a>3.3.1    用NumPy求矩阵的逆</h4><p>子程序包 <strong>numpy.linalg</strong> 中的 <strong>inv()</strong> 函数就是用来求矩阵的逆的。</p>
<ol>
<li><p>创建一个示例矩阵</p>
<p>利用 <strong>mat()</strong> 函数创建</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">A = np.mat(<span class="string">"2 4 6;4 2 6;10 -4 18"</span>)</span><br><span class="line">print(<span class="string">"A\n"</span>, A)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">A</span></span><br><span class="line"><span class="string"> [[ 2  4  6]</span></span><br><span class="line"><span class="string"> [ 4  2  6]</span></span><br><span class="line"><span class="string"> [10 -4 18]]</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>求矩阵的逆</p>
<p>利用 <strong>inv()</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">inverse = np.linalg.inv(A)</span><br><span class="line">print(&quot;inverse of A\n&quot;, inverse)</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>   逆阵显示如下：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">inverse of A</span><br><span class="line"> [[-0.41666667  0.66666667 -0.08333333]</span><br><span class="line"> [ 0.08333333  0.16666667 -0.08333333]</span><br><span class="line"> [ 0.25       -0.33333333  0.08333333]]</span><br></pre></td></tr></table></figure>



   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">注：</span><br><span class="line">	如果该矩阵是奇异的，或者非方阵，那么就会得到 LinAlgError 消息。</span><br><span class="line">	NumPy 库中的 pinv() 函数可以用来求伪逆矩阵，它适用于任意矩阵，包括非方阵。</span><br></pre></td></tr></table></figure>



<ol start="3">
<li><p>利用乘法进行验算</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">"Check\n"</span>, A * inverse)</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>   结果，得到了一个单位矩阵（误差忽略不计）：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Check</span><br><span class="line"> [[ 1.00000000e+00  1.11022302e-16 -2.77555756e-17]</span><br><span class="line"> [-2.22044605e-16  1.00000000e+00 -2.77555756e-17]</span><br><span class="line"> [-8.88178420e-16  1.22124533e-15  1.00000000e+00]]</span><br></pre></td></tr></table></figure>



<p>   求逆差（减去$3\times 3$ 的单位矩阵）：</p>
   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">"Error\n"</span>, A * inverse - np.eye(<span class="number">3</span>))</span><br></pre></td></tr></table></figure>



<p>   结果：</p>
   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Error</span><br><span class="line"> [[<span class="number">-1.11022302e-16</span>  <span class="number">1.11022302e-16</span> <span class="number">-2.77555756e-17</span>]</span><br><span class="line"> [<span class="number">-2.22044605e-16</span>  <span class="number">4.44089210e-16</span> <span class="number">-2.77555756e-17</span>]</span><br><span class="line"> [<span class="number">-8.88178420e-16</span>  <span class="number">1.22124533e-15</span> <span class="number">-2.22044605e-16</span>]]</span><br></pre></td></tr></table></figure>

<p>整个代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">A = np.mat(<span class="string">"2 4 6;4 2 6;10 -4 18"</span>)</span><br><span class="line">print(<span class="string">"A\n"</span>, A)</span><br><span class="line"></span><br><span class="line">inverse = np.linalg.inv(A)</span><br><span class="line">print(<span class="string">"inverse of A\n"</span>, inverse)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Check\n"</span>, A * inverse)</span><br><span class="line">print(<span class="string">"Error\n"</span>, A * inverse - np.eye(<span class="number">3</span>))</span><br></pre></td></tr></table></figure>

<h4 id="3-3-2-用NumPy解线性方程组"><a href="#3-3-2-用NumPy解线性方程组" class="headerlink" title="3.3.2    用NumPy解线性方程组"></a>3.3.2    用NumPy解线性方程组</h4><p>​        矩阵可以通过线性方式把一个向量变换成另一个向量，因此从数值计算的角度看，这种操作对于一个线性方程组。</p>
<p>​         <strong>numpy.linalg</strong> 中的 <strong>solve()</strong> 子例程可以求解类似 $Ax = b$ 这种形式的线性方程组。其中 A 是一个矩阵，b 是一维或者二维数组，而 x 是未知量。</p>
<p>​        下面介绍如何使用 <strong>dot()</strong> 函数来计算两个浮点型数组的点积（dot product）。</p>
<ol>
<li><p>创建矩阵 A 和数组 b ：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">A = np.mat(<span class="string">"1 -2 1;0 2 -8;-4 5 9"</span>)</span><br><span class="line">print(<span class="string">"A\n"</span>, A)</span><br><span class="line"></span><br><span class="line">b = np.array([<span class="number">0</span>, <span class="number">8</span>, <span class="number">-9</span>])</span><br><span class="line">print(<span class="string">"b\n"</span>, b)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">A</span></span><br><span class="line"><span class="string"> [[ 1 -2  1]</span></span><br><span class="line"><span class="string"> [ 0  2 -8]</span></span><br><span class="line"><span class="string"> [-4  5  9]]</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">b</span></span><br><span class="line"><span class="string"> [ 0  8 -9]</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>调用 <strong>solve()</strong> 函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x = np.linalg.solve(A, b)</span><br><span class="line">print(<span class="string">"Solution"</span>, x)</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>   线性方程组的解：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Solution [29. 16.  3.]</span><br></pre></td></tr></table></figure>



<ol start="3">
<li><p>利用 <strong>dot()</strong> 函数进行验算</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">"Check\n"</span>, np.dot(A , x))</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>   结果不出所料：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Check</span><br><span class="line"> [[ 0.  8. -9.]]</span><br></pre></td></tr></table></figure>

<p>代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">A = np.mat(<span class="string">"1 -2 1;0 2 -8;-4 5 9"</span>)</span><br><span class="line">print(<span class="string">"A\n"</span>, A)</span><br><span class="line"></span><br><span class="line">b = np.array([<span class="number">0</span>, <span class="number">8</span>, <span class="number">-9</span>])</span><br><span class="line">print(<span class="string">"b\n"</span>, b)</span><br><span class="line"></span><br><span class="line">x = np.linalg.solve(A, b)</span><br><span class="line">print(<span class="string">"Solution"</span>, x)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Check\n"</span>, np.dot(A , x))</span><br></pre></td></tr></table></figure>

<h3 id="3-4-用NumPy计算特征值和特征向量"><a href="#3-4-用NumPy计算特征值和特征向量" class="headerlink" title="3.4    用NumPy计算特征值和特征向量"></a>3.4    用NumPy计算特征值和特征向量</h3><p>​        <strong>特征值</strong> 是方程式 $Ax = ax$ 的标量解（scalar solutions），其中 A 是一个二维矩阵，x 是一维向量。<strong>特征向量</strong> 实际上就是表示特征值的向量。</p>
<p>​        计算特征值时，可以求助于numpy.linalg 程序包提供的 <strong>eigvals()</strong> 子例程。函数 <strong>eig()</strong> 的返回值是一个元组，其元素为特征值和特征向量。</p>
<p>​        可以用子程序包 numpy.linalg 的 <strong>eigvals()</strong> 和 <strong>eig()</strong> 函数来获得矩阵的特征值和特征向量，并通过 <strong>dot()</strong> 函数来验算结果。</p>
<ol>
<li><p>创建矩阵</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">A = np.mat(<span class="string">"3 -2;1 0"</span>)</span><br><span class="line">print(<span class="string">"A\n"</span>, A)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">A</span></span><br><span class="line"><span class="string"> [[ 3 -2]</span></span><br><span class="line"><span class="string">  [ 1  0]]</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>利用 <strong>eig()</strong> 函数计算特征值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">"Eigenvalues"</span>, np.linalg.eigvals(A))</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>   结果：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Eigenvalues [2. 1.]</span><br></pre></td></tr></table></figure>



<ol start="3">
<li><p>利用 <strong>eig()</strong> 函数取得特征值和特征向量</p>
<p>​        利用 <strong>eig()</strong> 函数可以得到特征值和特征向量。</p>
<p>​        注意，该函数返回的是一个元组，其第一个元素是特征值，第二个元素为相应的 eigenvectors，其以面向列的方式排列。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eigenvalues, eigenvectors = np.linalg.eig(A)</span><br><span class="line">print(<span class="string">"First tuple of eig"</span>, eigenvalues)</span><br><span class="line">print(<span class="string">"Second tuple of eig\n"</span>, eigenvectors)</span><br></pre></td></tr></table></figure>

<p>​        </p>
<p>​        特征值 eigenvalues 和特征向量 eigenvectors 的值为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">First tuple of eig [2. 1.]</span><br><span class="line">Second tuple of eig</span><br><span class="line"> [[0.89442719 0.70710678]</span><br><span class="line"> [0.4472136  0.70710678]]</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="4">
<li><p>验算结果</p>
<p>通过 <strong>dot()</strong> 函数计算特征值方程式 $Ax = ax $ 两边的值，就可以对结果进行验算：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(eigenvalues)):</span><br><span class="line">      print(<span class="string">"Left"</span>, np.dot(A, eigenvectors[:,i]))</span><br><span class="line">      print(<span class="string">"Right"</span>, eigenvalues[i] * eigenvectors[:,i])</span><br><span class="line">      print(<span class="string">'\n'</span>)</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>   输出结果：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Left [[1.78885438]</span><br><span class="line"> [0.89442719]]</span><br><span class="line">Right [[1.78885438]</span><br><span class="line"> [0.89442719]]</span><br><span class="line"> </span><br><span class="line">Left [[0.70710678]</span><br><span class="line"> [0.70710678]]</span><br><span class="line">Right [[0.70710678]</span><br><span class="line"> [0.70710678]]</span><br></pre></td></tr></table></figure>

<p>代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">A = np.mat(<span class="string">"3 -2;1 0"</span>)</span><br><span class="line">print(<span class="string">"A\n"</span>, A)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Eigenvalues"</span>, np.linalg.eigvals(A) )</span><br><span class="line"></span><br><span class="line">eigenvalues, eigenvectors = np.linalg.eig(A)</span><br><span class="line">print(<span class="string">"First tuple of eig"</span>, eigenvalues)</span><br><span class="line">print(<span class="string">"Second tuple of eig\n"</span>, eigenvectors)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(eigenvalues)):</span><br><span class="line">      print(<span class="string">"Left"</span>, np.dot(A, eigenvectors[:,i]))</span><br><span class="line">      print(<span class="string">"Right"</span>, eigenvalues[i] * eigenvectors[:,i])</span><br><span class="line">      print(<span class="string">'\n'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-5-NumPy随机数"><a href="#3-5-NumPy随机数" class="headerlink" title="3.5    NumPy随机数"></a>3.5    NumPy随机数</h3><p>​        随机数常用于蒙特卡罗法、随机积分等方面。然而，真正的随机数很难获得，实际中使用的都是伪随机数。</p>
<p>​        大部分情况下，为随机数就足以满足我们的需求，当然某些特殊情况除外，如进行高精度的模拟实验时，对于NumPy与随机数有关的函数都在 ramdom 子程序包中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">提示：</span><br><span class="line">	NumPy核心的随机数发生器是基于梅森旋转算法的，详见 https://en.wikipedia.org/wiki/Mersenne_twister</span><br></pre></td></tr></table></figure>

<p>​        我们既可以生成连续分布的随机数，也可以生成非连续分布的随机数。</p>
<p>​        分布函数有一个可选的 size 参数，它能通知NumPy要创建多少个数字。我们可以用整型或者元组来给这个参数赋值，这时会得到相应形状的数字，其值由随机数填充。</p>
<p>​        离散分布包括几何分布、超几何分布和二项式分布，连续分布包括正态分布和对数正态分布。</p>
<h4 id="3-5-1-用二项式分布进行博弈"><a href="#3-5-1-用二项式分布进行博弈" class="headerlink" title="3.5.1    用二项式分布进行博弈"></a>3.5.1    用二项式分布进行博弈</h4><p>​        二项式分布模拟的是在进行整数次独立实验中成功的次数。其中每次实验的成功机会是一定的。</p>
<p>​        假如我们身在17世纪的赌场，正在对 8片币 玩法下注，当时流行用9枚硬币来玩，如果人头朝上的硬币少于5枚，那么我们将输掉一个8分币，否则我们就赢一个8分币。</p>
<p>​        下面，我们开始模拟这个游戏，假设我们手上有1000硬币作为初始赌资，我们将使用random模块提供的 <strong>binomial()</strong> 函数进行模拟:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">numpy.random.binomial(n,p,size=None)</span><br><span class="line"></span><br><span class="line">n表示n次的试验，p表示的试验成功的概率，n可是是一个float但是也会被变成整数来使用。</span><br><span class="line"></span><br><span class="line">参数的介绍：</span><br><span class="line"></span><br><span class="line">n：int型或者一个int型的数组，大于等于0，接受浮点数但是会被变成整数来使用。</span><br><span class="line"></span><br><span class="line">p：float或者一组float的数组，大于等于0且小于等于1.</span><br><span class="line"></span><br><span class="line">size：可选项，int或者int的元祖，表示的输出的大小，如果提供了size，例如(m,n,k)，那么会返回m*n*k个样本。如果size=None，也就是默认没有的情况，当n和p都是一个数字的时候只会返回一个值，否则返回的是np.broadcast(n,p).size个样本.</span><br><span class="line"></span><br><span class="line">其实size可直接理解为执行的次数。None为1次，size=0 返回数组，size=None 返回一个数。</span><br><span class="line"></span><br><span class="line">返回的是：一个数字或者一组数字</span><br></pre></td></tr></table></figure>

<p>代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> matplotlib.pyplot <span class="keyword">import</span> plot, show</span><br><span class="line"></span><br><span class="line">cash = np.zeros(<span class="number">10000</span>)</span><br><span class="line">cash[<span class="number">0</span>] = <span class="number">1000</span></span><br><span class="line">outcome = np.random.binomial(<span class="number">9</span>, <span class="number">0.5</span>, size=len(cash))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(cash)):</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> outcome[i] &lt; <span class="number">5</span>:</span><br><span class="line">      cash[i] = cash[i - <span class="number">1</span>] - <span class="number">1</span></span><br><span class="line">   <span class="keyword">elif</span> outcome[i] &lt; <span class="number">10</span>:</span><br><span class="line">      cash[i] = cash[i - <span class="number">1</span>] + <span class="number">1</span></span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">raise</span> AssertionError(<span class="string">"Unexpected outcome "</span> + outcome)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(outcome.min(), outcome.max())</span></span><br><span class="line"></span><br><span class="line">plot(np.arange(len(cash)), cash)</span><br><span class="line">show()</span><br></pre></td></tr></table></figure>

<ol>
<li><p>用 <strong>binomial()</strong> 函数</p>
<p>将数组初始化为0，即现金余额为0.调用 binomial() 函数，将size参数设为10000，这就表示我们要掷10000次硬币。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cash = np.zeros(<span class="number">10000</span>)</span><br><span class="line">cash[<span class="number">0</span>] = <span class="number">1000</span></span><br><span class="line">outcome = np.random.binomial(<span class="number">9</span>, <span class="number">0.5</span>, size=len(cash))</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>更新现金余额</p>
<p>利用抛掷硬币的结果来更新cash数组。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(cash)):</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> outcome[i] &lt; <span class="number">5</span>:</span><br><span class="line">      cash[i] = cash[i - <span class="number">1</span>] - <span class="number">1</span></span><br><span class="line">   <span class="keyword">elif</span> outcome[i] &lt; <span class="number">10</span>:</span><br><span class="line">      cash[i] = cash[i - <span class="number">1</span>] + <span class="number">1</span></span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">raise</span> AssertionError(<span class="string">"Unexpected outcome "</span> + outcome)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(outcome.min(), outcome.max())</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p>用matplotlib绘出cash数组的图像</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plot(np.arange(len(cash)), cash)</span><br><span class="line">show()</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/python%20Data%20Analysis/%E7%AC%AC%E4%B8%89%E7%AB%A0%20%E7%BB%9F%E8%AE%A1%E5%AD%A6%E4%B8%8E%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/1.png" alt="1"></p>
</li>
</ol>
<h4 id="3-5-2-正态分布采样"><a href="#3-5-2-正态分布采样" class="headerlink" title="3.5.2    正态分布采样"></a>3.5.2    正态分布采样</h4><p>​        连续分布是通过 <strong>概率密度函数</strong>（pdf）进行建模的，在特定区间发生某件事情的可能性，可以通过概率密度函数的积分运算求出。</p>
<p>​        NumPy的random模块提供了许多表示连续分布的函数。</p>
<p>​        利用NumPy的random子程序包中的 <strong>normal()</strong> 函数，可以把正态分布以直观的形式图示出来，下面给出随机产生的数值的钟形曲线和条形图。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">N = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line">normal_values = np.random.normal(size=N)</span><br><span class="line"></span><br><span class="line">dummy, bins, dummy = plt.hist(normal_values, int(np.sqrt(N)), density=<span class="literal">True</span>, lw=<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">sigma = <span class="number">1</span></span><br><span class="line">mu = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">plt.plot(bins, <span class="number">1</span>/(sigma * np.sqrt(<span class="number">2</span> * np.pi)) * np.exp(-(bins - mu)**<span class="number">2</span> / (<span class="number">2</span> * sigma**<span class="number">2</span>)), lw=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>随机数可以按照正态分布的要求生成。他们的分布情况可以用条形图来显示，若要绘制正态分布，请执行下列步骤。</p>
<ol>
<li><p>借助NumPy的 random子程序包提供的 <strong>normal()</strong> 函数，可以创建指定数量的随机数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">N = <span class="number">10000</span></span><br><span class="line">normal_values = np.random.normal(size=N)</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>画出条形图和理论上的pdf</p>
<p>下面使用matplotlib来绘制条形图和理论上的pdf，这里中心值为0，标准差为1</p>
<p>注：正态分布密度函数 $f(x) =  \frac{1}{ \sqrt{2 \pi }  \sigma }  \cdot e ^{ -\frac{(x- \mu ) ^{2} }{2 \sigma ^{2}} } $</p>
</li>
</ol>
   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dummy, bins, dummy = plt.hist(normal_values, int(np.sqrt(N)), density=<span class="literal">True</span>, lw=<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">sigma = <span class="number">1</span></span><br><span class="line">mu = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">plt.plot(bins, <span class="number">1</span>/(sigma * np.sqrt(<span class="number">2</span> * np.pi)) * np.exp(-(bins - mu)**<span class="number">2</span> / (<span class="number">2</span> * sigma**<span class="number">2</span>)), lw=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>下图展示了钟形曲线</li>
</ol>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/python%20Data%20Analysis/%E7%AC%AC%E4%B8%89%E7%AB%A0%20%E7%BB%9F%E8%AE%A1%E5%AD%A6%E4%B8%8E%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/2.png" alt="2"></p>
<h4 id="3-5-3-用SciPy进行正态检验"><a href="#3-5-3-用SciPy进行正态检验" class="headerlink" title="3.5.3    用SciPy进行正态检验"></a>3.5.3    用SciPy进行正态检验</h4><p>​        正态分布被广泛用于科学和统计学领域，按照中心极限定理，随着独立观测的随机样本数量的增加，他们会趋向呈正态分布，正态分布的特征已经为大家所熟知，并且它还非常便于使用。</p>
<p>​        不过，它需要满足许多必要条件，如数据点的数量要足够大，并且还要求这些数据点必须是相互独立的。工作中，我们需要养成检查数据是否符合正态分布的好习惯，正态检验的方法有很多，其中一些在 <strong>SciPy.stats</strong> 程序包中实现了。本节将用到的检验方法将用到这些检验方法，这里的样本是取自的流感趋势数据。</p>
<p>​        <a href="https://github.com/suliangxu/MyHexoPicture/blob/master/python%20Data%20Analysis/第三章%20统计学与线性代数/goog_flutrends.csv" target="_blank" rel="noopener">获取数据文件</a></p>
<p>​        和前面一样，这里也按照正态分布对这些数据进行抽样，得到的数组的大小与流感趋势数组相同，如果顺利通过正态检验，就以它为金标准（the golden standard）。</p>
<p>​        </p>
<p>代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> scipy.stats <span class="keyword">import</span> shapiro, anderson, normaltest</span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line"></span><br><span class="line">flutrends = np.loadtxt(<span class="string">"goog_flutrends.csv"</span>, delimiter=<span class="string">','</span>, usecols=(<span class="number">1</span>,),</span><br><span class="line">                       skiprows=<span class="number">1</span>, converters=&#123;<span class="number">1</span>: <span class="keyword">lambda</span> s: float(s <span class="keyword">or</span> <span class="number">0</span>)&#125;, unpack=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">N = len(flutrends)</span><br><span class="line"></span><br><span class="line">normal_values = np.random.normal(size=N)</span><br><span class="line">zero_values = np.zeros(N)</span><br><span class="line"></span><br><span class="line">warnings.filterwarnings(<span class="string">"ignore"</span>)</span><br><span class="line">print(<span class="string">"\nNormal Values Shapiro\n"</span>, shapiro(normal_values))</span><br><span class="line">print(<span class="string">"\nZeroes Shapiro\n"</span>, shapiro(zero_values))</span><br><span class="line">print(<span class="string">"\nFlu Shapiro\n"</span>, shapiro(flutrends))</span><br><span class="line">print(<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"\nNormal Values Anderson\n"</span>, anderson(normal_values))</span><br><span class="line">print(<span class="string">"\nZeroes Anderson\n"</span>, anderson(zero_values))</span><br><span class="line">print(<span class="string">"\nFlu Anderson\n"</span>, anderson(flutrends))</span><br><span class="line">print(<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"\nNormal Values normaltest\n"</span>, normaltest(normal_values))</span><br><span class="line">print(<span class="string">"\nZeroes normaltest\n"</span>, normaltest(zero_values))</span><br><span class="line">print(<span class="string">"\nFlu normaltest\n"</span>, normaltest(flutrends))</span><br></pre></td></tr></table></figure>

<p>​        作为一个反面例子，下面使用的这个数字跟前面提到的填满零的数组具有相同的大小。实际上当处理一些小概率事件时（如世界性疫情的爆发），就可能遇到这种数据。</p>
<p>​        在这个数据文件中，一些单元是空的。当然这种问题经常会碰到。所以必须习惯于首先清洗数据。我们假定正确的数字是0，下面使用一个转换器来填上这些0值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flutrends = np.loadtxt(<span class="string">"goog_flutrends.csv"</span>, delimiter=<span class="string">','</span>, usecols=(<span class="number">1</span>,),</span><br><span class="line">                       skiprows=<span class="number">1</span>, converters=&#123;<span class="number">1</span>: <span class="keyword">lambda</span> s: float(s <span class="keyword">or</span> <span class="number">0</span>)&#125;, unpack=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>​        夏皮罗·威尔克检验法可以对正态性进行检验。</p>
<p>​        相应的SciPy函数将返回一个元组。其中第一个元素是一个检验统计量，第二个数字是p值。需要注意的是，这种填满了零的数组会引发警告，事实上，本例中用到的3个函数在处理这个数组方面确实有困难，同时还会引发警告，下面是得到的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Normal Values Shapiro</span><br><span class="line"> (0.9961788058280945, 0.16325736045837402)</span><br><span class="line"> </span><br><span class="line">Zeroes Shapiro</span><br><span class="line"> (1.0, 1.0)</span><br><span class="line"> </span><br><span class="line">Flu Shapiro</span><br><span class="line"> (0.9351990818977356, 2.2945883254311397e-15)</span><br></pre></td></tr></table></figure>

<p>​        这种用零填充的数字看起来有点怪，虽然会收到相关的警告，但是大可忽略不计，这里得到的p值类似于本例中后面的第三个检验的结果，分析结果基本上是一样的。</p>
<p>​        Anderson-darling检验可以用来检验正态分布以及其他分布，如指数分布、对数分布和冈贝尓（Gumbel）分布的。相关的SciPy函数涉及一个检验统计量和一个数组。该数组存放了百分之15、10、5、2.5和1等显著性水平所对应的临界值。如果该统计量大于显著性水平的临界值，就可以断定它不具有正态性，我们将得到下列数值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Normal Values Anderson</span><br><span class="line"> AndersonResult(statistic=<span class="number">0.3476038369287835</span>, critical_values=array([<span class="number">0.572</span>, <span class="number">0.652</span>, <span class="number">0.782</span>, <span class="number">0.912</span>, <span class="number">1.085</span>]), significance_level=array([<span class="number">15.</span> , <span class="number">10.</span> ,  <span class="number">5.</span> ,  <span class="number">2.5</span>,  <span class="number">1.</span> ]))</span><br><span class="line"> </span><br><span class="line">Zeroes Anderson</span><br><span class="line"> AndersonResult(statistic=nan, critical_values=array([<span class="number">0.572</span>, <span class="number">0.652</span>, <span class="number">0.782</span>, <span class="number">0.912</span>, <span class="number">1.085</span>]), significance_level=array([<span class="number">15.</span> , <span class="number">10.</span> ,  <span class="number">5.</span> ,  <span class="number">2.5</span>,  <span class="number">1.</span> ]))</span><br><span class="line"> </span><br><span class="line">Flu Anderson</span><br><span class="line"> AndersonResult(statistic=<span class="number">8.258614154768793</span>, critical_values=array([<span class="number">0.572</span>, <span class="number">0.652</span>, <span class="number">0.782</span>, <span class="number">0.912</span>, <span class="number">1.085</span>]), significance_level=array([<span class="number">15.</span> , <span class="number">10.</span> ,  <span class="number">5.</span> ,  <span class="number">2.5</span>,  <span class="number">1.</span> ]))</span><br></pre></td></tr></table></figure>

<p>​        对于这种用零填充的数组，我们没有什么好说的，因为返回的统计量根本就不是一个数值。就像我们期望的那样，这个金标准数组是符合正态分布的。</p>
<p>​        然而，流感趋势数据返回的这个统计量大于所有的有关临界值。因此我们可以肯定他不符合正态分布，这3个测试函数中，这个看起来是最容易使用的一个。</p>
<p>​        SciPy的 <strong>normaltest()</strong> 函数还实现了 <strong>D’Agostino</strong>检验和 <strong>Person</strong> 检验功能。该函数返回的元组和 <strong>shpiro()</strong> 函数一样，也包括一个统计量和p值。这里p的值是双边卡方概率（two-sided Chi-squared probability）。卡方分布是另一种著名的分布。这种检验本身是基于偏度和峰度检验的 z 分数的。偏度系数用来表示分布的对称程度的。这样，由于正态分布是对称的，所以偏度系数为零。峰度系数描述的是分布的形状（尖峰，肥尾）。这种正态分布的峰度系数为3，超额峰度的系数为0，以下是本次检验获得的数值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Normal Values normaltest</span><br><span class="line"> NormaltestResult(statistic=<span class="number">5.654264837959543</span>, pvalue=<span class="number">0.059182320672633286</span>)</span><br><span class="line"> </span><br><span class="line">Zeroes normaltest</span><br><span class="line"> NormaltestResult(statistic=<span class="number">1698.434182313083</span>, pvalue=<span class="number">0.0</span>)</span><br><span class="line"> </span><br><span class="line">Flu normaltest</span><br><span class="line"> NormaltestResult(statistic=<span class="number">99.64373336356954</span>, pvalue=<span class="number">2.304826411536872e-22</span>)</span><br></pre></td></tr></table></figure>

<p>​        因为这里处理的是p值的概率，所以它越大越好，最好接近1。对于这种用零填充的数组，会得到很奇怪的结果。不过，由于我们已经得到提示，所以对于这个特殊数组来说，结果是不可信的。此外，如果p值大于等于0.5，则认为它具有正态性。对于金标准数组。我们会得到一个更小的数值，这说明我们需要进行更多的观察。</p>
<h3 id="3-6-创建掩码式NumPy数组"><a href="#3-6-创建掩码式NumPy数组" class="headerlink" title="3.6    创建掩码式NumPy数组"></a>3.6    创建掩码式NumPy数组</h3><p>​        数据常常是凌乱的，并且还有空白项或者无法处理的字符，<strong>好在掩码式数组数组可以忽略残缺的或无效的数据点</strong> 。numpy.ma 子程序包提供的掩码式数组隶属于ndarray，带有一个掩码。</p>
<p>​        本节以Lena相片为数据源，并假设某些数据已被破坏，下面是处理掩码式数组的完整代码：</p>
<p><a href="https://suliangxu.github.io/2019/08/11/随笔/Mac处理matplotlib的中文显示问题/" target="_blank" rel="noopener">Mac处理matplotlib的中文显示问题</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy</span><br><span class="line"><span class="keyword">import</span> scipy.misc</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.rcParams[<span class="string">"font.family"</span>] = <span class="string">'Arial Unicode MS'</span></span><br><span class="line"></span><br><span class="line">lena = scipy.misc.ascent()</span><br><span class="line">random_mask = numpy.random.randint(<span class="number">0</span>, <span class="number">2</span>, size=lena.shape)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">221</span>)</span><br><span class="line">plt.title(<span class="string">"原图"</span>)</span><br><span class="line">plt.imshow(lena)</span><br><span class="line">plt.axis(<span class="string">'off'</span>)</span><br><span class="line"></span><br><span class="line">masked_array = numpy.ma.array(lena, mask=random_mask)</span><br><span class="line"><span class="keyword">print</span> (masked_array)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">222</span>)</span><br><span class="line">plt.title(<span class="string">"掩码处理过的原图"</span>)</span><br><span class="line">plt.imshow(masked_array)</span><br><span class="line">plt.axis(<span class="string">'off'</span>)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">223</span>)</span><br><span class="line">plt.title(<span class="string">"对数图"</span>)</span><br><span class="line">plt.imshow(numpy.log(lena))</span><br><span class="line">plt.axis(<span class="string">'off'</span>)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">224</span>)</span><br><span class="line">plt.title(<span class="string">"掩码处理过的对数图"</span>)</span><br><span class="line">plt.imshow(numpy.log(masked_array))</span><br><span class="line">plt.axis(<span class="string">'off'</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<ol>
<li><p>创建一个掩码</p>
<p>为了得到一个掩码式数组，必须规定一个掩码。下面将生成一个随机掩码，这个掩码的取值非0即1.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">random_mask = numpy.random.randint(<span class="number">0</span>, <span class="number">2</span>, size=lena.shape)</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>创建一个掩码式数组</p>
<p>下面应用该掩码来创建一个掩码式数组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masked_array = numpy.ma.array(lena, mask=random_mask)</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p>得到如图：</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/python%20Data%20Analysis/%E7%AC%AC%E4%B8%89%E7%AB%A0%20%E7%BB%9F%E8%AE%A1%E5%AD%A6%E4%B8%8E%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/3.png" alt="3"></p>
</li>
</ol>
<p>我们给NumPy数组附加了一个随机掩码，这样，与该掩码相对应的数据就会被忽略不计。</p>
<h4 id="忽略负值和极值"><a href="#忽略负值和极值" class="headerlink" title="忽略负值和极值"></a>忽略负值和极值</h4><p>​        当希望忽略负值，如对数组的值取对数时，掩码式数组将会非常有用。此外，剔除异常值时，也会用到掩码式数组。这项工作是以极值的上下限为基础的。</p>
<p>​        下面举一个例子，美国职业棒球大联盟选手的薪资数据为例，来说明这些技术的应用方法。</p>
<p>​        <a href="https://github.com/suliangxu/MyHexoPicture/blob/master/python%20Data%20Analysis/第三章%20统计学与线性代数/MLB2008.csv" target="_blank" rel="noopener">获取数据文件</a></p>
<p>完整代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.rcParams[<span class="string">"font.family"</span>] = <span class="string">'Arial Unicode MS'</span></span><br><span class="line"></span><br><span class="line">salary = np.loadtxt(<span class="string">"MLB2008.csv"</span>, delimiter=<span class="string">','</span>, usecols=(<span class="number">1</span>,), skiprows=<span class="number">1</span>, unpack=<span class="literal">True</span>)</span><br><span class="line">triples = np.arange(<span class="number">0</span>, len(salary), <span class="number">3</span>)</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"Triples"</span>, triples[:<span class="number">10</span>], <span class="string">"..."</span>)</span><br><span class="line"></span><br><span class="line">signs = np.ones(len(salary))</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"Signs"</span>, signs[:<span class="number">10</span>], <span class="string">"..."</span>)</span><br><span class="line"></span><br><span class="line">signs[triples] = <span class="number">-1</span></span><br><span class="line"><span class="keyword">print</span> (<span class="string">"Signs"</span>, signs[:<span class="number">10</span>], <span class="string">"..."</span>)</span><br><span class="line"></span><br><span class="line">ma_log = np.ma.log(salary * signs)</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"Masked logs"</span>, ma_log[:<span class="number">10</span>], <span class="string">"..."</span>)</span><br><span class="line"></span><br><span class="line">dev = salary.std()</span><br><span class="line">avg = salary.mean()</span><br><span class="line">inside = np.ma.masked_outside(salary, avg - dev, avg + dev)</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"Inside"</span>, inside[:<span class="number">10</span>], <span class="string">"..."</span>)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">311</span>)</span><br><span class="line"><span class="comment"># plt.title("Original")</span></span><br><span class="line">plt.title(<span class="string">"原始薪资数据"</span>)</span><br><span class="line">plt.plot(salary)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">312</span>)</span><br><span class="line"><span class="comment"># plt.title("Log Masked")</span></span><br><span class="line">plt.title(<span class="string">"取对数后的数据"</span>)</span><br><span class="line">plt.plot(np.exp(ma_log))</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">313</span>)</span><br><span class="line"><span class="comment"># plt.title("Not Extreme")</span></span><br><span class="line">plt.title(<span class="string">"取幂复原后的数据"</span>)</span><br><span class="line">plt.plot(inside)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<ol>
<li><p>对负数取对数</p>
<ol>
<li><p>可以对含有负数的数组取对数。首先创建一个数组，存放可以被3整除的数字。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">triples = np.arange(<span class="number">0</span>, len(salary), <span class="number">3</span>)</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"Triples"</span>, triples[:<span class="number">10</span>], <span class="string">"..."</span>)</span><br></pre></td></tr></table></figure>



</li>
</ol>
</li>
</ol>
<ol start="2">
<li><p>然后生成一个元素值全为1且大小与薪金数据数组相等的数组：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">signs = np.ones(len(salary))</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"Signs"</span>, signs[:<span class="number">10</span>], <span class="string">"..."</span>)</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p>将下标是3的倍数的数组元素的值取反：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">signs[triples] = <span class="number">-1</span></span><br><span class="line"><span class="keyword">print</span> (<span class="string">"Signs"</span>, signs[:<span class="number">10</span>], <span class="string">"..."</span>)</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="4">
<li><p>对该数组取对数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ma_log = np.ma.log(salary * signs)</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"Masked logs"</span>, ma_log[:<span class="number">10</span>], <span class="string">"..."</span>)</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="5">
<li><p>得到的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Triples [ 0  3  6  9 12 15 18 21 24 27] ...</span><br><span class="line">Signs [1. 1. 1. 1. 1. 1. 1. 1. 1. 1.] ...</span><br><span class="line">Signs [-1.  1.  1. -1.  1.  1. -1.  1.  1. -1.] ...</span><br><span class="line">Masked logs [-- 14.970818190308929 15.830413578506539 -- 13.458835614025542</span><br><span class="line"> 15.319587954740548 -- 15.648092021712584 13.864300722133706 --] ...</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><p>忽略极值</p>
<ol>
<li><p>此处规定：所谓异常值，就是在平均值一个标准差以下，或者在平均值一个标准差以上的那些数值（这个定义未必恰当，只是为了便于计算）。</p>
<p>根据上面的定义，可以利用下面的代码来屏蔽极值点：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dev = salary.std()</span><br><span class="line">avg = salary.mean()</span><br><span class="line">inside = np.ma.masked_outside(salary, avg - dev, avg + dev)</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"Inside"</span>, inside[:<span class="number">10</span>], <span class="string">"..."</span>)</span><br></pre></td></tr></table></figure>



</li>
</ol>
</li>
</ol>
<ol start="2">
<li><p>下面代码将显示前十个元素：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Inside [3750000.0 3175000.0 7500000.0 3000000.0 700000.0 4500000.0 3000000.0</span><br><span class="line"> 6250000.0 1050000.0 4600000.0] ...</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="3">
<li><p>下面分别绘制原始数据，取对数后的数据和取幂复原后的数据，最后，是应用基于标准差的掩码之后的数据。</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/python%20Data%20Analysis/%E7%AC%AC%E4%B8%89%E7%AB%A0%20%E7%BB%9F%E8%AE%A1%E5%AD%A6%E4%B8%8E%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/4.png" alt="4"></p>
</li>
</ol>
<p>​        numpy.ma 子程序包中的函数可以屏蔽数组中被视为无效的元素，如无法运用 log() 和sqrt() 函数的负值元素。被屏蔽的值类似于关系数据库和程序设计中的 NULL 值。对被屏蔽的值进行运算时，给它的都是一个屏蔽后的值。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/10/随笔/python-字典、列表、字符串之间的转换/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/10/随笔/python-字典、列表、字符串之间的转换/" itemprop="url">python 字典、列表、字符串之间的转换</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-10T16:08:53+08:00">
                2019-08-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/随笔/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、列表与字符串转换"><a href="#一、列表与字符串转换" class="headerlink" title="一、列表与字符串转换"></a>一、列表与字符串转换</h3><h4 id="1、列表转字符串"><a href="#1、列表转字符串" class="headerlink" title="1、列表转字符串"></a>1、列表转字符串</h4><p>将列表中的内容拼接成一个字符串</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>l = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.join(l)</span><br><span class="line"><span class="string">'abc'</span></span><br></pre></td></tr></table></figure>

<p>将列表中的值转换成字符串</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>l = [<span class="string">'a'</span>, <span class="number">1</span>, <span class="string">'b'</span>, <span class="number">2</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[str(i) <span class="keyword">for</span> i <span class="keyword">in</span> l]</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'1'</span>, <span class="string">'b'</span>, <span class="string">'2'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="2、字符串转列表"><a href="#2、字符串转列表" class="headerlink" title="2、字符串转列表"></a>2、字符串转列表</h4><p>用eval转换</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = <span class="string">"['a', 'b', 'c']"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(s)</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br></pre></td></tr></table></figure>

<p>将字符串每个字符转成列表中的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = <span class="string">'abc'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(s)</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br></pre></td></tr></table></figure>

<p>将字符串按某方式分割成列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = <span class="string">'a,b,c'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.split(<span class="string">','</span>)</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br></pre></td></tr></table></figure>

<h3 id="二、列表与字典转换"><a href="#二、列表与字典转换" class="headerlink" title="二、列表与字典转换"></a>二、列表与字典转换</h3><h4 id="1、列表转字典"><a href="#1、列表转字典" class="headerlink" title="1、列表转字典"></a>1、列表转字典</h4><p>将两个列表转成字典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>l = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>t = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>zip(l, t)</span><br><span class="line">&lt;zip object at <span class="number">0x1033ff508</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dict(zip(l, t))</span><br><span class="line">&#123;<span class="string">'a'</span>: <span class="number">1</span>, <span class="string">'b'</span>: <span class="number">2</span>, <span class="string">'c'</span>: <span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure>

<p>将嵌套列表转为字典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>l = [[<span class="string">'a'</span>, <span class="number">1</span>], [<span class="string">'b'</span>, <span class="number">2</span>], [<span class="string">'c'</span>, <span class="number">3</span>]]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dict(l)</span><br><span class="line">&#123;<span class="string">'a'</span>: <span class="number">1</span>, <span class="string">'b'</span>: <span class="number">2</span>, <span class="string">'c'</span>: <span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、字典转列表"><a href="#2、字典转列表" class="headerlink" title="2、字典转列表"></a>2、字典转列表</h4><p>字典中键、值转为列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;<span class="string">'a'</span>:<span class="number">1</span>, <span class="string">'b'</span>:<span class="number">2</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(d.keys())</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(d.values())</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>]</span><br></pre></td></tr></table></figure>

<h3 id="三、字典与字符串转换"><a href="#三、字典与字符串转换" class="headerlink" title="三、字典与字符串转换"></a>三、字典与字符串转换</h3><h4 id="1、字符串转字典"><a href="#1、字符串转字典" class="headerlink" title="1、字符串转字典"></a>1、字符串转字典</h4><p>用eval转换</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = <span class="string">"&#123;'a':1, 'b':2&#125;"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(s)</span><br><span class="line">&#123;<span class="string">'a'</span>: <span class="number">1</span>, <span class="string">'b'</span>: <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure>

<p>用json.loads转换</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = <span class="string">'&#123;"a":1, "b":2&#125;'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> json</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>json.loads(s)</span><br><span class="line">&#123;<span class="string">'a'</span>: <span class="number">1</span>, <span class="string">'b'</span>: <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、字典转字符串"><a href="#2、字典转字符串" class="headerlink" title="2、字典转字符串"></a>2、字典转字符串</h4><p>用json.dumps转换</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;<span class="string">'a'</span>:<span class="number">1</span>, <span class="string">'b'</span>:<span class="number">2</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> json</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>json.dumps(d)</span><br><span class="line"><span class="string">'&#123;"a": 1, "b": 2&#125;'</span></span><br></pre></td></tr></table></figure>

<p>强转换</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;<span class="string">'a'</span>:<span class="number">1</span>, <span class="string">'b'</span>:<span class="number">2</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>str(d)</span><br><span class="line"><span class="string">"&#123;'a': 1, 'b': 2&#125;"</span></span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/09/python全栈/第02部分：并发编程+数据库+前端/并发编程/协程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/09/python全栈/第02部分：并发编程+数据库+前端/并发编程/协程/" itemprop="url">协程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-09T08:13:27+08:00">
                2019-08-09
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python全栈-02部分-并发编程/" itemprop="url" rel="index">
                    <span itemprop="name">python全栈 -02部分 -并发编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="（一）引子"><a href="#（一）引子" class="headerlink" title="（一）引子"></a>（一）引子</h2><p>​        之前我们学习了线程、进程的概念，了解了在操作系统中<strong>进程是资源分配的最小单位,线程是CPU调度的最小单位。</strong>按道理来说我们已经算是把cpu的利用率提高很多了。但是我们知道无论是创建多进程还是创建多线程来解决问题，都要消耗一定的时间来创建进程、创建线程、以及管理他们之间的切换。</p>
<p>　　随着我们对于效率的追求不断提高，<strong>基于单线程来实现并发</strong>又成为一个新的课题，即只用一个主线程（很明显可利用的cpu只有一个）情况下实现并发。这样就可以节省创建线进程所消耗的时间。</p>
<p>　　为此我们需要先回顾下并发的本质：切换+保存状态</p>
<p> 　　cpu正在运行一个任务，会在两种情况下切走去执行其他的任务（切换由操作系统强制控制），一种情况是该任务发生了阻塞，另外一种情况是该任务计算的时间过长</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/python%E5%85%A8%E6%A0%88/%E7%AC%AC02%E9%83%A8%E5%88%86%EF%BC%9A%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2B%E6%95%B0%E6%8D%AE%E5%BA%93%2B%E5%89%8D%E7%AB%AF/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/12.png" alt></p>
<p>​        ps：在介绍进程理论时，提及进程的三种执行状态，而线程才是执行单位，所以也可以将上图理解为线程的三种状态 </p>
<p>　　 一：其中第二种情况并不能提升效率，只是为了让cpu能够雨露均沾，实现看起来所有任务都被“同时”执行的效果，如果多个任务都是纯计算的，这种切换反而会降低效率。</p>
<p>　　为此我们可以基于yield来验证。yield本身就是一种在单线程下可以保存任务运行状态的方法，我们来简单复习一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1 yiled可以保存状态，yield的状态保存与操作系统的保存线程状态很像，但是yield是代码级别控制的，更轻量级</span></span><br><span class="line"><span class="comment">#2 send可以把一个函数的结果传给另外一个函数，以此实现单线程内程序之间的切换</span></span><br></pre></td></tr></table></figure>

<p>单纯地切换反而会降低运行效率:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#串行执行</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">(res)</span>:</span></span><br><span class="line">    <span class="string">'''任务1:接收数据,处理数据'''</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">producer</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''任务2:生产数据'''</span></span><br><span class="line">    res=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000000</span>):</span><br><span class="line">        res.append(i)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">start=time.time()</span><br><span class="line"><span class="comment">#串行执行</span></span><br><span class="line">res=producer()</span><br><span class="line">consumer(res) <span class="comment">#写成consumer(producer())会降低执行效率</span></span><br><span class="line">stop=time.time()</span><br><span class="line">print(stop-start) <span class="comment">#1.5536692142486572</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#基于yield并发执行</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''任务1:接收数据,处理数据'''</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        x=<span class="keyword">yield</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">producer</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''任务2:生产数据'''</span></span><br><span class="line">    g=consumer()</span><br><span class="line">    next(g)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000000</span>):</span><br><span class="line">        g.send(i)</span><br><span class="line"></span><br><span class="line">start=time.time()</span><br><span class="line"><span class="comment">#基于yield保存状态,实现两个任务直接来回切换,即并发的效果</span></span><br><span class="line"><span class="comment">#PS:如果每个任务中都加上打印,那么明显地看到两个任务的打印是你一次我一次,即并发执行的.</span></span><br><span class="line">producer()</span><br><span class="line"></span><br><span class="line">stop=time.time()</span><br><span class="line">print(stop-start) <span class="comment">#2.0272178649902344</span></span><br></pre></td></tr></table></figure>

<p>​        二：第一种情况的切换。在任务一遇到io情况下，切到任务二去执行，这样就可以利用任务一阻塞的时间完成任务二的计算，效率的提升就在于此。</p>
<p>yield无法做到遇到io阻塞:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''任务1:接收数据,处理数据'''</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        x=<span class="keyword">yield</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">producer</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''任务2:生产数据'''</span></span><br><span class="line">    g=consumer()</span><br><span class="line">    next(g)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000000</span>):</span><br><span class="line">        g.send(i)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">start=time.time()</span><br><span class="line">producer() <span class="comment">#并发执行,但是任务producer遇到io就会阻塞住,并不会切到该线程内的其他任务去执行</span></span><br><span class="line"></span><br><span class="line">stop=time.time()</span><br><span class="line">print(stop-start)</span><br></pre></td></tr></table></figure>

<p>​        <strong>对于单线程下，我们不可避免程序中出现io操作，但如果我们能在自己的程序中（即用户程序级别，而非操作系统级别）控制单线程下的多个任务能在一个任务遇到io阻塞时就切换到另外一个任务去计算，这样就保证了该线程能够最大限度地处于就绪态，即随时都可以被cpu执行的状态，相当于我们在用户程序级别将自己的io操作最大限度地隐藏起来，从而可以迷惑操作系统，让其看到：该线程好像是一直在计算，io比较少，从而更多的将cpu的执行权限分配给我们的线程。</strong></p>
<p>​        协程的本质就是在单线程下，由用户自己控制一个任务遇到io阻塞了就切换另外一个任务去执行，以此来提升效率。为了实现它，我们需要找寻一种可以同时满足以下条件的解决方案：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1. 可以控制多个任务之间的切换，切换之前将任务的状态保存下来，以便重新运行时，可以基于暂停的位置继续执行。</span></span><br><span class="line"><span class="comment">#2. 作为1的补充：可以检测io操作，在遇到io操作的情况下才发生切换</span></span><br></pre></td></tr></table></figure>

<h2 id="（二）协程介绍"><a href="#（二）协程介绍" class="headerlink" title="（二）协程介绍"></a>（二）协程介绍</h2><p>协程：是单线程下的并发，又称微线程，纤程。英文名Coroutine。一句话说明什么是协程：<strong>协程是一种用户态的轻量级线程，即协程是由用户程序自己控制调度的。、</strong></p>
<p>需要强调的是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1. python的线程属于内核级别的，即由操作系统控制调度（如单线程遇到io或执行时间过长就会被迫交出cpu执行权限，切换其他线程运行）</span></span><br><span class="line"><span class="comment">#2. 单线程内开启协程，一旦遇到io，就会从应用程序级别（而非操作系统）控制切换，以此来提升效率（！！！非io操作的切换与效率无关</span></span><br></pre></td></tr></table></figure>

<p>对比操作系统控制线程的切换，用户在单线程内控制协程的切换</p>
<p>优点如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1. 协程的切换开销更小，属于程序级别的切换，操作系统完全感知不到，因而更加轻量级</span></span><br><span class="line"><span class="comment">#2. 单线程内就可以实现并发的效果，最大限度地利用cpu</span></span><br></pre></td></tr></table></figure>

<p>缺点如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1. 协程的本质是单线程下，无法利用多核，可以是一个程序开启多个进程，每个进程内开启多个线程，每个线程内开启协程</span></span><br><span class="line"><span class="comment">#2. 协程指的是单个线程，因而一旦协程出现阻塞，将会阻塞整个线程</span></span><br></pre></td></tr></table></figure>

<p>总结协程特点：</p>
<ol>
<li><strong>必须在只有一个单线程里实现并发</strong></li>
<li><strong>修改共享数据不需加锁</strong></li>
<li><strong>用户程序里自己保存多个控制流的上下文栈</strong></li>
<li><strong>附加：一个协程遇到IO操作自动切换到其它协程（如何实现检测IO，yield、greenlet都无法实现，就用到了gevent模块（select机制））</strong></li>
</ol>
<h2 id="（三）Greenlet模块"><a href="#（三）Greenlet模块" class="headerlink" title="（三）Greenlet模块"></a>（三）Greenlet模块</h2><p>安装 ：pip3 install greenlet</p>
<p>greenlet实现状态切换:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> greenlet <span class="keyword">import</span> greenlet</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">'%s eat 1'</span> %name)</span><br><span class="line">    g2.switch(<span class="string">'egon'</span>)</span><br><span class="line">    print(<span class="string">'%s eat 2'</span> %name)</span><br><span class="line">    g2.switch()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">play</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">'%s play 1'</span> %name)</span><br><span class="line">    g1.switch()</span><br><span class="line">    print(<span class="string">'%s play 2'</span> %name)</span><br><span class="line"></span><br><span class="line">g1=greenlet(eat)</span><br><span class="line">g2=greenlet(play)</span><br><span class="line"></span><br><span class="line">g1.switch(<span class="string">'egon'</span>)<span class="comment">#可以在第一次switch时传入参数，以后都不需要</span></span><br></pre></td></tr></table></figure>

<p>单纯的切换（在没有io的情况下或者没有重复开辟内存空间的操作），反而会降低程序的执行速度</p>
<p>效率对比:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#顺序执行</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f1</span><span class="params">()</span>:</span></span><br><span class="line">    res=<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000000</span>):</span><br><span class="line">        res+=i</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f2</span><span class="params">()</span>:</span></span><br><span class="line">    res=<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000000</span>):</span><br><span class="line">        res*=i</span><br><span class="line"></span><br><span class="line">start=time.time()</span><br><span class="line">f1()</span><br><span class="line">f2()</span><br><span class="line">stop=time.time()</span><br><span class="line">print(<span class="string">'run time is %s'</span> %(stop-start)) <span class="comment">#10.985628366470337</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#切换</span></span><br><span class="line"><span class="keyword">from</span> greenlet <span class="keyword">import</span> greenlet</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f1</span><span class="params">()</span>:</span></span><br><span class="line">    res=<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000000</span>):</span><br><span class="line">        res+=i</span><br><span class="line">        g2.switch()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f2</span><span class="params">()</span>:</span></span><br><span class="line">    res=<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000000</span>):</span><br><span class="line">        res*=i</span><br><span class="line">        g1.switch()</span><br><span class="line"></span><br><span class="line">start=time.time()</span><br><span class="line">g1=greenlet(f1)</span><br><span class="line">g2=greenlet(f2)</span><br><span class="line">g1.switch()</span><br><span class="line">stop=time.time()</span><br><span class="line">print(<span class="string">'run time is %s'</span> %(stop-start)) <span class="comment"># 52.763017892837524</span></span><br></pre></td></tr></table></figure>

<p>​        greenlet只是提供了一种比generator更加便捷的切换方式，当切到一个任务执行时如果遇到io，那就原地阻塞，仍然是没有解决遇到IO自动切换来提升效率的问题。</p>
<p>​        单线程里的这20个任务的代码通常会既有计算操作又有阻塞操作，我们完全可以在执行任务1时遇到阻塞，就利用阻塞的时间去执行任务2。。。。如此，才能提高效率，这就用到了Gevent模块。</p>
<h2 id="（四）Gevent模块"><a href="#（四）Gevent模块" class="headerlink" title="（四）Gevent模块"></a>（四）Gevent模块</h2><p>安装：pip3 install gevent</p>
<p>​        Gevent 是一个第三方库，可以轻松通过gevent实现并发同步或异步编程，在gevent中用到的主要模式是<strong>Greenlet</strong>, 它是以C扩展模块形式接入Python的轻量级协程。 Greenlet全部运行在主程序操作系统进程的内部，但它们被协作式地调度。</p>
<p>用法介绍:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">g1=gevent.spawn(func,<span class="number">1</span>,,<span class="number">2</span>,<span class="number">3</span>,x=<span class="number">4</span>,y=<span class="number">5</span>)<span class="comment">#创建一个协程对象g1，spawn括号内第一个参数是函数名，如eat，后面可以有多个参数，可以是位置实参或关键字实参，都是传给函数eat的</span></span><br><span class="line"></span><br><span class="line">g2=gevent.spawn(func2)</span><br><span class="line"></span><br><span class="line">g1.join() <span class="comment">#等待g1结束</span></span><br><span class="line"></span><br><span class="line">g2.join() <span class="comment">#等待g2结束</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者上述两步合作一步：gevent.joinall([g1,g2])</span></span><br><span class="line"></span><br><span class="line">g1.value<span class="comment">#拿到func1的返回值</span></span><br></pre></td></tr></table></figure>

<p>例：遇到io主动切换</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">'%s eat 1'</span> %name)</span><br><span class="line">    gevent.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">'%s eat 2'</span> %name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">play</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">'%s play 1'</span> %name)</span><br><span class="line">    gevent.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">'%s play 2'</span> %name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">g1=gevent.spawn(eat,<span class="string">'egon'</span>)</span><br><span class="line">g2=gevent.spawn(play,name=<span class="string">'egon'</span>)</span><br><span class="line">g1.join()</span><br><span class="line">g2.join()</span><br><span class="line"><span class="comment">#或者gevent.joinall([g1,g2])</span></span><br><span class="line">print(<span class="string">'主'</span>)</span><br></pre></td></tr></table></figure>

<p><strong>上例gevent.sleep(2)模拟的是gevent可以识别的io阻塞</strong>,<strong>而time.sleep(2)或其他的阻塞,gevent是不能直接识别的需要用下面一行代码,打补丁,就可以识别了</strong></p>
<p><strong>from gevent import monkey;monkey.patch_all()必须放到被打补丁者的前面，如time，socket模块之前</strong></p>
<p><strong>或者我们干脆记忆成：要用gevent，需要将from gevent import monkey;monkey.patch_all()放到文件的开头</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey;monkey.patch_all()</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'eat food 1'</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">'eat food 2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">play</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'play 1'</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">'play 2'</span>)</span><br><span class="line"></span><br><span class="line">g1=gevent.spawn(eat)</span><br><span class="line">g2=gevent.spawn(play)</span><br><span class="line">gevent.joinall([g1,g2])</span><br><span class="line">print(<span class="string">'主'</span>)</span><br></pre></td></tr></table></figure>

<p>我们可以用threading.current_thread().getName()来查看每个g1和g2，查看的结果为DummyThread-n，即假线程</p>
<p><img src="https://raw.githubusercontent.com/suliangxu/MyHexoPicture/master/python%E5%85%A8%E6%A0%88/%E7%AC%AC02%E9%83%A8%E5%88%86%EF%BC%9A%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2B%E6%95%B0%E6%8D%AE%E5%BA%93%2B%E5%89%8D%E7%AB%AF/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/13.png" alt="img"></p>
<p>查看threading.current_thread().getName()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey;monkey.patch_all()</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">()</span>:</span></span><br><span class="line">    print(threading.current_thread().getName())</span><br><span class="line">    print(<span class="string">'eat food 1'</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">'eat food 2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">play</span><span class="params">()</span>:</span></span><br><span class="line">    print(threading.current_thread().getName())</span><br><span class="line">    print(<span class="string">'play 1'</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">'play 2'</span>)</span><br><span class="line"></span><br><span class="line">g1=gevent.spawn(eat)</span><br><span class="line">g2=gevent.spawn(play)</span><br><span class="line">gevent.joinall([g1,g2])</span><br><span class="line">print(<span class="string">'主'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="（五）Gevent之同步与异步"><a href="#（五）Gevent之同步与异步" class="headerlink" title="（五）Gevent之同步与异步"></a>（五）Gevent之同步与异步</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> spawn,joinall,monkey;monkey.patch_all()</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">task</span><span class="params">(pid)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Some non-deterministic task</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    print(<span class="string">'Task %s done'</span> % pid)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">synchronous</span><span class="params">()</span>:</span>  <span class="comment"># 同步</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        task(i)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">asynchronous</span><span class="params">()</span>:</span> <span class="comment"># 异步</span></span><br><span class="line">    g_l=[spawn(task,i) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>)]</span><br><span class="line">    joinall(g_l)</span><br><span class="line">    print(<span class="string">'DONE'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(<span class="string">'Synchronous:'</span>)</span><br><span class="line">    synchronous()</span><br><span class="line">    print(<span class="string">'Asynchronous:'</span>)</span><br><span class="line">    asynchronous()</span><br><span class="line"><span class="comment">#  上面程序的重要部分是将task函数封装到Greenlet内部线程的gevent.spawn。</span></span><br><span class="line"><span class="comment">#  初始化的greenlet列表存放在数组threads中，此数组被传给gevent.joinall 函数，</span></span><br><span class="line"><span class="comment">#  后者阻塞当前流程，并执行所有给定的greenlet任务。执行流程只会在 所有greenlet执行完后才会继续向下走。</span></span><br></pre></td></tr></table></figure>

<h2 id="（六）Gevent之应用举例"><a href="#（六）Gevent之应用举例" class="headerlink" title="（六）Gevent之应用举例"></a>（六）Gevent之应用举例</h2><p><strong>注意 ：</strong>from gevent import monkey;monkey.patch_all()一定要放到导入socket模块之前，否则gevent无法识别socket的阻塞</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 协程 : 能够在一个线程中实现并发效果的概念</span></span><br><span class="line">    <span class="comment">#    能够规避一些任务中的IO操作</span></span><br><span class="line">    <span class="comment">#    在任务的执行过程中,检测到IO就切换到其他任务</span></span><br></pre></td></tr></table></figure>

<h3 id="1、爬虫"><a href="#1、爬虫" class="headerlink" title="1、爬虫"></a>1、爬虫</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey;monkey.patch_all()</span><br><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen    <span class="comment"># 内置的模块</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_url</span><span class="params">(url)</span>:</span></span><br><span class="line">    response = urlopen(url)</span><br><span class="line">    content = response.read().decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">return</span> len(content)</span><br><span class="line"></span><br><span class="line">g1 = gevent.spawn(get_url, <span class="string">'http://www.baidu.com'</span>)</span><br><span class="line">g2 = gevent.spawn(get_url, <span class="string">'http://www.sogou.com'</span>)</span><br><span class="line">g3 = gevent.spawn(get_url, <span class="string">'http://www.taobao.com'</span>)</span><br><span class="line">g4 = gevent.spawn(get_url, <span class="string">'http://www.hao123.com'</span>)</span><br><span class="line">g5 = gevent.spawn(get_url, <span class="string">'http://www.cnblogs.com'</span>)</span><br><span class="line">gevent.joinall([g1 , g2, g3, g4, g5])</span><br><span class="line">print(g1.value)</span><br><span class="line">print(g2.value)</span><br><span class="line">print(g3.value)</span><br><span class="line">print(g4.value)</span><br><span class="line">print(g5.value)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ret = get_url('http://www.baidu.com')</span></span><br><span class="line"><span class="comment"># print(ret)</span></span><br></pre></td></tr></table></figure>

<h3 id="2、socket"><a href="#2、socket" class="headerlink" title="2、socket"></a>2、socket</h3><p>通过gevent实现单线程下的socket并发</p>
<p>server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey;monkey.patch_all()</span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果不想用money.patch_all()打补丁,可以用gevent自带的socket</span></span><br><span class="line"><span class="comment"># from gevent import socket</span></span><br><span class="line"><span class="comment"># s=socket.socket()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span><span class="params">(server_ip,port)</span>:</span></span><br><span class="line">    s=socket(AF_INET,SOCK_STREAM)</span><br><span class="line">    s.setsockopt(SOL_SOCKET,SO_REUSEADDR,<span class="number">1</span>)</span><br><span class="line">    s.bind((server_ip,port))</span><br><span class="line">    s.listen(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        conn,addr=s.accept()</span><br><span class="line">        gevent.spawn(talk,conn,addr)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">talk</span><span class="params">(conn,addr)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            res=conn.recv(<span class="number">1024</span>)</span><br><span class="line">            print(<span class="string">'client %s:%s msg: %s'</span> %(addr[<span class="number">0</span>],addr[<span class="number">1</span>],res))</span><br><span class="line">            conn.send(res.upper())</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        conn.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    server(<span class="string">'127.0.0.1'</span>,<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>

<p>client</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">client=socket(AF_INET,SOCK_STREAM)</span><br><span class="line">client.connect((<span class="string">'127.0.0.1'</span>,<span class="number">8080</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    msg=input(<span class="string">'&gt;&gt;: '</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> msg:<span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    client.send(msg.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    msg=client.recv(<span class="number">1024</span>)</span><br><span class="line">    print(msg.decode(<span class="string">'utf-8'</span>))</span><br></pre></td></tr></table></figure>

<p>多线程并发多个客户端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client</span><span class="params">(server_ip,port)</span>:</span></span><br><span class="line">    c=socket(AF_INET,SOCK_STREAM) <span class="comment">#套接字对象一定要加到函数内，即局部名称空间内，放在函数外则被所有线程共享，则大家公用一个套接字对象，那么客户端端口永远一样了</span></span><br><span class="line">    c.connect((server_ip,port))</span><br><span class="line"></span><br><span class="line">    count=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        c.send((<span class="string">'%s say hello %s'</span> %(threading.current_thread().getName(),count)).encode(<span class="string">'utf-8'</span>))</span><br><span class="line">        msg=c.recv(<span class="number">1024</span>)</span><br><span class="line">        print(msg.decode(<span class="string">'utf-8'</span>))</span><br><span class="line">        count+=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">500</span>):</span><br><span class="line">        t=Thread(target=client,args=(<span class="string">'127.0.0.1'</span>,<span class="number">8080</span>))</span><br><span class="line">        t.start()</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/09/python全栈/第01部分：基础+模块+面向对象+网络编程/模块/模块和包/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/09/python全栈/第01部分：基础+模块+面向对象+网络编程/模块/模块和包/" itemprop="url">模块和包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-09T07:53:58+08:00">
                2019-08-09
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python全栈-01部分-模块和包/" itemprop="url" rel="index">
                    <span itemprop="name">python全栈 -01部分 -模块和包</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="（一）模块"><a href="#（一）模块" class="headerlink" title="（一）模块"></a>（一）模块</h2><h3 id="一、什么是模块"><a href="#一、什么是模块" class="headerlink" title="一、什么是模块"></a>一、什么是模块</h3><p>​        常见的场景：一个模块就是一个包含了python定义和声明的文件，文件名就是模块名字加上.py的后缀。</p>
<p>   但其实import加载的模块分为四个通用类别：　</p>
<p>　　1 使用python编写的代码（.py文件）</p>
<p>　　2 已被编译为共享库或DLL的C或C++扩展</p>
<p>　　3 包好一组模块的包</p>
<p>　　4 使用C编写并链接到python解释器的内置模块</p>
<h3 id="二、为何要使用模块"><a href="#二、为何要使用模块" class="headerlink" title="二、为何要使用模块"></a>二、为何要使用模块</h3><p>​    如果你退出python解释器然后重新进入，那么你之前定义的函数或者变量都将丢失，因此我们通常将程序写到文件中以便永久保存下来，需要时就通过python test.py方式去执行，此时test.py被称为脚本script。</p>
<p>​    随着程序的发展，功能越来越多，为了方便管理，我们通常将程序分成一个个的文件，这样做程序的结构更清晰，方便管理。这时我们不仅仅可以把这些文件当做脚本去执行，还可以把他们当做模块来导入到其他的模块中，实现了功能的重复利用，</p>
<h3 id="三、如何使用模块"><a href="#三、如何使用模块" class="headerlink" title="三、如何使用模块"></a>三、如何使用模块</h3><h4 id="1、import"><a href="#1、import" class="headerlink" title="1、import"></a>1、import</h4><p>示例文件：自定义模块my_module.py，文件名my_module.py,模块名my_module</p>
<p>my_module模块:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#my_module.py</span></span><br><span class="line">print(<span class="string">'from the my_module.py'</span>)</span><br><span class="line"></span><br><span class="line">money=<span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'my_module-&gt;read1-&gt;money'</span>,money)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read2</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'my_module-&gt;read2 calling read1'</span>)</span><br><span class="line">    read1()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> money</span><br><span class="line">    money=<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>​        模块可以包含可执行的语句和函数的定义，这些语句的目的是初始化模块，它们只在模块名第一次遇到导入import语句时才执行（import语句是可以在程序中的任意位置使用的,且针对同一个模块很import多次,为了防止你重复导入，python的优化手段是：第一次导入后就将模块名加载到内存了，后续的import语句仅是对已经加载大内存中的模块对象增加了一次引用，不会重新执行模块内的语句），如下 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#demo.py</span></span><br><span class="line"><span class="keyword">import</span> my_module <span class="comment">#只在第一次导入时才执行my_module.py内代码,此处的显式效果是只打印一次'from the my_module.py',当然其他的顶级代码也都被执行了,只不过没有显示效果.</span></span><br><span class="line"><span class="keyword">import</span> my_module</span><br><span class="line"><span class="keyword">import</span> my_module</span><br><span class="line"><span class="keyword">import</span> my_module</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">执行结果：</span></span><br><span class="line"><span class="string">from the my_module.py</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>

<p>​        我们可以从sys.modules中找到当前已经加载的模块，sys.modules是一个字典，内部包含模块名与模块对象的映射，该字典决定了导入模块时是否需要重新导入。</p>
<p>​        每个模块都是一个独立的名称空间，定义在这个模块中的函数，把这个模块的名称空间当做全局名称空间，这样我们在编写自己的模块时，就不用担心我们定义在自己模块中全局变量会在被导入时，与使用者的全局变量冲突</p>
<p>测试一:money与my_module.money不冲突</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#测试一:money与my_module.money不冲突</span></span><br><span class="line"><span class="comment">#demo.py</span></span><br><span class="line"><span class="keyword">import</span> my_module</span><br><span class="line">money=<span class="number">10</span></span><br><span class="line">print(my_module.money)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">执行结果：</span></span><br><span class="line"><span class="string">from the my_module.py</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>

<p>测试二：read1与my_module.read1不冲突</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#测试二：read1与my_module.read1不冲突</span></span><br><span class="line"><span class="comment">#demo.py</span></span><br><span class="line"><span class="keyword">import</span> my_module</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'========'</span>)</span><br><span class="line">my_module.read1()</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">执行结果:</span></span><br><span class="line"><span class="string">from the my_module.py</span></span><br><span class="line"><span class="string">my_module-&gt;read1-&gt;money 1000</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>

<p>测试三：执行my_module.change()操作的全局变量money仍然是my_module中的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#测试三：执行my_module.change()操作的全局变量money仍然是my_module中的</span></span><br><span class="line"><span class="comment">#demo.py</span></span><br><span class="line"><span class="keyword">import</span> my_module</span><br><span class="line">money=<span class="number">1</span></span><br><span class="line">my_module.change()</span><br><span class="line">print(money)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">执行结果：</span></span><br><span class="line"><span class="string">from the my_module.py</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>

<p>总结：首次导入模块my_module时会做三件事：</p>
<p>1.为源文件(my_module模块)创建新的名称空间，在my_module中定义的函数和方法若是使用到了global时访问的就是这个名称空间。</p>
<p>2.在新创建的命名空间中执行模块中包含的代码，见初始导入import my_module</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1 提示:导入模块时到底执行了什么？</span><br><span class="line">2 </span><br><span class="line">3 In fact function definitions are also ‘statements’ that are ‘executed’; the execution of a module-level function definition enters the function name in the module’s global symbol table.</span><br><span class="line">4 事实上函数定义也是“被执行”的语句，模块级别函数定义的执行将函数名放入模块全局名称空间表，用globals()可以查看</span><br></pre></td></tr></table></figure>

<p>3.创建名字my_module来引用该命名空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 这个名字和变量名没什么区别，都是‘第一类的’，且使用my_module.名字的方式可以访问my_module.py文件中定义的名字，my_module.名字与test.py中的名字来自两个完全不同的地方。</span><br></pre></td></tr></table></figure>

<p>为模块名起别名，相当于m1=1;m2=m1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> my_module <span class="keyword">as</span> sm</span><br><span class="line">print(sm.money)</span><br></pre></td></tr></table></figure>

<p>示范用法一：</p>
<p>有两中sql模块mysql和oracle，根据用户的输入，选择不同的sql功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sqlparse</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'from mysql sqlparse'</span>)</span><br><span class="line"><span class="comment">#oracle.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sqlparse</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'from oracle sqlparse'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#test.py</span></span><br><span class="line">db_type=input(<span class="string">'&gt;&gt;: '</span>)</span><br><span class="line"><span class="keyword">if</span> db_type == <span class="string">'mysql'</span>:</span><br><span class="line">    <span class="keyword">import</span> mysql <span class="keyword">as</span> db</span><br><span class="line"><span class="keyword">elif</span> db_type == <span class="string">'oracle'</span>:</span><br><span class="line">    <span class="keyword">import</span> oracle <span class="keyword">as</span> db</span><br><span class="line"></span><br><span class="line">db.sqlparse()</span><br></pre></td></tr></table></figure>

<p>示范用法二： </p>
<p>​        为已经导入的模块起别名的方式对编写可扩展的代码很有用，假设有两个模块xmlreader.py和csvreader.py，它们都定义了函数read_data(filename):用来从文件中读取一些数据，但采用不同的输入格式。可以编写代码来选择性地挑选读取模块，例如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> file_format == <span class="string">'xml'</span>:</span><br><span class="line">     <span class="keyword">import</span> xmlreader <span class="keyword">as</span> reader</span><br><span class="line"><span class="keyword">elif</span> file_format == <span class="string">'csv'</span>:</span><br><span class="line">     <span class="keyword">import</span> csvreader <span class="keyword">as</span> reader</span><br><span class="line">data=reader.read_date(filename)</span><br></pre></td></tr></table></figure>

<p>在一行导入多个模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys,os,re</span><br></pre></td></tr></table></figure>

<h4 id="2、-from-…-import…"><a href="#2、-from-…-import…" class="headerlink" title="2、 from … import…"></a>2、 <strong>from … import…</strong></h4><p>​        对比import my_module，会将源文件的名称空间’my_module’带到当前名称空间中，使用时必须是my_module.名字的方式</p>
<p>​        而from 语句相当于import，也会创建新的名称空间，但是将my_module中的名字直接导入到当前的名称空间中，在当前名称空间中，直接使用名字就可以了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> my_module <span class="keyword">import</span> read1,read2</span><br></pre></td></tr></table></figure>

<p>这样在当前位置直接使用read1和read2就好了，执行时，仍然以my_module.py文件全局名称空间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#测试一：导入的函数read1，执行时仍然回到my_module.py中寻找全局变量money</span></span><br><span class="line"><span class="comment">#demo.py</span></span><br><span class="line"><span class="keyword">from</span> my_module <span class="keyword">import</span> read1</span><br><span class="line">money=<span class="number">1000</span></span><br><span class="line">read1()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">执行结果:</span></span><br><span class="line"><span class="string">from the my_module.py</span></span><br><span class="line"><span class="string">spam-&gt;read1-&gt;money 1000</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试二:导入的函数read2，执行时需要调用read1(),仍然回到my_module.py中找read1()</span></span><br><span class="line"><span class="comment">#demo.py</span></span><br><span class="line"><span class="keyword">from</span> my_module <span class="keyword">import</span> read2</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'=========='</span>)</span><br><span class="line">read2()</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">执行结果:</span></span><br><span class="line"><span class="string">from the my_module.py</span></span><br><span class="line"><span class="string">my_module-&gt;read2 calling read1</span></span><br><span class="line"><span class="string">my_module-&gt;read1-&gt;money 1000</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>

<p>如果当前有重名read1或者read2，那么会有覆盖效果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#测试三:导入的函数read1，被当前位置定义的read1覆盖掉了</span></span><br><span class="line"><span class="comment">#demo.py</span></span><br><span class="line"><span class="keyword">from</span> my_module <span class="keyword">import</span> read1</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'=========='</span>)</span><br><span class="line">read1()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">执行结果:</span></span><br><span class="line"><span class="string">from the my_module.py</span></span><br><span class="line"><span class="string">==========</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>

<p>需要特别强调的一点是：python中的变量赋值不是一种存储操作，而只是一种绑定关系，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> my_module <span class="keyword">import</span> money,read1</span><br><span class="line">money=<span class="number">100</span> <span class="comment">#将当前位置的名字money绑定到了100</span></span><br><span class="line">print(money) <span class="comment">#打印当前的名字</span></span><br><span class="line">read1() <span class="comment">#读取my_module.py中的名字money,仍然为1000</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">from the my_module.py</span></span><br><span class="line"><span class="string">my_module-&gt;read1-&gt;money 1000</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>

<p>也支持as</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> my_module <span class="keyword">import</span> read1 <span class="keyword">as</span> read</span><br></pre></td></tr></table></figure>

<p>也支持导入多行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> my_module <span class="keyword">import</span> (read1,</span><br><span class="line">                       read2,</span><br><span class="line">                 			 money)</span><br></pre></td></tr></table></figure>

<p>​        from my_module import * 把my_module中所有的不是以下划线(_)开头的名字都导入到当前位置，大部分情况下我们的python程序不应该使用这种导入方式，因为*你不知道你导入什么名字，很有可能会覆盖掉你之前已经定义的名字。而且可读性极其的差，在交互式环境中导入时没有问题。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> my_module <span class="keyword">import</span> * <span class="comment">#将模块my_module中所有的名字都导入到当前名称空间</span></span><br><span class="line">print(money)</span><br><span class="line">print(read1)</span><br><span class="line">print(read2)</span><br><span class="line">print(change)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">执行结果:</span></span><br><span class="line"><span class="string">from the my_module.py</span></span><br><span class="line"><span class="string">&lt;function read1 at 0x1012e8158&gt;</span></span><br><span class="line"><span class="string">&lt;function read2 at 0x1012e81e0&gt;</span></span><br><span class="line"><span class="string">&lt;function change at 0x1012e8268&gt;</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>

<p>在my_module.py中新增一行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__all__=[<span class="string">'money'</span>,<span class="string">'read1'</span>] <span class="comment">#这样在另外一个文件中用from my_module import *就这能导入列表中规定的两个名字</span></span><br></pre></td></tr></table></figure>

<p><strong>如果my_module.py中的名字前加_,即_money，则from my_module import *,则_money不能被导入</strong></p>
<p><strong>模块的循环引用问题</strong></p>
<p>思考：假如有两个模块a，b。我可不可以在a模块中import b ，再在b模块中import a</p>
<p><strong>模块的加载与修改</strong></p>
<p>​        考虑到性能的原因，每个模块只被导入一次,放入字典sys.modules中，如果你改变了模块的内容，你必须重启程序，python不支持重新加载或卸载之前导入的模块，</p>
<p>​        有的同学可能会想到直接从sys.modules中删除一个模块不就可以卸载了吗，注意了，你删了sys.modules中的模块对象仍然可能被其他程序的组件所引用，因而不会被清除。</p>
<p>​        特别的对于我们引用了这个模块中的一个类，用这个类产生了很多对象，因而这些对象都有关于这个模块的引用。</p>
<p>​        如果只是你想交互测试的一个模块，使用 importlib.reload(), e.g. import importlib; importlib.reload(modulename)，这只能用于测试环境。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># aa.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'func1'</span>)</span><br></pre></td></tr></table></figure>

<p>测试代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time,importlib</span><br><span class="line"><span class="keyword">import</span> aa</span><br><span class="line"> </span><br><span class="line">time.sleep(<span class="number">20</span>)</span><br><span class="line"><span class="comment"># importlib.reload(aa)</span></span><br><span class="line">aa.func1()</span><br></pre></td></tr></table></figure>

<p>在20秒的等待时间里，修改aa.py中func1的内容，等待test.py的结果。</p>
<p>打开importlib注释，重新测试</p>
<h4 id="3、把模块当作脚本运行"><a href="#3、把模块当作脚本运行" class="headerlink" title="3、把模块当作脚本运行"></a>3、把模块当作脚本运行</h4><p>我们可以通过模块的全局变量__name__来查看模块名：<br>当做脚本运行：<br>__name__ 等于’__main__‘</p>
<p>当做模块导入：<br>__name__= 模块名</p>
<p>作用：用来控制.py文件在不同的应用场景下执行不同的逻辑<br>if __name__ == ‘__main__‘:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(n)</span>:</span>   </span><br><span class="line">    a, b = <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> b &lt; n:</span><br><span class="line">        print(b, end=<span class="string">' '</span>)</span><br><span class="line">        a, b = b, a+b</span><br><span class="line">    print()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    print(__name__)</span><br><span class="line">    num = input(<span class="string">'num :'</span>)</span><br><span class="line">    fib(int(num))</span><br></pre></td></tr></table></figure>

<h4 id="4、模块搜索路径"><a href="#4、模块搜索路径" class="headerlink" title="4、模块搜索路径"></a>4、模块搜索路径</h4><p>python解释器在启动时会自动加载一些模块，可以使用sys.modules查看</p>
<p>在第一次导入某个模块时（比如my_module），会先检查该模块是否已经被加载到内存中（当前执行文件的名称空间对应的内存），如果有则直接引用</p>
<p>如果没有，解释器则会查找同名的内建模块，如果还没有找到就从sys.path给出的目录列表中依次寻找my_module.py文件。</p>
<p><strong>所以总结模块的查找顺序是：内存中已经加载的模块-&gt;内置模块-&gt;sys.path路径中包含的模块</strong></p>
<p>sys.path的初始化的值来自于：</p>
<p>The directory containing the input script (or the current directory when no file is specified).<br>PYTHONPATH (a list of directory names, with the same syntax as the shell variable PATH).<br>The installation-dependent default.</p>
<p>需要特别注意的是：我们自定义的模块名不应该与系统内置模块重名。虽然每次都说，但是仍然会有人不停的犯错。 </p>
<p>在初始化后，python程序可以修改sys.path,路径放到前面的优先于标准库被加载。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.path.append(<span class="string">'/a/b/c/d'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.path.insert(<span class="number">0</span>,<span class="string">'/x/y/z'</span>) <span class="comment">#排在前的目录，优先被搜索</span></span><br></pre></td></tr></table></figure>

<p>​        注意：搜索时按照sys.path中从左到右的顺序查找，位于前的优先被查找，sys.path中还可能包含.zip归档文件和.egg文件，python会把.zip归档文件当成一个目录去处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#首先制作归档文件：zip module.zip foo.py bar.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.append(<span class="string">'module.zip'</span>)</span><br><span class="line"><span class="keyword">import</span> foo,bar</span><br><span class="line"></span><br><span class="line"><span class="comment">#也可以使用zip中目录结构的具体位置</span></span><br><span class="line">sys.path.append(<span class="string">'module.zip/lib/python'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#windows下的路径不加r开头，会语法错误</span></span><br><span class="line">sys.path.insert(<span class="number">0</span>,<span class="string">r'C:\Users\Administrator\PycharmProjects\a'</span>)</span><br></pre></td></tr></table></figure>

<p>​        至于.egg文件是由setuptools创建的包，这是按照第三方python库和扩展时使用的一种常见格式，.egg文件实际上只是添加了额外元数据(如版本号，依赖项等)的.zip文件。</p>
<p>​        需要强调的一点是：只能从.zip文件中导入.py，.pyc等文件。使用C编写的共享库和扩展块无法直接从.zip文件中加载（此时setuptools等打包系统有时能提供一种规避方法），且从.zip中加载文件不会创建.pyc或者.pyo文件，因此一定要事先创建他们，来避免加载模块是性能下降。</p>
<p><strong>官网解释</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#官网链接：https://docs.python.org/3/tutorial/modules.html#the-module-search-path</span><br><span class="line">搜索路径：</span><br><span class="line">当一个命名为my_module的模块被导入时</span><br><span class="line">    解释器首先会从内建模块中寻找该名字</span><br><span class="line">    找不到，则去sys.path中找该名字</span><br><span class="line"></span><br><span class="line">sys.path从以下位置初始化</span><br><span class="line">执行文件所在的当前目录</span><br><span class="line">PTYHONPATH（包含一系列目录名，与shell变量PATH语法一样）</span><br><span class="line">依赖安装时默认指定的</span><br><span class="line"></span><br><span class="line">注意：在支持软连接的文件系统中，执行脚本所在的目录是在软连接之后被计算的，换句话说，包含软连接的目录不会被添加到模块的搜索路径中</span><br><span class="line"></span><br><span class="line">在初始化后，我们也可以在python程序中修改sys.path,执行文件所在的路径默认是sys.path的第一个目录，在所有标准库路径的前面。这意味着，当前目录是优先于标准库目录的，需要强调的是：我们自定义的模块名不要跟python标准库的模块名重复，除非你是故意的，傻叉。</span><br></pre></td></tr></table></figure>

<h4 id="5、编译python文件"><a href="#5、编译python文件" class="headerlink" title="5、编译python文件"></a>5、编译python文件</h4><p>​        为了提高加载模块的速度，强调强调强调：提高的是加载速度而绝非运行速度。python解释器会在<strong>pycache</strong>目录中下缓存每个模块编译后的版本，格式为：module.version.pyc。通常会包含python的版本号。例如，在CPython3.3版本下，    my_module.py模块会被缓存成<strong>pycache</strong>/my_module.cpython-33.pyc。这种命名规范保证了编译后的结果多版本共存。</p>
<p>​        Python检查源文件的修改时间与编译的版本进行对比，如果过期就需要重新编译。这是完全自动的过程。并且编译的模块是平台独立的，所以相同的库可以在不同的架构的系统之间共享，即pyc使一种跨平台的字节码，类似于JAVA火.NET,是由python虚拟机来执行的，但是pyc的内容跟python的版本相关，不同的版本编译后的pyc文件不同，2.5编译的pyc文件不能到3.5上执行，并且pyc文件是可以反编译的，因而它的出现仅仅是用来提升模块的加载速度的。</p>
<p>python解释器在以下两种情况下不检测缓存<br>　　1 如果是在命令行中被直接导入模块，则按照这种方式，每次导入都会重新编译，并且不会存储编译后的结果（python3.3以前的版本应该是这样）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m my_module.py</span><br></pre></td></tr></table></figure>

<p>2 如果源文件不存在，那么缓存的结果也不会被使用，如果想在没有源文件的情况下来使用编译后的结果，则编译后的结果必须在源目录下 </p>
<p>提示：</p>
<p>1.模块名区分大小写，foo.py与FOO.py代表的是两个模块</p>
<p>2.你可以使用-O或者-OO转换python命令来减少编译模块的大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-O转换会帮你去掉assert语句</span><br><span class="line">-OO转换会帮你去掉assert语句和__doc__文档字符串</span><br><span class="line">由于一些程序可能依赖于assert语句或文档字符串，你应该在在确认需要的情况下使用这些选项。</span><br></pre></td></tr></table></figure>

<p>3.在速度上从.pyc文件中读指令来执行不会比从.py文件中读指令执行更快，只有在模块被加载时，.pyc文件才是更快的</p>
<p>4.只有使用import语句是才将文件自动编译为.pyc文件，在命令行或标准输入中指定运行脚本则不会生成这类文件，因而我们可以使用compieall模块为一个目录中的所有模块创建.pyc文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">模块可以作为一个脚本（使用python -m compileall）编译Python源</span><br><span class="line"> </span><br><span class="line">python -m compileall /module_directory 递归着编译</span><br><span class="line">如果使用python -O -m compileall /module_directory -l则只一层</span><br><span class="line"> </span><br><span class="line">命令行里使用compile()函数时，自动使用python -O -m compileall</span><br><span class="line"> </span><br><span class="line">详见：https://docs.python.org/3/library/compileall.html#module-compileall</span><br></pre></td></tr></table></figure>

<h4 id="6、补充：dir-函数"><a href="#6、补充：dir-函数" class="headerlink" title="6、补充：dir() 函数"></a>6、补充：dir() 函数</h4><p>内建函数dir是用来查找模块中定义的名字，返回一个有序字符串列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> my_module</span><br><span class="line">dir(my_module)</span><br></pre></td></tr></table></figure>

<p>如果没有参数,dir()列举出当前定义的名字</p>
<p>dir()不会列举出内建函数或者变量的名字，它们都被定义到了标准模块builtin中，可以列举出它们，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> builtins</span><br><span class="line">dir(builtins)</span><br></pre></td></tr></table></figure>

<h2 id="（二）包"><a href="#（二）包" class="headerlink" title="（二）包"></a>（二）包</h2><p>包是一种通过使用‘.模块名’来组织python模块名称空间的方式。</p>
<p><strong>１. 无论是import形式还是from…import形式，凡是在导入语句中（而不是在使用时）遇到带点的，都要第一时间提高警觉：这是关于包才有的导入语法</strong></p>
<p><strong>2. 包是目录级的（文件夹级），文件夹是用来组成py文件（包的本质就是一个包含<strong>init</strong>.py文件的目录）</strong></p>
<p><strong>3. import导入文件时，产生名称空间中的名字来源于文件，import 包，产生的名称空间的名字同样来源于文件，即包下的<strong>init</strong>.py，导入包本质就是在导入该文件</strong></p>
<p><strong>强调：</strong></p>
<p>　　<strong>1. 在python3中，即使包下没有<strong>init</strong>.py文件，import 包仍然不会报错，而在python2中，包下一定要有该文件，否则import 包报错</strong></p>
<p>　　<strong>2. 创建包的目的不是为了运行，而是被导入使用，记住，包只是模块的一种形式而已，包即模块</strong></p>
<p>包A和包B下有同名模块也不会冲突，如A.a与B.a来自俩个命名空间</p>
<p>创建目录代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.makedirs(<span class="string">'glance/api'</span>)</span><br><span class="line">os.makedirs(<span class="string">'glance/cmd'</span>)</span><br><span class="line">os.makedirs(<span class="string">'glance/db'</span>)</span><br><span class="line">l = []</span><br><span class="line">l.append(open(<span class="string">'glance/__init__.py'</span>,<span class="string">'w'</span>))</span><br><span class="line">l.append(open(<span class="string">'glance/api/__init__.py'</span>,<span class="string">'w'</span>))</span><br><span class="line">l.append(open(<span class="string">'glance/api/policy.py'</span>,<span class="string">'w'</span>))</span><br><span class="line">l.append(open(<span class="string">'glance/api/versions.py'</span>,<span class="string">'w'</span>))</span><br><span class="line">l.append(open(<span class="string">'glance/cmd/__init__.py'</span>,<span class="string">'w'</span>))</span><br><span class="line">l.append(open(<span class="string">'glance/cmd/manage.py'</span>,<span class="string">'w'</span>))</span><br><span class="line">l.append(open(<span class="string">'glance/db/models.py'</span>,<span class="string">'w'</span>))</span><br><span class="line">map(<span class="keyword">lambda</span> f:f.close() ,l)</span><br></pre></td></tr></table></figure>

<p>目录结构：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">glance/                   <span class="comment">#Top-level package</span></span><br><span class="line"></span><br><span class="line">├── __init__.py      <span class="comment">#Initialize the glance package</span></span><br><span class="line"></span><br><span class="line">├── api                  <span class="comment">#Subpackage for api</span></span><br><span class="line"></span><br><span class="line">│   ├── __init__.py</span><br><span class="line"></span><br><span class="line">│   ├── policy.py</span><br><span class="line"></span><br><span class="line">│   └── versions.py</span><br><span class="line"></span><br><span class="line">├── cmd                <span class="comment">#Subpackage for cmd</span></span><br><span class="line"></span><br><span class="line">│   ├── __init__.py</span><br><span class="line"></span><br><span class="line">│   └── manage.py</span><br><span class="line"></span><br><span class="line">└── db                  <span class="comment">#Subpackage for db</span></span><br><span class="line"></span><br><span class="line">    ├── __init__.py</span><br><span class="line"></span><br><span class="line">    └── models.py</span><br></pre></td></tr></table></figure>

<p>文件内容:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#文件内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#policy.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'from policy.py'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#versions.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_resource</span><span class="params">(conf)</span>:</span></span><br><span class="line">    print(<span class="string">'from version.py: '</span>,conf)</span><br><span class="line"></span><br><span class="line"><span class="comment">#manage.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'from manage.py'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#models.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_models</span><span class="params">(engine)</span>:</span></span><br><span class="line">    print(<span class="string">'from models.py: '</span>,engine)</span><br></pre></td></tr></table></figure>

<h3 id="一、注意事项"><a href="#一、注意事项" class="headerlink" title="一、注意事项"></a>一、注意事项</h3><p>​        1.关于包相关的导入语句也分为import和from … import …两种，但是无论哪种，无论在什么位置，在导入时都必须遵循一个原则：凡是在导入时带点的，点的左边都必须是一个包，否则非法。可以带有一连串的点，如item.subitem.subsubitem,但都必须遵循这个原则。</p>
<p>​        2.对于导入后，在使用时就没有这种限制了，点的左边可以是包,模块，函数，类(它们都可以用点的方式调用自己的属性)。</p>
<p>​        3.对比import item 和from item import name的应用场景：<br>如果我们想直接使用name那必须使用后者。</p>
<h3 id="二、import"><a href="#二、import" class="headerlink" title="二、import"></a>二、import</h3><p>我们在与包glance同级别的文件中测试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> glance.db.models</span><br><span class="line">glance.db.models.register_models(<span class="string">'mysql'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="三、from-…-import-…"><a href="#三、from-…-import-…" class="headerlink" title="三、from … import …"></a>三、from … import …</h3><p><strong>需要注意的是from后import导入的模块，必须是明确的一个不能带点，否则会有语法错误，如：from a import b.c是错误语法</strong></p>
<p>我们在与包glance同级别的文件中测试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> glance.db <span class="keyword">import</span> models</span><br><span class="line">models.register_models(<span class="string">'mysql'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> glance.db.models <span class="keyword">import</span> register_models</span><br><span class="line">register_models(<span class="string">'mysql'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="四、-init-py文件"><a href="#四、-init-py文件" class="headerlink" title="四、__init__.py文件"></a>四、__init__.py文件</h3><p>​        不管是哪种方式，只要是第一次导入包或者是包的任何其他部分，都会依次执行包下的<strong>init</strong>.py文件(我们可以在每个包的文件内都打印一行内容来验证一下)，这个文件可以为空，但是也可以存放一些初始化包的代码。</p>
<h3 id="五、from-glance-api-import"><a href="#五、from-glance-api-import" class="headerlink" title="五、from glance.api import *"></a>五、from glance.api import *</h3><p>​        在讲模块时，我们已经讨论过了从一个模块内导入所有<em>，此处我们研究从一个包导入所有</em>。</p>
<p>​        此处是想从包api中导入所有，实际上该语句只会导入包api下__init__.py文件中定义的名字，我们可以在这个文件中定义__all___:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在__init__.py中定义</span></span><br><span class="line">x=<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'from api.__init.py'</span>)</span><br><span class="line"></span><br><span class="line">__all__=[<span class="string">'x'</span>,<span class="string">'func'</span>,<span class="string">'policy'</span>]</span><br></pre></td></tr></table></figure>

<p>此时我们在于glance同级的文件中执行from glance.api import *就导入__all__中的内容（versions仍然不能导入）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">glance/                   </span><br><span class="line"></span><br><span class="line">├── __init__.py      </span><br><span class="line"></span><br><span class="line">├── api                  </span><br><span class="line"></span><br><span class="line">│   ├── __init__.py   __all__ = [<span class="string">'policy'</span>,<span class="string">'versions'</span>] </span><br><span class="line"></span><br><span class="line">│   ├── policy.py</span><br><span class="line"></span><br><span class="line">│   └── versions.py</span><br><span class="line"></span><br><span class="line">├── cmd               __all__ = [<span class="string">'manage'</span>]    </span><br><span class="line"></span><br><span class="line">│   ├── __init__.py</span><br><span class="line"></span><br><span class="line">│   └── manage.py    </span><br><span class="line"></span><br><span class="line">└── db                __all__ = [<span class="string">'models'</span>]              </span><br><span class="line"></span><br><span class="line">    ├── __init__.py</span><br><span class="line"></span><br><span class="line">    └── models.py</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> glance.api <span class="keyword">import</span> *</span><br><span class="line">policy.get()</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> glance.api <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>

<h3 id="六、绝对导入和相对导入"><a href="#六、绝对导入和相对导入" class="headerlink" title="六、绝对导入和相对导入"></a>六、绝对导入和相对导入</h3><p>​        我们的最顶级包glance是写给别人用的，然后在glance包内部也会有彼此之间互相导入的需求，这时候就有绝对导入和相对导入两种方式：</p>
<p>绝对导入：以glance作为起始</p>
<p>相对导入：用.或者..的方式最为起始（只能在一个包中使用，不能用于不同目录内）</p>
<p>例如：我们在glance/api/version.py中想要导入glance/cmd/manage.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">在glance/api/version.py</span><br><span class="line"></span><br><span class="line"><span class="comment">#绝对导入</span></span><br><span class="line"><span class="keyword">from</span> glance.cmd <span class="keyword">import</span> manage</span><br><span class="line">manage.main()</span><br><span class="line"></span><br><span class="line"><span class="comment">#相对导入</span></span><br><span class="line"><span class="keyword">from</span> ..cmd <span class="keyword">import</span> manage</span><br><span class="line">manage.main()</span><br></pre></td></tr></table></figure>

<p>测试结果：注意一定要在于glance同级的文件中测试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> glance.api <span class="keyword">import</span> versions</span><br></pre></td></tr></table></figure>

<p>​        注意：在使用pycharm时，有的情况会为你多做一些事情，这是软件相关的东西，会影响你对模块导入的理解，因而在测试时，一定要回到命令行去执行，模拟我们生产环境，你总不能拿着pycharm去上线代码吧！！！</p>
<p>​        <strong>特别需要注意的是：可以用import导入内置或者第三方模块（已经在sys.path中），但是要绝对避免使用import来导入自定义包的子模块(没有在sys.path中)，应该使用from… import …的绝对或者相对导入,且包的相对导入只能用from的形式。</strong></p>
<p>​        比如我们想在glance/api/versions.py中导入glance/api/policy.py，有的同学一抽这俩模块是在同一个目录下，十分开心的就去做了，它直接这么做</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在version.py中</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> policy</span><br><span class="line">policy.get()</span><br></pre></td></tr></table></figure>

<p>​        没错，我们单独运行version.py是一点问题没有的，运行version.py的路径搜索就是从当前路径开始的，于是在导入policy时能在当前目录下找到</p>
<p>​        但是你想啊，你子包中的模块version.py极有可能是被一个glance包同一级别的其他文件导入，比如我们在于glance同级下的一个test.py文件中导入version.py，如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> glance.api <span class="keyword">import</span> versions</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">执行结果:</span></span><br><span class="line"><span class="string">ImportError: No module named 'policy'</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">分析:</span></span><br><span class="line"><span class="string">此时我们导入versions在versions.py中执行</span></span><br><span class="line"><span class="string">import policy需要找从sys.path也就是从当前目录找policy.py,</span></span><br><span class="line"><span class="string">这必然是找不到的</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>

<p>绝对导入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">glance/                   </span><br><span class="line"></span><br><span class="line">├── __init__.py      <span class="keyword">from</span> glance <span class="keyword">import</span> api</span><br><span class="line">                             <span class="keyword">from</span> glance <span class="keyword">import</span> cmd</span><br><span class="line">                             <span class="keyword">from</span> glance <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line">├── api                  </span><br><span class="line"></span><br><span class="line">│   ├── __init__.py  <span class="keyword">from</span> glance.api <span class="keyword">import</span> policy</span><br><span class="line">                              <span class="keyword">from</span> glance.api <span class="keyword">import</span> versions</span><br><span class="line"></span><br><span class="line">│   ├── policy.py</span><br><span class="line"></span><br><span class="line">│   └── versions.py</span><br><span class="line"></span><br><span class="line">├── cmd                 <span class="keyword">from</span> glance.cmd <span class="keyword">import</span> manage</span><br><span class="line"></span><br><span class="line">│   ├── __init__.py</span><br><span class="line"></span><br><span class="line">│   └── manage.py</span><br><span class="line"></span><br><span class="line">└── db                   <span class="keyword">from</span> glance.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line">    ├── __init__.py</span><br><span class="line"></span><br><span class="line">    └── models.py</span><br></pre></td></tr></table></figure>

<p>相对导入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">glance/                   </span><br><span class="line"></span><br><span class="line">├── __init__.py      <span class="keyword">from</span> . <span class="keyword">import</span> api  <span class="comment">#.表示当前目录</span></span><br><span class="line">                     <span class="keyword">from</span> . <span class="keyword">import</span> cmd</span><br><span class="line">                     <span class="keyword">from</span> . <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line">├── api                  </span><br><span class="line"></span><br><span class="line">│   ├── __init__.py  <span class="keyword">from</span> . <span class="keyword">import</span> policy</span><br><span class="line">                     <span class="keyword">from</span> . <span class="keyword">import</span> versions</span><br><span class="line"></span><br><span class="line">│   ├── policy.py</span><br><span class="line"></span><br><span class="line">│   └── versions.py</span><br><span class="line"></span><br><span class="line">├── cmd              <span class="keyword">from</span> . <span class="keyword">import</span> manage</span><br><span class="line"></span><br><span class="line">│   ├── __init__.py</span><br><span class="line"></span><br><span class="line">│   └── manage.py    <span class="keyword">from</span> ..api <span class="keyword">import</span> policy   </span><br><span class="line">                     <span class="comment">#..表示上一级目录，想再manage中使用policy中的方法就需要回到上一级glance目录往下找api包，从api导入policy</span></span><br><span class="line"></span><br><span class="line">└── db               <span class="keyword">from</span> . <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line">    ├── __init__.py</span><br><span class="line"></span><br><span class="line">    └── models.py</span><br></pre></td></tr></table></figure>

<h3 id="七、单独导入包"><a href="#七、单独导入包" class="headerlink" title="七、单独导入包"></a>七、单独导入包</h3><p>单独导入包名称时不会导入包中所有包含的所有子模块，如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在与glance同级的test.py中</span></span><br><span class="line"><span class="keyword">import</span> glance</span><br><span class="line">glance.cmd.manage.main()</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">执行结果：</span></span><br><span class="line"><span class="string">AttributeError: module 'glance' has no attribute 'cmd'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>

<p>解决方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#glance/__init__.py</span></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> cmd</span><br><span class="line"> </span><br><span class="line"><span class="comment">#glance/cmd/__init__.py</span></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> manage</span><br></pre></td></tr></table></figure>

<p>执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在于glance同级的test.py中</span></span><br><span class="line"><span class="keyword">import</span> glance</span><br><span class="line">glance.cmd.manage.main()</span><br></pre></td></tr></table></figure>

<p>千万别问：__all__不能解决吗，__all__是用于控制from…import *</p>
<p>import glance之后直接调用模块中的方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">glance/                   </span><br><span class="line"></span><br><span class="line">├── __init__.py     <span class="keyword">from</span> .api <span class="keyword">import</span> *</span><br><span class="line">                    <span class="keyword">from</span> .cmd <span class="keyword">import</span> *</span><br><span class="line">                    <span class="keyword">from</span> .db <span class="keyword">import</span> *    </span><br><span class="line">├── api                  </span><br><span class="line"></span><br><span class="line">│   ├── __init__.py   __all__ = [<span class="string">'policy'</span>,<span class="string">'versions'</span>] </span><br><span class="line"></span><br><span class="line">│   ├── policy.py</span><br><span class="line"></span><br><span class="line">│   └── versions.py</span><br><span class="line"></span><br><span class="line">├── cmd               __all__ = [<span class="string">'manage'</span>]    </span><br><span class="line"></span><br><span class="line">│   ├── __init__.py</span><br><span class="line"></span><br><span class="line">│   └── manage.py    </span><br><span class="line"></span><br><span class="line">└── db                __all__ = [<span class="string">'models'</span>]              </span><br><span class="line"></span><br><span class="line">    ├── __init__.py</span><br><span class="line"></span><br><span class="line">    └── models.py</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> glance</span><br><span class="line">policy.get()</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> glance</span><br></pre></td></tr></table></figure>

<h2 id="（三）软件开发规范"><a href="#（三）软件开发规范" class="headerlink" title="（三）软件开发规范"></a>（三）软件开发规范</h2><p><img src="https://images2017.cnblogs.com/blog/827651/201708/827651-20170809105059949-1199069919.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#=============&gt;bin目录：存放执行脚本</span></span><br><span class="line"><span class="comment">#start.py</span></span><br><span class="line"><span class="keyword">import</span> sys,os</span><br><span class="line"></span><br><span class="line">BASE_DIR=os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">sys.path.append(BASE_DIR)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> core <span class="keyword">import</span> core</span><br><span class="line"><span class="keyword">from</span> conf <span class="keyword">import</span> my_log_settings</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    my_log_settings.load_my_logging_cfg()</span><br><span class="line">    core.run()</span><br><span class="line"></span><br><span class="line"><span class="comment">#=============&gt;conf目录：存放配置文件</span></span><br><span class="line"><span class="comment">#config.ini</span></span><br><span class="line">[DEFAULT]</span><br><span class="line">user_timeout = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">[egon]</span><br><span class="line">password = <span class="number">123</span></span><br><span class="line">money = <span class="number">10000000</span></span><br><span class="line"></span><br><span class="line">[alex]</span><br><span class="line">password = alex3714</span><br><span class="line">money=<span class="number">10000000000</span></span><br><span class="line"></span><br><span class="line">[yuanhao]</span><br><span class="line">password = ysb123</span><br><span class="line">money=<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#settings.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">config_path=<span class="string">r'%s\%s'</span> %(os.path.dirname(os.path.abspath(__file__)),<span class="string">'config.ini'</span>)</span><br><span class="line">user_timeout=<span class="number">10</span></span><br><span class="line">user_db_path=<span class="string">r'%s\%s'</span> %(os.path.dirname(os.path.dirname(os.path.abspath(__file__))),\</span><br><span class="line">                     <span class="string">'db'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#my_log_settings.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">logging配置</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义三种日志输出格式 开始</span></span><br><span class="line"></span><br><span class="line">standard_format = <span class="string">'[%(asctime)s][%(threadName)s:%(thread)d][task_id:%(name)s][%(filename)s:%(lineno)d]'</span> \</span><br><span class="line">                  <span class="string">'[%(levelname)s][%(message)s]'</span> <span class="comment">#其中name为getlogger指定的名字</span></span><br><span class="line"></span><br><span class="line">simple_format = <span class="string">'[%(levelname)s][%(asctime)s][%(filename)s:%(lineno)d]%(message)s'</span></span><br><span class="line"></span><br><span class="line">id_simple_format = <span class="string">'[%(levelname)s][%(asctime)s] %(message)s'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义日志输出格式 结束</span></span><br><span class="line"></span><br><span class="line">logfile_dir = <span class="string">r'%s\log'</span> %os.path.dirname(os.path.dirname(os.path.abspath(__file__)))  <span class="comment"># log文件的目录</span></span><br><span class="line"></span><br><span class="line">logfile_name = <span class="string">'all2.log'</span>  <span class="comment"># log文件名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果不存在定义的日志目录就创建一个</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(logfile_dir):</span><br><span class="line">    os.mkdir(logfile_dir)</span><br><span class="line"></span><br><span class="line"><span class="comment"># log文件的全路径</span></span><br><span class="line">logfile_path = os.path.join(logfile_dir, logfile_name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># log配置字典</span></span><br><span class="line">LOGGING_DIC = &#123;</span><br><span class="line">    <span class="string">'version'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'disable_existing_loggers'</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">'formatters'</span>: &#123;</span><br><span class="line">        <span class="string">'standard'</span>: &#123;</span><br><span class="line">            <span class="string">'format'</span>: standard_format</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'simple'</span>: &#123;</span><br><span class="line">            <span class="string">'format'</span>: simple_format</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'filters'</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">'handlers'</span>: &#123;</span><br><span class="line">        <span class="comment">#打印到终端的日志</span></span><br><span class="line">        <span class="string">'console'</span>: &#123;</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.StreamHandler'</span>,  <span class="comment"># 打印到屏幕</span></span><br><span class="line">            <span class="string">'formatter'</span>: <span class="string">'simple'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">#打印到文件的日志,收集info及以上的日志</span></span><br><span class="line">        <span class="string">'default'</span>: &#123;</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.handlers.RotatingFileHandler'</span>,  <span class="comment"># 保存到文件</span></span><br><span class="line">            <span class="string">'formatter'</span>: <span class="string">'standard'</span>,</span><br><span class="line">            <span class="string">'filename'</span>: logfile_path,  <span class="comment"># 日志文件</span></span><br><span class="line">            <span class="string">'maxBytes'</span>: <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">5</span>,  <span class="comment"># 日志大小 5M</span></span><br><span class="line">            <span class="string">'backupCount'</span>: <span class="number">5</span>,</span><br><span class="line">            <span class="string">'encoding'</span>: <span class="string">'utf-8'</span>,  <span class="comment"># 日志文件的编码，再也不用担心中文log乱码了</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'loggers'</span>: &#123;</span><br><span class="line">        <span class="comment">#logging.getLogger(__name__)拿到的logger配置</span></span><br><span class="line">        <span class="string">''</span>: &#123;</span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'default'</span>, <span class="string">'console'</span>],  <span class="comment"># 这里把上面定义的两个handler都加上，即log数据既写入文件又打印到屏幕</span></span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">            <span class="string">'propagate'</span>: <span class="literal">True</span>,  <span class="comment"># 向上（更高level的logger）传递</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_my_logging_cfg</span><span class="params">()</span>:</span></span><br><span class="line">    logging.config.dictConfig(LOGGING_DIC)  <span class="comment"># 导入上面定义的logging配置</span></span><br><span class="line">    logger = logging.getLogger(__name__)  <span class="comment"># 生成一个log实例</span></span><br><span class="line">    logger.info(<span class="string">'It works!'</span>)  <span class="comment"># 记录该文件的运行状态</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    load_my_logging_cfg()</span><br><span class="line"></span><br><span class="line"><span class="comment">#=============&gt;core目录：存放核心逻辑</span></span><br><span class="line"><span class="comment">#core.py</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> lib <span class="keyword">import</span> read_ini</span><br><span class="line"></span><br><span class="line">config=read_ini.read(settings.config_path)</span><br><span class="line">logger=logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line">current_user=&#123;<span class="string">'user'</span>:<span class="literal">None</span>,<span class="string">'login_time'</span>:<span class="literal">None</span>,<span class="string">'timeout'</span>:int(settings.user_timeout)&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auth</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> current_user[<span class="string">'user'</span>]:</span><br><span class="line">            interval=time.time()-current_user[<span class="string">'login_time'</span>]</span><br><span class="line">            <span class="keyword">if</span> interval &lt; current_user[<span class="string">'timeout'</span>]:</span><br><span class="line">                <span class="keyword">return</span> func(*args,**kwargs)</span><br><span class="line">        name = input(<span class="string">'name&gt;&gt;: '</span>)</span><br><span class="line">        password = input(<span class="string">'password&gt;&gt;: '</span>)</span><br><span class="line">        <span class="keyword">if</span> config.has_section(name):</span><br><span class="line">            <span class="keyword">if</span> password == config.get(name,<span class="string">'password'</span>):</span><br><span class="line">                logger.info(<span class="string">'登录成功'</span>)</span><br><span class="line">                current_user[<span class="string">'user'</span>]=name</span><br><span class="line">                current_user[<span class="string">'login_time'</span>]=time.time()</span><br><span class="line">                <span class="keyword">return</span> func(*args,**kwargs)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.error(<span class="string">'用户名不存在'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@auth</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'buy...'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@auth</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">'''</span></span><br><span class="line"><span class="string">购物</span></span><br><span class="line"><span class="string">查看余额</span></span><br><span class="line"><span class="string">转账</span></span><br><span class="line"><span class="string">    '''</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        choice = input(<span class="string">'&gt;&gt;: '</span>).strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> choice:<span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> choice == <span class="string">'1'</span>:</span><br><span class="line">            buy()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    run()</span><br><span class="line"></span><br><span class="line"><span class="comment">#=============&gt;db目录：存放数据库文件</span></span><br><span class="line"><span class="comment">#alex_json</span></span><br><span class="line"><span class="comment">#egon_json</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#=============&gt;lib目录：存放自定义的模块与包</span></span><br><span class="line"><span class="comment">#read_ini.py</span></span><br><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(config_file)</span>:</span></span><br><span class="line">    config=configparser.ConfigParser()</span><br><span class="line">    config.read(config_file)</span><br><span class="line">    <span class="keyword">return</span> config</span><br><span class="line"></span><br><span class="line"><span class="comment">#=============&gt;log目录：存放日志</span></span><br><span class="line"><span class="comment">#all2.log</span></span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">40</span>,<span class="number">272</span>][MainThread:<span class="number">11692</span>][task_id:conf.my_log_settings][my_log_settings.py:<span class="number">75</span>][INFO][It works!]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">41</span>,<span class="number">789</span>][MainThread:<span class="number">11692</span>][task_id:core.core][core.py:<span class="number">25</span>][ERROR][用户名不存在]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">46</span>,<span class="number">394</span>][MainThread:<span class="number">12348</span>][task_id:conf.my_log_settings][my_log_settings.py:<span class="number">75</span>][INFO][It works!]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">47</span>,<span class="number">629</span>][MainThread:<span class="number">12348</span>][task_id:core.core][core.py:<span class="number">25</span>][ERROR][用户名不存在]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">31</span>:<span class="number">57</span>,<span class="number">912</span>][MainThread:<span class="number">10528</span>][task_id:conf.my_log_settings][my_log_settings.py:<span class="number">75</span>][INFO][It works!]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">32</span>:<span class="number">03</span>,<span class="number">340</span>][MainThread:<span class="number">12744</span>][task_id:conf.my_log_settings][my_log_settings.py:<span class="number">75</span>][INFO][It works!]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">32</span>:<span class="number">05</span>,<span class="number">065</span>][MainThread:<span class="number">12916</span>][task_id:conf.my_log_settings][my_log_settings.py:<span class="number">75</span>][INFO][It works!]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">32</span>:<span class="number">08</span>,<span class="number">181</span>][MainThread:<span class="number">12916</span>][task_id:core.core][core.py:<span class="number">25</span>][ERROR][用户名不存在]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">32</span>:<span class="number">13</span>,<span class="number">638</span>][MainThread:<span class="number">7220</span>][task_id:conf.my_log_settings][my_log_settings.py:<span class="number">75</span>][INFO][It works!]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">32</span>:<span class="number">23</span>,<span class="number">005</span>][MainThread:<span class="number">7220</span>][task_id:core.core][core.py:<span class="number">20</span>][INFO][登录成功]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">32</span>:<span class="number">40</span>,<span class="number">941</span>][MainThread:<span class="number">7220</span>][task_id:core.core][core.py:<span class="number">20</span>][INFO][登录成功]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">32</span>:<span class="number">47</span>,<span class="number">222</span>][MainThread:<span class="number">7220</span>][task_id:core.core][core.py:<span class="number">20</span>][INFO][登录成功]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">32</span>:<span class="number">51</span>,<span class="number">949</span>][MainThread:<span class="number">7220</span>][task_id:core.core][core.py:<span class="number">25</span>][ERROR][用户名不存在]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">33</span>:<span class="number">00</span>,<span class="number">213</span>][MainThread:<span class="number">7220</span>][task_id:core.core][core.py:<span class="number">20</span>][INFO][登录成功]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">33</span>:<span class="number">50</span>,<span class="number">118</span>][MainThread:<span class="number">8500</span>][task_id:conf.my_log_settings][my_log_settings.py:<span class="number">75</span>][INFO][It works!]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">33</span>:<span class="number">55</span>,<span class="number">845</span>][MainThread:<span class="number">8500</span>][task_id:core.core][core.py:<span class="number">20</span>][INFO][登录成功]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">34</span>:<span class="number">06</span>,<span class="number">837</span>][MainThread:<span class="number">8500</span>][task_id:core.core][core.py:<span class="number">25</span>][ERROR][用户名不存在]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">34</span>:<span class="number">09</span>,<span class="number">405</span>][MainThread:<span class="number">8500</span>][task_id:core.core][core.py:<span class="number">25</span>][ERROR][用户名不存在]</span><br><span class="line">[<span class="number">2017</span><span class="number">-07</span><span class="number">-29</span> <span class="number">00</span>:<span class="number">34</span>:<span class="number">10</span>,<span class="number">645</span>][MainThread:<span class="number">8500</span>][task_id:core.core][core.py:<span class="number">25</span>][ERROR][用户名不存在]</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/08/python全栈/第01部分：基础+模块+面向对象+网络编程/模块/常用模块（二）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/08/python全栈/第01部分：基础+模块+面向对象+网络编程/模块/常用模块（二）/" itemprop="url">常用模块（二）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-08T18:11:31+08:00">
                2019-08-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python全栈-01部分-模块和包/" itemprop="url" rel="index">
                    <span itemprop="name">python全栈 -01部分 -模块和包</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="（三）常用模块（二）"><a href="#（三）常用模块（二）" class="headerlink" title="（三）常用模块（二）"></a>（三）常用模块（二）</h2><h3 id="一、hashlib模块"><a href="#一、hashlib模块" class="headerlink" title="一、hashlib模块"></a>一、hashlib模块</h3><h4 id="1、算法介绍"><a href="#1、算法介绍" class="headerlink" title="1、算法介绍"></a>1、算法介绍</h4><p>​        Python的hashlib提供了常见的摘要算法，如MD5，SHA1等等。</p>
<p>​        什么是摘要算法呢？摘要算法又称哈希算法、散列算法。它通过一个函数，把任意长度的数据转换为一个长度固定的数据串（通常用16进制的字符串表示）。</p>
<p>​        摘要算法就是通过摘要函数f()对任意长度的数据data计算出固定长度的摘要digest，目的是为了发现原始数据是否被人篡改过。</p>
<p>​        摘要算法之所以能指出数据是否被篡改过，就是因为摘要函数是一个单向函数，计算f(data)很容易，但通过digest反推data却非常困难。而且，对原始数据做一个bit的修改，都会导致计算出的摘要完全不同。</p>
<p>我们以常见的摘要算法MD5为例，计算出一个字符串的MD5值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"> </span><br><span class="line">md5 = hashlib.md5()</span><br><span class="line">md5.update(<span class="string">'how to use md5 in python hashlib?'</span>)</span><br><span class="line"><span class="keyword">print</span> md5.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">计算结果如下：</span></span><br><span class="line"><span class="string">d26a53750bc40b38b65a520292f69306</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>

<p>如果数据量很大，可以分块多次调用update()，最后计算的结果是一样的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">md5 = hashlib.md5()</span><br><span class="line">md5.update(<span class="string">'how to use md5 in '</span>)</span><br><span class="line">md5.update(<span class="string">'python hashlib?'</span>)</span><br><span class="line"><span class="keyword">print</span> md5.hexdigest()</span><br></pre></td></tr></table></figure>

<p>MD5是最常见的摘要算法，速度很快，生成结果是固定的128 bit字节，通常用一个32位的16进制字符串表示。另一种常见的摘要算法是SHA1，调用SHA1和调用MD5完全类似：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"> </span><br><span class="line">sha1 = hashlib.sha1()</span><br><span class="line">sha1.update(<span class="string">'how to use sha1 in '</span>)</span><br><span class="line">sha1.update(<span class="string">'python hashlib?'</span>)</span><br><span class="line"><span class="keyword">print</span> sha1.hexdigest()</span><br></pre></td></tr></table></figure>

<p>SHA1的结果是160 bit字节，通常用一个40位的16进制字符串表示。比SHA1更安全的算法是SHA256和SHA512，不过越安全的算法越慢，而且摘要长度更长。</p>
<h4 id="2、摘要算法应用"><a href="#2、摘要算法应用" class="headerlink" title="2、摘要算法应用"></a>2、摘要算法应用</h4><p>任何允许用户登录的网站都会存储用户登录的用户名和口令。如何存储用户名和口令呢？方法是存到数据库表中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">name    | password</span><br><span class="line">--------+----------</span><br><span class="line">michael | 123456</span><br><span class="line">bob     | abc999</span><br><span class="line">alice   | alice2008</span><br></pre></td></tr></table></figure>

<p>​        如果以明文保存用户口令，如果数据库泄露，所有用户的口令就落入黑客的手里。此外，网站运维人员是可以访问数据库的，也就是能获取到所有用户的口令。正确的保存口令的方式是不存储用户的明文口令，而是存储用户口令的摘要，比如MD5：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">username | password</span><br><span class="line">---------+---------------------------------</span><br><span class="line">michael  | e10adc3949ba59abbe56e057f20f883e</span><br><span class="line">bob      | 878ef96e86145580c38c87f0410ad153</span><br><span class="line">alice    | 99b1c2188db85afee403b1536010c2c9</span><br></pre></td></tr></table></figure>

<p>​        考虑这么个情况，很多用户喜欢用123456，888888，password这些简单的口令，于是，黑客可以事先计算出这些常用口令的MD5值，得到一个反推表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'e10adc3949ba59abbe56e057f20f883e'</span>: <span class="string">'123456'</span></span><br><span class="line"><span class="string">'21218cca77804d2ba1922c33e0151105'</span>: <span class="string">'888888'</span></span><br><span class="line"><span class="string">'5f4dcc3b5aa765d61d8327deb882cf99'</span>: <span class="string">'password'</span></span><br></pre></td></tr></table></figure>

<p>​        这样，无需破解，只需要对比数据库的MD5，黑客就获得了使用常用口令的用户账号。</p>
<p>​        对于用户来讲，当然不要使用过于简单的口令。但是，我们能否在程序设计上对简单口令加强保护呢？</p>
<p>​        由于常用口令的MD5值很容易被计算出来，所以，要确保存储的用户口令不是那些已经被计算出来的常用口令的MD5，这一方法通过对原始口令加一个复杂字符串来实现，俗称“加盐”：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashlib.md5(<span class="string">"salt"</span>.encode(<span class="string">"utf8"</span>))</span><br></pre></td></tr></table></figure>

<p>​        经过Salt处理的MD5口令，只要Salt不被黑客知道，即使用户输入简单口令，也很难通过MD5反推明文口令。</p>
<p>​        但是如果有两个用户都使用了相同的简单口令比如123456，在数据库中，将存储两条相同的MD5值，这说明这两个用户的口令是一样的。有没有办法让使用相同口令的用户存储不同的MD5呢？</p>
<p>​        如果假定用户无法修改登录名，就可以通过把登录名作为Salt的一部分来计算MD5，从而实现相同口令的用户也存储不同的MD5。</p>
<p>​        摘要算法在很多地方都有广泛的应用。要注意摘要算法不是加密算法，不能用于加密（因为无法通过摘要反推明文），只能用于防篡改，但是它的单向计算特性决定了可以在不存储明文口令的情况下验证用户口令。</p>
<h3 id="二、configparser模块"><a href="#二、configparser模块" class="headerlink" title="二、configparser模块"></a>二、configparser模块</h3><p>​        该模块适用于配置文件的格式与windows ini文件类似，可以包含一个或多个节（section），每个节可以有多个参数（键=值）。</p>
<h4 id="1、创建文件"><a href="#1、创建文件" class="headerlink" title="1、创建文件"></a>1、创建文件</h4><p><strong>来看一个好多软件的常见文档格式如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">ServerAliveInterval = <span class="number">45</span></span><br><span class="line">Compression = yes</span><br><span class="line">CompressionLevel = <span class="number">9</span></span><br><span class="line">ForwardX11 = yes</span><br><span class="line">  </span><br><span class="line">[bitbucket.org]</span><br><span class="line">User = hg</span><br><span class="line">  </span><br><span class="line">[topsecret.server.com]</span><br><span class="line">Port = <span class="number">50022</span></span><br><span class="line">ForwardX11 = no</span><br></pre></td></tr></table></figure>

<p>如果想用python生成一个这样的文档怎么做呢？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line"></span><br><span class="line">config = configparser.ConfigParser()</span><br><span class="line"></span><br><span class="line">config[<span class="string">"DEFAULT"</span>] = &#123;<span class="string">'ServerAliveInterval'</span>: <span class="string">'45'</span>,</span><br><span class="line">                      <span class="string">'Compression'</span>: <span class="string">'yes'</span>,</span><br><span class="line">                     <span class="string">'CompressionLevel'</span>: <span class="string">'9'</span>,</span><br><span class="line">                     <span class="string">'ForwardX11'</span>:<span class="string">'yes'</span></span><br><span class="line">                     &#125;</span><br><span class="line"></span><br><span class="line">config[<span class="string">'bitbucket.org'</span>] = &#123;<span class="string">'User'</span>:<span class="string">'hg'</span>&#125;</span><br><span class="line"></span><br><span class="line">config[<span class="string">'topsecret.server.com'</span>] = &#123;<span class="string">'Host Port'</span>:<span class="string">'50022'</span>,<span class="string">'ForwardX11'</span>:<span class="string">'no'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'example.ini'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> configfile:</span><br><span class="line"></span><br><span class="line">   config.write(configfile)</span><br></pre></td></tr></table></figure>

<h4 id="2、查找文件"><a href="#2、查找文件" class="headerlink" title="2、查找文件"></a>2、查找文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line"></span><br><span class="line">config = configparser.ConfigParser()</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------查找文件内容,基于字典的形式</span></span><br><span class="line"></span><br><span class="line">print(config.sections())        <span class="comment">#  []</span></span><br><span class="line"></span><br><span class="line">config.read(<span class="string">'example.ini'</span>)</span><br><span class="line"></span><br><span class="line">print(config.sections())        <span class="comment">#   ['bitbucket.org', 'topsecret.server.com']</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'bytebong.com'</span> <span class="keyword">in</span> config) <span class="comment"># False</span></span><br><span class="line">print(<span class="string">'bitbucket.org'</span> <span class="keyword">in</span> config) <span class="comment"># True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(config[<span class="string">'bitbucket.org'</span>][<span class="string">"user"</span>])  <span class="comment"># hg</span></span><br><span class="line"></span><br><span class="line">print(config[<span class="string">'DEFAULT'</span>][<span class="string">'Compression'</span>]) <span class="comment">#yes</span></span><br><span class="line"></span><br><span class="line">print(config[<span class="string">'topsecret.server.com'</span>][<span class="string">'ForwardX11'</span>])  <span class="comment">#no</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(config[<span class="string">'bitbucket.org'</span>])          <span class="comment">#&lt;Section: bitbucket.org&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> config[<span class="string">'bitbucket.org'</span>]:     <span class="comment"># 注意,有default会默认default的键</span></span><br><span class="line">    print(key)</span><br><span class="line"></span><br><span class="line">print(config.options(<span class="string">'bitbucket.org'</span>))  <span class="comment"># 同for循环,找到'bitbucket.org'下所有键</span></span><br><span class="line"></span><br><span class="line">print(config.items(<span class="string">'bitbucket.org'</span>))    <span class="comment">#找到'bitbucket.org'下所有键值对</span></span><br><span class="line"></span><br><span class="line">print(config.get(<span class="string">'bitbucket.org'</span>,<span class="string">'compression'</span>)) <span class="comment"># yes       get方法Section下的key对应的value</span></span><br></pre></td></tr></table></figure>

<h4 id="3、增删改操作"><a href="#3、增删改操作" class="headerlink" title="3、增删改操作"></a>3、增删改操作</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line"></span><br><span class="line">config = configparser.ConfigParser()</span><br><span class="line"></span><br><span class="line">config.read(<span class="string">'example.ini'</span>)</span><br><span class="line"></span><br><span class="line">config.add_section(<span class="string">'yuan'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">config.remove_section(<span class="string">'bitbucket.org'</span>)</span><br><span class="line">config.remove_option(<span class="string">'topsecret.server.com'</span>,<span class="string">"forwardx11"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">config.set(<span class="string">'topsecret.server.com'</span>,<span class="string">'k1'</span>,<span class="string">'11111'</span>)</span><br><span class="line">config.set(<span class="string">'yuan'</span>,<span class="string">'k2'</span>,<span class="string">'22222'</span>)</span><br><span class="line"></span><br><span class="line">config.write(open(<span class="string">'new2.ini'</span>, <span class="string">"w"</span>))</span><br></pre></td></tr></table></figure>

<h3 id="三、logging模块"><a href="#三、logging模块" class="headerlink" title="三、logging模块"></a>三、logging模块</h3><h4 id="1、函数式简单配置"><a href="#1、函数式简单配置" class="headerlink" title="1、函数式简单配置"></a>1、函数式简单配置</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging  </span><br><span class="line">logging.debug(<span class="string">'debug message'</span>)  </span><br><span class="line">logging.info(<span class="string">'info message'</span>)  </span><br><span class="line">logging.warning(<span class="string">'warning message'</span>)  </span><br><span class="line">logging.error(<span class="string">'error message'</span>)  </span><br><span class="line">logging.critical(<span class="string">'critical message'</span>)</span><br></pre></td></tr></table></figure>

<p>默认情况下Python的logging模块将日志打印到了标准输出中，且只显示了大于等于WARNING级别的日志，这说明默认的日志级别设置为WARNING（日志级别等级CRITICAL &gt; ERROR &gt; WARNING &gt; INFO &gt; DEBUG），默认的日志格式为日志级别：Logger名称：用户输出消息。</p>
<p><strong>灵活配置日志级别，日志格式，输出位置:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">file_handler = logging.FileHandler(filename=<span class="string">'x1.log'</span>, mode=<span class="string">'a'</span>, encoding=<span class="string">'utf-8'</span>,)</span><br><span class="line">logging.basicConfig(</span><br><span class="line">    format=<span class="string">'%(asctime)s - %(name)s - %(levelname)s -%(module)s:  %(message)s'</span>,</span><br><span class="line">    datefmt=<span class="string">'%Y-%m-%d %H:%M:%S %p'</span>,</span><br><span class="line">    handlers=[file_handler,],</span><br><span class="line">    level=logging.ERROR</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">logging.error(<span class="string">'你好'</span>)</span><br></pre></td></tr></table></figure>

<p><strong>日志切割</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> handlers</span><br><span class="line"></span><br><span class="line">sh = logging.StreamHandler()</span><br><span class="line">rh = handlers.RotatingFileHandler(<span class="string">'myapp.log'</span>, maxBytes=<span class="number">1024</span>,backupCount=<span class="number">5</span>)</span><br><span class="line">fh = handlers.TimedRotatingFileHandler(filename=<span class="string">'x2.log'</span>, when=<span class="string">'s'</span>, interval=<span class="number">5</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">logging.basicConfig(</span><br><span class="line">    format=<span class="string">'%(asctime)s - %(name)s - %(levelname)s -%(module)s:  %(message)s'</span>,</span><br><span class="line">    datefmt=<span class="string">'%Y-%m-%d %H:%M:%S %p'</span>,</span><br><span class="line">    handlers=[fh,sh,rh],</span><br><span class="line">    level=logging.ERROR</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100000</span>):</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    logging.error(<span class="string">'KeyboardInterrupt error %s'</span>%str(i))</span><br></pre></td></tr></table></figure>

<p><strong>配置参数</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">logging.basicConfig()函数中可通过具体参数来更改logging模块默认行为，可用参数有：</span><br><span class="line"></span><br><span class="line">filename：用指定的文件名创建FiledHandler，这样日志会被存储在指定的文件中。</span><br><span class="line">filemode：文件打开方式，在指定了filename时使用这个参数，默认值为“a”还可指定为“w”。</span><br><span class="line">format：指定handler使用的日志显示格式。</span><br><span class="line">datefmt：指定日期时间格式。</span><br><span class="line">level：设置rootlogger（后边会讲解具体概念）的日志级别</span><br><span class="line">stream：用指定的stream创建StreamHandler。可以指定输出到sys.stderr,sys.stdout或者文件(f=open(‘test.log’,’w’))，默认为sys.stderr。若同时列出了filename和stream两个参数，则stream参数会被忽略。</span><br><span class="line"></span><br><span class="line">format参数中可能用到的格式化串：</span><br><span class="line">%(name)s Logger的名字</span><br><span class="line">%(levelno)s 数字形式的日志级别</span><br><span class="line">%(levelname)s 文本形式的日志级别</span><br><span class="line">%(pathname)s 调用日志输出函数的模块的完整路径名，可能没有</span><br><span class="line">%(filename)s 调用日志输出函数的模块的文件名</span><br><span class="line">%(module)s 调用日志输出函数的模块名</span><br><span class="line">%(funcName)s 调用日志输出函数的函数名</span><br><span class="line">%(lineno)d 调用日志输出函数的语句所在的代码行</span><br><span class="line">%(created)f 当前时间，用UNIX标准的表示时间的浮 点数表示</span><br><span class="line">%(relativeCreated)d 输出日志信息时的，自Logger创建以 来的毫秒数</span><br><span class="line">%(asctime)s 字符串形式的当前时间。默认格式是 “<span class="number">2003</span><span class="number">-07</span><span class="number">-08</span> <span class="number">16</span>:<span class="number">49</span>:<span class="number">45</span>,<span class="number">896</span>”。逗号后面的是毫秒</span><br><span class="line">%(thread)d 线程ID。可能没有</span><br><span class="line">%(threadName)s 线程名。可能没有</span><br><span class="line">%(process)d 进程ID。可能没有</span><br><span class="line">%(message)s用户输出的消息</span><br></pre></td></tr></table></figure>

<h4 id="2、logger对象配置"><a href="#2、logger对象配置" class="headerlink" title="2、logger对象配置"></a>2、logger对象配置</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger()</span><br><span class="line"><span class="comment"># 创建一个handler，用于写入日志文件</span></span><br><span class="line">fh = logging.FileHandler(<span class="string">'test.log'</span>,encoding=<span class="string">'utf-8'</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 再创建一个handler，用于输出到控制台 </span></span><br><span class="line">ch = logging.StreamHandler() </span><br><span class="line">formatter = logging.Formatter(<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line"></span><br><span class="line">fh.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">fh.setFormatter(formatter) </span><br><span class="line">ch.setFormatter(formatter) </span><br><span class="line">logger.addHandler(fh) <span class="comment">#logger对象可以添加多个fh和ch对象 </span></span><br><span class="line">logger.addHandler(ch) </span><br><span class="line"></span><br><span class="line">logger.debug(<span class="string">'logger debug message'</span>) </span><br><span class="line">logger.info(<span class="string">'logger info message'</span>) </span><br><span class="line">logger.warning(<span class="string">'logger warning message'</span>) </span><br><span class="line">logger.error(<span class="string">'logger error message'</span>) </span><br><span class="line">logger.critical(<span class="string">'logger critical message'</span>)</span><br></pre></td></tr></table></figure>

<p>​        logging库提供了多个组件：Logger、Handler、Filter、Formatter。Logger对象提供应用程序可直接使用的接口，Handler发送日志到适当的目的地，Filter提供了过滤日志信息的方法，Formatter指定日志显示格式。另外，可以通过：</p>
<p>logger.setLevel(logging.Debug)设置级别,</p>
<p>当然，也可以通过</p>
<p>fh.setLevel(logging.Debug)单对文件流设置某个级别。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/08/python全栈/第02部分：并发编程+数据库+前端/并发编程/线程（二）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/08/python全栈/第02部分：并发编程+数据库+前端/并发编程/线程（二）/" itemprop="url">线程（二）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-08T07:39:55+08:00">
                2019-08-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python全栈-02部分-并发编程/" itemprop="url" rel="index">
                    <span itemprop="name">python全栈 -02部分 -并发编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h2 id="（二）线程和python"><a href="#（二）线程和python" class="headerlink" title="（二）线程和python"></a>（二）线程和python</h2><h3 id="一、理论知识"><a href="#一、理论知识" class="headerlink" title="一、理论知识"></a>一、理论知识</h3><h4 id="1、全局解释器锁GIL（Cpython解释器下）"><a href="#1、全局解释器锁GIL（Cpython解释器下）" class="headerlink" title="1、全局解释器锁GIL（Cpython解释器下）"></a>1、全局解释器锁GIL（Cpython解释器下）</h4><p>​        Python代码的执行由Python虚拟机(也叫解释器主循环)来控制。Python在设计之初就考虑到要在主循环中，同时只有一个线程在执行。虽然 Python 解释器中可以“运行”多个线程，但在任意时刻只有一个线程在解释器中运行。<br>　　对Python虚拟机的访问由全局解释器锁(GIL)来控制，正是这个锁能保证同一时刻只有一个线程在运行。</p>
<p>　　在多线程环境中，Python 虚拟机按以下方式执行：</p>
<p>　　a、设置 GIL；</p>
<p>　　b、切换到一个线程去运行；</p>
<p>　　c、运行指定数量的字节码指令或者线程主动让出控制(可以调用 time.sleep(0))；</p>
<p>　　d、把线程设置为睡眠状态；</p>
<p>　　e、解锁 GIL；</p>
<p>　　d、再次重复以上所有步骤。<br>　　在调用外部代码(如 C/C++扩展函数)的时候，GIL将会被锁定，直到这个函数结束为止(由于在这期间没有Python的字节码被运行，所以不会做线程切换)编写扩展的程序员可以主动解锁GIL。</p>
<h4 id="2、python线程模块的选择"><a href="#2、python线程模块的选择" class="headerlink" title="2、python线程模块的选择"></a>2、python线程模块的选择</h4><p>​        Python提供了几个用于多线程编程的模块，包括thread、threading和Queue等。thread和threading模块允许程序员创建和管理线程。thread模块提供了基本的线程和锁的支持，threading提供了更高级别、功能更强的线程管理的功能。Queue模块允许用户创建一个可以用于多个线程之间共享数据的队列数据结构。<br>　　避免使用thread模块，因为更高级别的threading模块更为先进，对线程的支持更为完善，而且使用thread模块里的属性有可能会与threading出现冲突；其次低级别的thread模块的同步原语很少(实际上只有一个)，而threading模块则有很多；再者，thread模块中当主线程结束时，所有的线程都会被强制结束掉，没有警告也不会有正常的清除工作，至少threading模块能确保重要的子线程退出后进程才退出。 </p>
<p>　　thread模块不支持守护线程，当主线程退出时，所有的子线程不论它们是否还在工作，都会被强行退出。而threading模块支持守护线程，守护线程一般是一个等待客户请求的服务器，如果没有客户提出请求它就在那等着，如果设定一个线程为守护线程，就表示这个线程是不重要的，在进程退出的时候，不用等待这个线程退出。</p>
<h3 id="二、threading模块"><a href="#二、threading模块" class="headerlink" title="二、threading模块"></a>二、threading模块</h3><p>multiprocess模块的完全模仿了threading模块的接口，二者在使用层面，有很大的相似性，因而不再详细介绍（<a href="https://docs.python.org/3/library/threading.html?highlight=threading#" target="_blank" rel="noopener">官方链接</a>）</p>
<h4 id="1、线程的创建-Threading-Thread类"><a href="#1、线程的创建-Threading-Thread类" class="headerlink" title="1、线程的创建 Threading.Thread类"></a>1、线程的创建 Threading.Thread类</h4><h5 id="（1）线程的创建"><a href="#（1）线程的创建" class="headerlink" title="（1）线程的创建"></a>（1）线程的创建</h5><p>创建线程的方式1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(n)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(n)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    t = Thread(target=func, args=(i,))</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure>

<p>创建线程的方式2</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTread</span><span class="params">(Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, arg)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.arg = arg</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        print(self.arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    t = MyTread(i)</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure>

<h5 id="（2）多线程与多进程"><a href="#（2）多线程与多进程" class="headerlink" title="（2）多线程与多进程"></a>（2）多线程与多进程</h5><p>pid的比较</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'hello'</span>,os.getpid())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment">#part1:在主进程下开启多个线程,每个线程都跟主进程的pid一样</span></span><br><span class="line">    t1=Thread(target=work)</span><br><span class="line">    t2=Thread(target=work)</span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br><span class="line">    print(<span class="string">'主线程/主进程pid'</span>,os.getpid())</span><br><span class="line"></span><br><span class="line">    <span class="comment">#part2:开多个进程,每个进程都有不同的pid</span></span><br><span class="line">    p1=Process(target=work)</span><br><span class="line">    p2=Process(target=work)</span><br><span class="line">    p1.start()</span><br><span class="line">    p2.start()</span><br><span class="line">    print(<span class="string">'主线程/主进程pid'</span>,os.getpid())</span><br></pre></td></tr></table></figure>

<p>开启效率的较量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(n)</span>:</span></span><br><span class="line">    n + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    start = time.time()</span><br><span class="line">    t_lst = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        t = Thread(target=func,args=(i,))</span><br><span class="line">        t.start()</span><br><span class="line">        t_lst.append(t)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> t_lst:t.join()</span><br><span class="line">    t1 = time.time() - start</span><br><span class="line"></span><br><span class="line">    start = time.time()</span><br><span class="line">    t_lst = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        t = Process(target=func, args=(i,))</span><br><span class="line">        t.start()</span><br><span class="line">        t_lst.append(t)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> t_lst: t.join()</span><br><span class="line">    t2 = time.time() - start</span><br><span class="line">    print(t1,t2)</span><br></pre></td></tr></table></figure>

<p>内存数据的共享问题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> g</span><br><span class="line">    g = <span class="number">0</span></span><br><span class="line">    print(g,os.getpid())</span><br><span class="line"></span><br><span class="line">g = <span class="number">100</span></span><br><span class="line">t_lst = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    t = Thread(target=func,args=(i,<span class="number">5</span>))</span><br><span class="line">    t.start()</span><br><span class="line">    t_lst.append(t)</span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span>  t_lst : t.join()</span><br><span class="line">print(g)</span><br></pre></td></tr></table></figure>

<h5 id="（3）练习：多线程实现socket"><a href="#（3）练习：多线程实现socket" class="headerlink" title="（3）练习：多线程实现socket"></a>（3）练习：多线程实现socket</h5><p>server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#_*_coding:utf-8_*_</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">s.bind((<span class="string">'127.0.0.1'</span>,<span class="number">8080</span>))</span><br><span class="line">s.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">action</span><span class="params">(conn)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data=conn.recv(<span class="number">1024</span>)</span><br><span class="line">        print(data)</span><br><span class="line">        conn.send(data.upper())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        conn,addr=s.accept()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        p=threading.Thread(target=action,args=(conn,))</span><br><span class="line">        p.start()</span><br></pre></td></tr></table></figure>

<p>client</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#_*_coding:utf-8_*_</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">s.connect((<span class="string">'127.0.0.1'</span>,<span class="number">8080</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    msg=input(<span class="string">'&gt;&gt;: '</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> msg:<span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    s.send(msg.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    data=s.recv(<span class="number">1024</span>)</span><br><span class="line">    print(data)</span><br></pre></td></tr></table></figure>

<h5 id="（4）Thread类的其他方法"><a href="#（4）Thread类的其他方法" class="headerlink" title="（4）Thread类的其他方法"></a>（4）Thread类的其他方法</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Thread实例对象的方法</span><br><span class="line">  <span class="comment"># isAlive(): 返回线程是否活动的。</span></span><br><span class="line">  <span class="comment"># getName(): 返回线程名。</span></span><br><span class="line">  <span class="comment"># setName(): 设置线程名。</span></span><br><span class="line"></span><br><span class="line">threading模块提供的一些方法：</span><br><span class="line">  <span class="comment"># threading.currentThread(): 返回当前的线程变量。</span></span><br><span class="line">  <span class="comment"># threading.enumerate(): 返回一个包含正在运行的线程的list。正在运行指线程启动后、结束前，不包括启动前和终止后的线程。</span></span><br><span class="line">  <span class="comment"># threading.activeCount(): 返回正在运行的线程数量，与len(threading.enumerate())有相同的结果。</span></span><br></pre></td></tr></table></figure>

<p>代码示例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wahaha</span><span class="params">(n)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    print(n,threading.current_thread(),threading.get_ident())</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span>  range(<span class="number">10</span>):</span><br><span class="line">    threading.Thread(target=wahaha,args=(i,)).start()</span><br><span class="line">print(threading.active_count())    <span class="comment"># 10</span></span><br><span class="line">print(threading.current_thread())</span><br><span class="line">print(threading.enumerate())</span><br></pre></td></tr></table></figure>

<p>join方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sayhi</span><span class="params">(name)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">'%s say hello'</span> %name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    t=Thread(target=sayhi,args=(<span class="string">'egon'</span>,))</span><br><span class="line">    t.start()</span><br><span class="line">    t.join()</span><br><span class="line">    print(<span class="string">'主线程'</span>)</span><br><span class="line">    print(t.is_alive())</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    egon say hello</span></span><br><span class="line"><span class="string">    主线程</span></span><br><span class="line"><span class="string">    False</span></span><br><span class="line"><span class="string">    '''</span></span><br></pre></td></tr></table></figure>

<h5 id="（5）守护线程"><a href="#（5）守护线程" class="headerlink" title="（5）守护线程"></a>（5）守护线程</h5><p><strong>无论是进程还是线程，都遵循：守护xx会等待主xx运行完毕后被销毁。</strong></p>
<p><strong>需要强调的是：运行完毕并非终止运行</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.对主进程来说，运行完毕指的是主进程代码运行完毕</span></span><br><span class="line"><span class="comment">#2.对主线程来说，运行完毕指的是主线程所在的进程内所有非守护线程统统运行完毕，主线程才算运行完毕（其实 主线程会等待子线程的结束）</span></span><br></pre></td></tr></table></figure>

<p>详细解释：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1 主进程在其代码结束后就已经算运行完毕了（守护进程在此时就被回收）,然后主进程会一直等非守护的子进程都运行完毕后回收子进程的资源(否则会产生僵尸进程)，才会结束，</span></span><br><span class="line"><span class="comment">#2 主线程在其他非守护线程运行完毕后才算运行完毕（守护线程在此时就被回收）。因为主线程的结束意味着进程的结束，进程整体的资源都将被回收，而进程必须保证非守护线程都运行完毕后才能结束。</span></span><br></pre></td></tr></table></figure>

<p>守护线程例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time                 </span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">()</span>:</span>                </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:             </span><br><span class="line">        print(<span class="string">'*'</span>*<span class="number">10</span>)       </span><br><span class="line">        time.sleep(<span class="number">1</span>)       </span><br><span class="line">                            </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func2</span><span class="params">()</span>:</span>                </span><br><span class="line">    print(<span class="string">'in func2'</span>)       </span><br><span class="line">    time.sleep(<span class="number">5</span>)           </span><br><span class="line">                            </span><br><span class="line">t = Thread(target=func1,)   </span><br><span class="line">t.daemon = <span class="literal">True</span>             </span><br><span class="line">t.start()                   </span><br><span class="line">t2 = Thread(target=func2,)  </span><br><span class="line">t2.start()                  </span><br><span class="line"><span class="comment"># t2.join()                 </span></span><br><span class="line">print(<span class="string">'主线程'</span>)                </span><br><span class="line">                            </span><br><span class="line"><span class="comment"># 守护进程随着主进程代码的执行结束而结束       </span></span><br><span class="line"><span class="comment"># 守护线程会在主线程结束之后等待其他子线程的结束才结束</span></span><br></pre></td></tr></table></figure>

<h4 id="2、锁"><a href="#2、锁" class="headerlink" title="2、锁"></a>2、锁</h4><h5 id="（1）、锁与GIL"><a href="#（1）、锁与GIL" class="headerlink" title="（1）、锁与GIL"></a>（1）、锁与GIL</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">线程</span><br><span class="line">    线程是进程中的执行单位</span><br><span class="line">    线程是cpu执行的最小单位</span><br><span class="line">    线城之间资源共享</span><br><span class="line">    线程的开启和关闭以及切换的时间开销远远小于进程</span><br><span class="line">    线程本身可以在同一时间使用多个cpu</span><br><span class="line">python 与 线程</span><br><span class="line">    Cpython解释器在解释代码过程中容易产生数据不安全的问题</span><br><span class="line">    GIL 全局解释器锁 锁的是线程</span><br></pre></td></tr></table></figure>

<h5 id="（2）、同步锁"><a href="#（2）、同步锁" class="headerlink" title="（2）、同步锁"></a>（2）、同步锁</h5><p>多个线程抢占资源的情况</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> os,time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> n</span><br><span class="line">    temp=n</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)	<span class="comment"># 此处通过sleep阻断了GIL锁（模拟时间片的切换）</span></span><br><span class="line">    <span class="comment"># 虽然此处注释该语句，结果为0，但不能否认的是，有可能时间片的切换强制该线程还钥匙，计算的结果还没来得及放回</span></span><br><span class="line">    <span class="comment"># 这就是为什么有了GIL锁，数据还是不能保证彻底安全</span></span><br><span class="line">    n=temp<span class="number">-1</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    n=<span class="number">100</span></span><br><span class="line">    l=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        p=Thread(target=work)</span><br><span class="line">        l.append(p)</span><br><span class="line">        p.start()</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> l:</span><br><span class="line">        p.join()</span><br><span class="line"></span><br><span class="line">    print(n) <span class="comment">#结果可能为99</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">R=threading.Lock()</span><br><span class="line">R.acquire()</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">对公共数据的操作</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">R.release()</span><br></pre></td></tr></table></figure>

<p>同步锁的引用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread,Lock</span><br><span class="line"><span class="keyword">import</span> os,time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> n</span><br><span class="line">    lock.acquire()</span><br><span class="line">    temp=n</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    n=temp<span class="number">-1</span></span><br><span class="line">    lock.release()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    lock=Lock()</span><br><span class="line">    n=<span class="number">100</span></span><br><span class="line">    l=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        p=Thread(target=work)</span><br><span class="line">        l.append(p)</span><br><span class="line">        p.start()</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> l:</span><br><span class="line">        p.join()</span><br><span class="line"></span><br><span class="line">    print(n) <span class="comment">#结果肯定为0，由原来的并发执行变成串行，牺牲了执行效率保证了数据安全</span></span><br></pre></td></tr></table></figure>

<p>互斥锁与join的区别</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#不加锁:并发执行,速度快,数据不安全</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> current_thread,Thread,Lock</span><br><span class="line"><span class="keyword">import</span> os,time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">task</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> n</span><br><span class="line">    print(<span class="string">'%s is running'</span> %current_thread().getName())</span><br><span class="line">    temp=n</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    n=temp<span class="number">-1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    n=<span class="number">100</span></span><br><span class="line">    lock=Lock()</span><br><span class="line">    threads=[]</span><br><span class="line">    start_time=time.time()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        t=Thread(target=task)</span><br><span class="line">        threads.append(t)</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line">    stop_time=time.time()</span><br><span class="line">    print(<span class="string">'主:%s n:%s'</span> %(stop_time-start_time,n))</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Thread-1 is running</span></span><br><span class="line"><span class="string">Thread-2 is running</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">Thread-100 is running</span></span><br><span class="line"><span class="string">主:0.5216062068939209 n:99</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#不加锁:未加锁部分并发执行,加锁部分串行执行,速度慢,数据安全</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> current_thread,Thread,Lock</span><br><span class="line"><span class="keyword">import</span> os,time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">task</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#未加锁的代码并发运行</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">'%s start to run'</span> %current_thread().getName())</span><br><span class="line">    <span class="keyword">global</span> n</span><br><span class="line">    <span class="comment">#加锁的代码串行运行</span></span><br><span class="line">    lock.acquire()</span><br><span class="line">    temp=n</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    n=temp<span class="number">-1</span></span><br><span class="line">    lock.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    n=<span class="number">100</span></span><br><span class="line">    lock=Lock()</span><br><span class="line">    threads=[]</span><br><span class="line">    start_time=time.time()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        t=Thread(target=task)</span><br><span class="line">        threads.append(t)</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line">    stop_time=time.time()</span><br><span class="line">    print(<span class="string">'主:%s n:%s'</span> %(stop_time-start_time,n))</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Thread-1 is running</span></span><br><span class="line"><span class="string">Thread-2 is running</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">Thread-100 is running</span></span><br><span class="line"><span class="string">主:53.294203758239746 n:0</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#有的同学可能有疑问:既然加锁会让运行变成串行,那么我在start之后立即使用join,就不用加锁了啊,也是串行的效果啊</span></span><br><span class="line"><span class="comment">#没错:在start之后立刻使用jion,肯定会将100个任务的执行变成串行,毫无疑问,最终n的结果也肯定是0,是安全的,但问题是</span></span><br><span class="line"><span class="comment">#start后立即join:任务内的所有代码都是串行执行的,而加锁,只是加锁的部分即修改共享数据的部分是串行的</span></span><br><span class="line"><span class="comment">#单从保证数据安全方面,二者都可以实现,但很明显是加锁的效率更高.</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> current_thread,Thread,Lock</span><br><span class="line"><span class="keyword">import</span> os,time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">task</span><span class="params">()</span>:</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">'%s start to run'</span> %current_thread().getName())</span><br><span class="line">    <span class="keyword">global</span> n</span><br><span class="line">    temp=n</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    n=temp<span class="number">-1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    n=<span class="number">100</span></span><br><span class="line">    lock=Lock()</span><br><span class="line">    start_time=time.time()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        t=Thread(target=task)</span><br><span class="line">        t.start()</span><br><span class="line">        t.join()</span><br><span class="line">    stop_time=time.time()</span><br><span class="line">    print(<span class="string">'主:%s n:%s'</span> %(stop_time-start_time,n))</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Thread-1 start to run</span></span><br><span class="line"><span class="string">Thread-2 start to run</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">Thread-100 start to run</span></span><br><span class="line"><span class="string">主:350.6937336921692 n:0 #耗时是多么的恐怖</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">）</span><br></pre></td></tr></table></figure>

<h5 id="（3）死锁与递归锁"><a href="#（3）死锁与递归锁" class="headerlink" title="（3）死锁与递归锁"></a>（3）死锁与递归锁</h5><p>进程也有死锁与递归锁，在进程那里忘记说了，放到这里一切说了额</p>
<p>所谓死锁： 是指两个或两个以上的进程或线程在执行过程中，因争夺资源而造成的一种互相等待的现象，若无外力作用，它们都将无法推进下去。此时称系统处于死锁状态或系统产生了死锁，这些永远在互相等待的进程称为死锁进程，如下就是死锁</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock <span class="keyword">as</span> Lock</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">mutexA=Lock()</span><br><span class="line">mutexA.acquire()</span><br><span class="line">mutexA.acquire()</span><br><span class="line">print(<span class="number">123</span>)</span><br><span class="line">mutexA.release()</span><br><span class="line">mutexA.release()</span><br></pre></td></tr></table></figure>

<p>解决方法，递归锁，在Python中为了支持在同一线程中多次请求同一资源，python提供了可重入锁RLock。</p>
<p>这个RLock内部维护着一个Lock和一个counter变量，counter记录了acquire的次数，从而使得资源可以被多次require。直到一个线程所有的acquire都被release，其他的线程才能获得资源。上面的例子如果使用RLock代替Lock，则不会发生死锁:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> RLock <span class="keyword">as</span> Lock</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">mutexA=Lock()</span><br><span class="line">mutexA.acquire()</span><br><span class="line">mutexA.acquire()</span><br><span class="line">print(<span class="number">123</span>)</span><br><span class="line">mutexA.release()</span><br><span class="line">mutexA.release()</span><br></pre></td></tr></table></figure>

<p>典型问题：科学家吃面</p>
<p>死锁问题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock,Thread</span><br><span class="line">noodle_lock  = Lock()		<span class="comment"># 互斥锁</span></span><br><span class="line">fork_lock = Lock()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat1</span><span class="params">(name)</span>:</span></span><br><span class="line">    noodle_lock.acquire()</span><br><span class="line">    print(<span class="string">'%s拿到面条啦'</span>%name)</span><br><span class="line">    fork_lock.acquire()</span><br><span class="line">    print(<span class="string">'%s拿到叉子了'</span>%name)</span><br><span class="line">    print(<span class="string">'%s吃面'</span>%name)</span><br><span class="line">    fork_lock.release()</span><br><span class="line">    noodle_lock.release()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat2</span><span class="params">(name)</span>:</span></span><br><span class="line">    fork_lock.acquire()</span><br><span class="line">    print(<span class="string">'%s拿到叉子了'</span>%name)</span><br><span class="line">    time.sleep(<span class="number">1</span>)   <span class="comment"># 产生死锁</span></span><br><span class="line">    noodle_lock.acquire()</span><br><span class="line">    print(<span class="string">'%s拿到面条啦'</span>%name)</span><br><span class="line">    print(<span class="string">'%s吃面'</span>%name)</span><br><span class="line">    noodle_lock.release()</span><br><span class="line">    fork_lock.release()</span><br><span class="line"></span><br><span class="line">Thread(target=eat1,args=(<span class="string">'alex'</span>,)).start()</span><br><span class="line">Thread(target=eat2,args=(<span class="string">'Egon'</span>,)).start()</span><br><span class="line">Thread(target=eat1,args=(<span class="string">'bossjin'</span>,)).start()</span><br><span class="line">Thread(target=eat2,args=(<span class="string">'nezha'</span>,)).start()</span><br></pre></td></tr></table></figure>

<p>递归锁解决死锁问题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread,RLock   <span class="comment"># 递归锁</span></span><br><span class="line">fork_lock = noodle_lock  = RLock()   <span class="comment"># 一个钥匙串上的两把钥匙，拿到一个钥匙即意味着拿到了一串钥匙</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat1</span><span class="params">(name)</span>:</span></span><br><span class="line">    noodle_lock.acquire()            <span class="comment"># 一把钥匙</span></span><br><span class="line">    print(<span class="string">'%s拿到面条啦'</span>%name)</span><br><span class="line">    fork_lock.acquire()</span><br><span class="line">    print(<span class="string">'%s拿到叉子了'</span>%name)</span><br><span class="line">    print(<span class="string">'%s吃面'</span>%name)</span><br><span class="line">    fork_lock.release()</span><br><span class="line">    noodle_lock.release()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat2</span><span class="params">(name)</span>:</span></span><br><span class="line">    fork_lock.acquire()</span><br><span class="line">    print(<span class="string">'%s拿到叉子了'</span>%name)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    noodle_lock.acquire()</span><br><span class="line">    print(<span class="string">'%s拿到面条啦'</span>%name)</span><br><span class="line">    print(<span class="string">'%s吃面'</span>%name)</span><br><span class="line">    noodle_lock.release()</span><br><span class="line">    fork_lock.release()</span><br><span class="line"></span><br><span class="line">Thread(target=eat1,args=(<span class="string">'alex'</span>,)).start()</span><br><span class="line">Thread(target=eat2,args=(<span class="string">'Egon'</span>,)).start()</span><br><span class="line">Thread(target=eat1,args=(<span class="string">'bossjin'</span>,)).start()</span><br><span class="line">Thread(target=eat2,args=(<span class="string">'nezha'</span>,)).start()</span><br></pre></td></tr></table></figure>

<h4 id="3、信号量"><a href="#3、信号量" class="headerlink" title="3、信号量"></a>3、信号量</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Semaphore,Thread</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(sem,a,b)</span>:</span></span><br><span class="line">    sem.acquire()</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(a+b)</span><br><span class="line">    sem.release()</span><br><span class="line"></span><br><span class="line">sem = Semaphore(<span class="number">4</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    t = Thread(target=func,args=(sem,i,i+<span class="number">5</span>))</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure>

<h4 id="4、事件"><a href="#4、事件" class="headerlink" title="4、事件"></a>4、事件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread,Event</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect_db</span><span class="params">(e)</span>:</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> count &lt; <span class="number">3</span>:</span><br><span class="line">        e.wait(<span class="number">0.5</span>)   <span class="comment"># 状态为False的时候,我只等待1s就结束</span></span><br><span class="line">        <span class="keyword">if</span> e.is_set() == <span class="literal">True</span>:</span><br><span class="line">            print(<span class="string">'连接数据库'</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            print(<span class="string">'第%s次连接失败'</span>%count)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> TimeoutError(<span class="string">'数据库连接超时'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_web</span><span class="params">(e)</span>:</span></span><br><span class="line">    time.sleep(random.randint(<span class="number">0</span>,<span class="number">3</span>))</span><br><span class="line">    e.set()</span><br><span class="line"></span><br><span class="line">e = Event()</span><br><span class="line">t1 = Thread(target=connect_db,args=(e,))</span><br><span class="line">t2 = Thread(target=check_web,args=(e,))</span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br></pre></td></tr></table></figure>

<h4 id="5、条件"><a href="#5、条件" class="headerlink" title="5、条件"></a>5、条件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread,Condition</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(con,i)</span>:</span></span><br><span class="line">    con.acquire()</span><br><span class="line">    con.wait() <span class="comment"># 等钥匙</span></span><br><span class="line">    print(<span class="string">'在第%s个循环里'</span>%i)</span><br><span class="line">    con.release()</span><br><span class="line">con = Condition()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    Thread(target=func,args = (con,i)).start()</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    num = int(input(<span class="string">'&gt;&gt;&gt;'</span>))</span><br><span class="line">    con.acquire()</span><br><span class="line">    con.notify(num)  <span class="comment"># 造钥匙</span></span><br><span class="line">    con.release()</span><br></pre></td></tr></table></figure>

<h4 id="6、定时器"><a href="#6、定时器" class="headerlink" title="6、定时器"></a>6、定时器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Timer</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'时间同步'</span>)   <span class="comment">#1-3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    t = Timer(<span class="number">5</span>,func).start()   <span class="comment"># 非阻塞的</span></span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<h4 id="7、线程队列"><a href="#7、线程队列" class="headerlink" title="7、线程队列"></a>7、线程队列</h4><p>queue队列 ：使用import queue，用法与进程Queue一样</p>
<p>queue is especially useful in threaded programming when information must be exchanged safely between multiple threads.</p>
<ul>
<li><p><strong>class queue.Queue(maxsize=0) #先进先出</strong></p>
<p>先进先出:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"></span><br><span class="line">q=queue.Queue()</span><br><span class="line">q.put(<span class="string">'first'</span>)</span><br><span class="line">q.put(<span class="string">'second'</span>)</span><br><span class="line">q.put(<span class="string">'third'</span>)</span><br><span class="line"></span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">结果(先进先出):</span></span><br><span class="line"><span class="string">first</span></span><br><span class="line"><span class="string">second</span></span><br><span class="line"><span class="string">third</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>class queue.LifoQueue(maxsize=0) #last in fisrt out</strong></p>
<p>后进先出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"></span><br><span class="line">q=queue.LifoQueue()</span><br><span class="line">q.put(<span class="string">'first'</span>)</span><br><span class="line">q.put(<span class="string">'second'</span>)</span><br><span class="line">q.put(<span class="string">'third'</span>)</span><br><span class="line"></span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">结果(后进先出):</span></span><br><span class="line"><span class="string">third</span></span><br><span class="line"><span class="string">second</span></span><br><span class="line"><span class="string">first</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>class queue.PriorityQueue(maxsize=0) #存储数据时可设置优先级的队列</strong></p>
<p>优先级队列</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"></span><br><span class="line">q=queue.PriorityQueue()</span><br><span class="line"><span class="comment">#put进入一个元组,元组的第一个元素是优先级(通常是数字,也可以是非数字之间的比较),数字越小优先级越高。第一个元素一致时，按第二个排</span></span><br><span class="line">q.put((<span class="number">20</span>,<span class="string">'a'</span>))</span><br><span class="line">q.put((<span class="number">10</span>,<span class="string">'b'</span>))</span><br><span class="line">q.put((<span class="number">30</span>,<span class="string">'c'</span>))</span><br><span class="line"></span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br><span class="line">print(q.get())</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">结果(数字越小优先级越高,优先级高的优先出队):</span></span><br><span class="line"><span class="string">(10, 'b')</span></span><br><span class="line"><span class="string">(20, 'a')</span></span><br><span class="line"><span class="string">(30, 'c')</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>更多方法说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Constructor for a priority queue. maxsize is an integer that sets the upperbound limit on the number of items that can be placed in the queue. Insertion will block once this size has been reached, until queue items are consumed. If maxsize is less than or equal to zero, the queue size is infinite.</span><br><span class="line"></span><br><span class="line">The lowest valued entries are retrieved first (the lowest valued entry is the one returned by sorted(list(entries))[0]). A typical pattern for entries is a tuple in the form: (priority_number, data).</span><br><span class="line"></span><br><span class="line">exception queue.Empty</span><br><span class="line">Exception raised when non-blocking get() (or get_nowait()) is called on a Queue object which is empty.</span><br><span class="line"></span><br><span class="line">exception queue.Full</span><br><span class="line">Exception raised when non-blocking put() (or put_nowait()) is called on a Queue object which is full.</span><br><span class="line"></span><br><span class="line">Queue.qsize()</span><br><span class="line">Queue.empty() #return True if empty  </span><br><span class="line">Queue.full() # return True if full </span><br><span class="line">Queue.put(item, block=True, timeout=None)</span><br><span class="line">Put item into the queue. If optional args block is true and timeout is None (the default), block if necessary until a free slot is available. If timeout is a positive number, it blocks at most timeout seconds and raises the Full exception if no free slot was available within that time. Otherwise (block is false), put an item on the queue if a free slot is immediately available, else raise the Full exception (timeout is ignored in that case).</span><br><span class="line"></span><br><span class="line">Queue.put_nowait(item)</span><br><span class="line">Equivalent to put(item, False).</span><br><span class="line"></span><br><span class="line">Queue.get(block=True, timeout=None)</span><br><span class="line">Remove and return an item from the queue. If optional args block is true and timeout is None (the default), block if necessary until an item is available. If timeout is a positive number, it blocks at most timeout seconds and raises the Empty exception if no item was available within that time. Otherwise (block is false), return an item if one is immediately available, else raise the Empty exception (timeout is ignored in that case).</span><br><span class="line"></span><br><span class="line">Queue.get_nowait()</span><br><span class="line">Equivalent to get(False).</span><br><span class="line"></span><br><span class="line">Two methods are offered to support tracking whether enqueued tasks have been fully processed by daemon consumer threads.</span><br><span class="line"></span><br><span class="line">Queue.task_done()</span><br><span class="line">Indicate that a formerly enqueued task is complete. Used by queue consumer threads. For each get() used to fetch a task, a subsequent call to task_done() tells the queue that the processing on the task is complete.</span><br><span class="line"></span><br><span class="line">If a join() is currently blocking, it will resume when all items have been processed (meaning that a task_done() call was received for every item that had been put() into the queue).</span><br><span class="line"></span><br><span class="line">Raises a ValueError if called more times than there were items placed in the queue.</span><br><span class="line"></span><br><span class="line">Queue.join() block直到queue被消费完毕</span><br></pre></td></tr></table></figure>

<h4 id="8、Python标准模块——concurrent-futures"><a href="#8、Python标准模块——concurrent-futures" class="headerlink" title="8、Python标准模块——concurrent.futures"></a>8、Python标准模块——concurrent.futures</h4><p><strong><a href="https://docs.python.org/dev/library/concurrent.futures.html" target="_blank" rel="noopener">https://docs.python.org/dev/library/concurrent.futures.html</a></strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1 介绍</span></span><br><span class="line">concurrent.futures模块提供了高度封装的异步调用接口</span><br><span class="line">ThreadPoolExecutor：线程池，提供异步调用</span><br><span class="line">ProcessPoolExecutor: 进程池，提供异步调用</span><br><span class="line">Both implement the same interface, which <span class="keyword">is</span> defined by the abstract Executor <span class="class"><span class="keyword">class</span>.</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">#2 基本方法</span></span><br><span class="line"><span class="class">#<span class="title">submit</span><span class="params">(fn, *args, **kwargs)</span></span></span><br><span class="line"><span class="class">异步提交任务</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">#<span class="title">map</span><span class="params">(func, *iterables, timeout=None, chunksize=<span class="number">1</span>)</span> </span></span><br><span class="line"><span class="class">取代<span class="title">for</span>循环<span class="title">submit</span>的操作</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">#<span class="title">shutdown</span><span class="params">(wait=True)</span> </span></span><br><span class="line"><span class="class">相当于进程池的<span class="title">pool</span>.<span class="title">close</span><span class="params">()</span>+<span class="title">pool</span>.<span class="title">join</span><span class="params">()</span>操作</span></span><br><span class="line">wait=True，等待池内所有任务执行完毕回收完资源后才继续</span><br><span class="line">wait=<span class="literal">False</span>，立即返回，并不会等待池内的任务执行完毕</span><br><span class="line">但不管wait参数为何值，整个程序都会等到所有任务执行完毕</span><br><span class="line">submit和map必须在shutdown之前</span><br><span class="line"></span><br><span class="line"><span class="comment">#result(timeout=None)</span></span><br><span class="line">取得结果</span><br><span class="line"></span><br><span class="line"><span class="comment">#add_done_callback(fn)</span></span><br><span class="line">回调函数</span><br><span class="line"></span><br><span class="line"><span class="comment"># done()</span></span><br><span class="line">判断某一个线程是否完成</span><br><span class="line"></span><br><span class="line"><span class="comment"># cancle()</span></span><br><span class="line">取消某个任务</span><br></pre></td></tr></table></figure>

<p>ProcessPoolExecutor</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#介绍</span></span><br><span class="line">The ProcessPoolExecutor class is an Executor subclass that uses a pool of processes to execute calls asynchronously. ProcessPoolExecutor uses the multiprocessing module, which allows it to side-step the Global Interpreter Lock but also means that only picklable objects can be executed and returned.</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">concurrent</span>.<span class="title">futures</span>.<span class="title">ProcessPoolExecutor</span><span class="params">(max_workers=None, mp_context=None)</span></span></span><br><span class="line">An Executor subclass that executes calls asynchronously using a pool of at most max_workers processes. If max_workers is None or not given, it will default to the number of processors on the machine. If max_workers is lower or equal to 0, then a ValueError will be raised.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#用法</span></span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor,ProcessPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os,time,random</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">task</span><span class="params">(n)</span>:</span></span><br><span class="line">    print(<span class="string">'%s is runing'</span> %os.getpid())</span><br><span class="line">    time.sleep(random.randint(<span class="number">1</span>,<span class="number">3</span>))</span><br><span class="line">    <span class="keyword">return</span> n**<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    executor=ProcessPoolExecutor(max_workers=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    futures=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">11</span>):</span><br><span class="line">        future=executor.submit(task,i)</span><br><span class="line">        futures.append(future)</span><br><span class="line">    executor.shutdown(<span class="literal">True</span>)</span><br><span class="line">    print(<span class="string">'+++&gt;'</span>)</span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> futures:</span><br><span class="line">        print(future.result())</span><br></pre></td></tr></table></figure>

<p>ThreadPoolExecutor</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#介绍</span></span><br><span class="line">ThreadPoolExecutor <span class="keyword">is</span> an Executor subclass that uses a pool of threads to execute calls asynchronously.</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">concurrent</span>.<span class="title">futures</span>.<span class="title">ThreadPoolExecutor</span><span class="params">(max_workers=None, thread_name_prefix=<span class="string">''</span>)</span></span></span><br><span class="line"><span class="class"><span class="title">An</span> <span class="title">Executor</span> <span class="title">subclass</span> <span class="title">that</span> <span class="title">uses</span> <span class="title">a</span> <span class="title">pool</span> <span class="title">of</span> <span class="title">at</span> <span class="title">most</span> <span class="title">max_workers</span> <span class="title">threads</span> <span class="title">to</span> <span class="title">execute</span> <span class="title">calls</span> <span class="title">asynchronously</span>.</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">Changed</span> <span class="title">in</span> <span class="title">version</span> 3.5:</span> If max_workers <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="keyword">not</span> given, it will default to the number of processors on the machine, multiplied by <span class="number">5</span>, assuming that ThreadPoolExecutor <span class="keyword">is</span> often used to overlap I/O instead of CPU work <span class="keyword">and</span> the number of workers should be higher than the number of workers <span class="keyword">for</span> ProcessPoolExecutor.</span><br><span class="line"></span><br><span class="line">New <span class="keyword">in</span> version <span class="number">3.6</span>: The thread_name_prefix argument was added to allow users to control the threading.Thread names <span class="keyword">for</span> worker threads created by the pool <span class="keyword">for</span> easier debugging.</span><br><span class="line"></span><br><span class="line"><span class="comment">#用法</span></span><br><span class="line">与ProcessPoolExecutor相同</span><br></pre></td></tr></table></figure>

<p>map的用法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor,ProcessPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os,time,random</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">task</span><span class="params">(n)</span>:</span></span><br><span class="line">    print(<span class="string">'%s is runing'</span> %os.getpid())</span><br><span class="line">    time.sleep(random.randint(<span class="number">1</span>,<span class="number">3</span>))</span><br><span class="line">    <span class="keyword">return</span> n**<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    executor=ThreadPoolExecutor(max_workers=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># for i in range(11):</span></span><br><span class="line">    <span class="comment">#     future=executor.submit(task,i)</span></span><br><span class="line"></span><br><span class="line">    executor.map(task,range(<span class="number">1</span>,<span class="number">12</span>)) <span class="comment">#map取代了for+submit</span></span><br></pre></td></tr></table></figure>

<p>回调函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor,ProcessPoolExecutor</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_page</span><span class="params">(url)</span>:</span></span><br><span class="line">    print(<span class="string">'&lt;进程%s&gt; get %s'</span> %(os.getpid(),url))</span><br><span class="line">    respone=requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> respone.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">'url'</span>:url,<span class="string">'text'</span>:respone.text&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_page</span><span class="params">(res)</span>:</span></span><br><span class="line">    res=res.result()</span><br><span class="line">    print(<span class="string">'&lt;进程%s&gt; parse %s'</span> %(os.getpid(),res[<span class="string">'url'</span>]))</span><br><span class="line">    parse_res=<span class="string">'url:&lt;%s&gt; size:[%s]\n'</span> %(res[<span class="string">'url'</span>],len(res[<span class="string">'text'</span>]))</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'db.txt'</span>,<span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(parse_res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    urls=[</span><br><span class="line">        <span class="string">'https://www.baidu.com'</span>,</span><br><span class="line">        <span class="string">'https://www.python.org'</span>,</span><br><span class="line">        <span class="string">'https://www.openstack.org'</span>,</span><br><span class="line">        <span class="string">'https://help.github.com/'</span>,</span><br><span class="line">        <span class="string">'http://www.sina.com.cn/'</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># p=Pool(3)</span></span><br><span class="line">    <span class="comment"># for url in urls:</span></span><br><span class="line">    <span class="comment">#     p.apply_async(get_page,args=(url,),callback=pasrse_page)</span></span><br><span class="line">    <span class="comment"># p.close()</span></span><br><span class="line">    <span class="comment"># p.join()</span></span><br><span class="line"></span><br><span class="line">    p=ProcessPoolExecutor(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">        p.submit(get_page,url).add_done_callback(parse_page) <span class="comment">#parse_page拿到的是一个future对象obj，需要用obj.result()拿到结果</span></span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="John Doe">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">85</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://suliangxu.github.io" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:1193135584@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  



  
  









  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three-waves.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
